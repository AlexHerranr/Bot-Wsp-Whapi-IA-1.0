2025-07-23T07:47:40.838894632Z [INFO] [WHAPI_LABELS] Info del chat obtenida. Etiquetas: 2 jsonPayload={"category":"WHAPI_LABELS","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"SUCCESS","timestamp":"2025-07-23T07:47:40.829Z"} labels={"app":"whatsapp-bot","category":"WHAPI_LABELS","flow_stage":"0_unknown","level":"SUCCESS"} timestamp="2025-07-23T07:47:40.829Z"
2025-07-23T07:47:40.838924874Z [INFO] [GUEST_MEMORY] Sincronizado con Whapi: 2 etiquetas para 573003913251 jsonPayload={"category":"GUEST_MEMORY","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","timestamp":"2025-07-23T07:47:40.829Z"} labels={"app":"whatsapp-bot","category":"GUEST_MEMORY","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T07:47:40.829Z"
2025-07-23T07:47:40.838961441Z [INFO] [SYNC_NEEDED] Sync needed for 573003913251 jsonPayload={"category":"SYNC_NEEDED","environment":"cloud-run","flow":{"stage":"0_unknown"},"force":false,"isNewThread":true,"isThreadOld":false,"level":"INFO","reason":"new_thread","requestId":null,"timestamp":"2025-07-23T07:47:40.830Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"SYNC_NEEDED","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T07:47:40.830Z"
2025-07-23T07:47:40.838990816Z [INFO] [GUEST_MEMORY] Nuevo perfil creado para 573003913251 con 2 etiquetas jsonPayload={"category":"GUEST_MEMORY","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","timestamp":"2025-07-23T07:47:40.830Z"} labels={"app":"whatsapp-bot","category":"GUEST_MEMORY","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T07:47:40.830Z"
2025-07-23T07:47:40.839013879Z [INFO] [WHAPI_LABELS] Obteniendo info del chat para 573003913251 jsonPayload={"category":"WHAPI_LABELS","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","timestamp":"2025-07-23T07:47:40.830Z"} labels={"app":"whatsapp-bot","category":"WHAPI_LABELS","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T07:47:40.830Z"
2025-07-23T07:47:41.141773016Z [INFO] [WHAPI_LABELS] Info del chat obtenida. Etiquetas: 2 jsonPayload={"category":"WHAPI_LABELS","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"SUCCESS","timestamp":"2025-07-23T07:47:41.132Z"} labels={"app":"whatsapp-bot","category":"WHAPI_LABELS","flow_stage":"0_unknown","level":"SUCCESS"} timestamp="2025-07-23T07:47:41.132Z"
2025-07-23T07:47:41.183790681Z [INFO] [CONTEXT_INJECTION] Contexto temporal generado jsonPayload={"category":"CONTEXT_INJECTION","clientName":"Sr Alex","contactName":"Sr Alex","contextLength":150,"environment":"cloud-run","flow":{"stage":"0_unknown"},"hasChatInfo":true,"hasProfile":true,"isFirstMessageAfterRestart":true,"labelsCount":2,"level":"INFO","timestamp":"2025-07-23T07:47:41.181Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"CONTEXT_INJECTION","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T07:47:41.181Z"
2025-07-23T07:47:41.183821956Z [INFO] [CONTEXT_DEBUG] Contexto enviado a OpenAI jsonPayload={"category":"CONTEXT_DEBUG","contextPreview":"Fecha: 23/07/2025 | Hora: 2:47 AM (Colombia)\nCliente: Sr Alex | Contacto WhatsApp: Sr Alex | Status: Colega Jefe, cotización\n---\nMensaje del cliente:\n","environment":"cloud-run","flow":{"stage":"0_unknown"},"isVoiceMessage":false,"level":"INFO","messagePreview":"hola como va todo","shortUserId":"573003913251","timestamp":"2025-07-23T07:47:41.182Z","totalLength":167} labels={"app":"whatsapp-bot","category":"CONTEXT_DEBUG","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T07:47:41.182Z"
2025-07-23T07:47:41.539272689Z [INFO] [OPENAI_REQUEST] message_added_with_context jsonPayload={"category":"OPENAI_REQUEST","contextLength":150,"environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","originalLength":17,"shortUserId":"573003913251","timestamp":"2025-07-23T07:47:41.513Z","totalLength":167} labels={"app":"whatsapp-bot","category":"OPENAI_REQUEST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T07:47:41.512Z"
2025-07-23T07:47:41.539295210Z [INFO] [OPENAI_REQUEST] creating_run jsonPayload={"category":"OPENAI_REQUEST","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","timestamp":"2025-07-23T07:47:41.513Z"} labels={"app":"whatsapp-bot","category":"OPENAI_REQUEST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T07:47:41.513Z"
2025-07-23T07:47:42.754192120Z [INFO] [OPENAI_REQUEST] run_started jsonPayload={"category":"OPENAI_REQUEST","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","timestamp":"2025-07-23T07:47:42.752Z"} labels={"app":"whatsapp-bot","category":"OPENAI_REQUEST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T07:47:42.752Z"
2025-07-23T07:47:45.285163710Z [INFO] [OPENAI_RUN_COMPLETED] Run completado para 573003913251 jsonPayload={"category":"OPENAI_RUN_COMPLETED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"SUCCESS","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T07:47:45.280Z"} labels={"app":"whatsapp-bot","category":"OPENAI_RUN_COMPLETED","flow_stage":"0_unknown","level":"SUCCESS"} timestamp="2025-07-23T07:47:45.280Z"
2025-07-23T07:47:45.285193333Z [INFO] [TOKEN_USAGE] Tokens utilizados jsonPayload={"category":"TOKEN_USAGE","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T07:47:45.281Z","totalTokens":1546} labels={"app":"whatsapp-bot","category":"TOKEN_USAGE","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T07:47:45.281Z"
2025-07-23T07:47:45.285229695Z [INFO] [OPENAI_USAGE] Run completado con métricas jsonPayload={"category":"OPENAI_USAGE","completionTokens":22,"contextTokens":0,"durationMs":5760,"environment":"cloud-run","flow":{"stage":"6_ai_request"},"level":"INFO","promptTokens":1524,"runId":"run_3PKYVWel9m44cjdCNSzQ7dWi","shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T07:47:45.281Z","tokensPerSecond":268,"totalTokens":1546} labels={"app":"whatsapp-bot","category":"OPENAI_USAGE","flow_stage":"6_ai_request","level":"INFO"} timestamp="2025-07-23T07:47:45.281Z"
2025-07-23T07:47:45.285263209Z [INFO] [OPENAI_LATENCY] Latencia del procesamiento jsonPayload={"category":"OPENAI_LATENCY","durationSeconds":"5.76","environment":"cloud-run","flow":{"stage":"6_ai_request"},"isHighLatency":false,"level":"INFO","shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T07:47:45.281Z","totalDurationMs":5760} labels={"app":"whatsapp-bot","category":"OPENAI_LATENCY","flow_stage":"6_ai_request","level":"INFO"} timestamp="2025-07-23T07:47:45.281Z"
2025-07-23T07:47:45.407844420Z [INFO] [OPENAI_RESPONSE] response_received jsonPayload={"category":"OPENAI_RESPONSE","environment":"cloud-run","flow":{"stage":"7_ai_response"},"level":"INFO","responseLength":66,"shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T07:47:45.400Z"} labels={"app":"whatsapp-bot","category":"OPENAI_RESPONSE","flow_stage":"7_ai_response","level":"INFO"} timestamp="2025-07-23T07:47:45.400Z"
2025-07-23T07:47:45.407888385Z [INFO] [PERFORMANCE_METRICS] Procesamiento completado exitosamente jsonPayload={"category":"PERFORMANCE_METRICS","contextTokens":0,"environment":"cloud-run","flow":{"stage":"9_complete"},"isEfficient":true,"level":"INFO","memory":{"heapTotalMB":29,"heapUsedMB":27,"rssMB":85},"responseLength":66,"shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T07:47:45.401Z","tokensPerSecond":263,"totalDurationMs":5880,"totalTokens":1546} labels={"app":"whatsapp-bot","category":"PERFORMANCE_METRICS","flow_stage":"9_complete","level":"INFO"} timestamp="2025-07-23T07:47:45.401Z"
2025-07-23T07:47:45.407929261Z [INFO] [WHATSAPP_SEND] Enviando mensaje a 573003913251 jsonPayload={"category":"WHATSAPP_SEND","chatId":"573003913251@s.whatsapp.net","environment":"cloud-run","flow":{"stage":"8_send"},"level":"INFO","messageLength":66,"preview":"Hola, Sr. Alex! Todo bien, gracias. ¿En qué puedo ayudarle hoy? 😊...","timestamp":"2025-07-23T07:47:45.402Z"} labels={"app":"whatsapp-bot","category":"WHATSAPP_SEND","flow_stage":"8_send","level":"INFO"} timestamp="2025-07-23T07:47:45.402Z"
2025-07-23T07:47:46.124Z ✅ [573003913251] Mensaje enviado
2025-07-23T07:47:46.127273750Z [INFO] [QUEUE_ITEM_SUCCESS] Mensaje procesado exitosamente jsonPayload={"category":"QUEUE_ITEM_SUCCESS","environment":"cloud-run","flow":{"sequence":3,"stage":"0_unknown"},"level":"SUCCESS","messageId":"msg_1753256859517_r0m26lums","processedCount":1,"remainingInQueue":0,"timestamp":"2025-07-23T07:47:46.124Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_ITEM_SUCCESS","flow_stage":"0_unknown","level":"SUCCESS","message_id":"msg_1753256859517_r0m26lums","user_id":"573003913251"} timestamp="2025-07-23T07:47:46.124Z"
2025-07-23T07:47:46.127302738Z [INFO] [LOCK_ALREADY_RELEASED] Lock ya liberado para usuario jsonPayload={"activeLocks":0,"category":"LOCK_ALREADY_RELEASED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"TRACE","timestamp":"2025-07-23T07:47:46.124Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"LOCK_ALREADY_RELEASED","flow_stage":"0_unknown","level":"TRACE","user_id":"573003913251"} timestamp="2025-07-23T07:47:46.124Z"
2025-07-23T07:47:46.127337236Z [INFO] [QUEUE_PROCESSING_COMPLETE] Cola de usuario procesada completamente jsonPayload={"averageTimePerMessage":"6606ms","category":"QUEUE_PROCESSING_COMPLETE","environment":"cloud-run","errorCount":0,"flow":{"stage":"0_unknown"},"initialQueueLength":1,"level":"SUCCESS","processedCount":1,"processingDuration":"6606ms","remainingQueues":0,"timestamp":"2025-07-23T07:47:46.124Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_PROCESSING_COMPLETE","flow_stage":"0_unknown","level":"SUCCESS","user_id":"573003913251"} timestamp="2025-07-23T07:47:46.124Z"
📨 Webhook: 1 mensajes recibidos
2025-07-23T07:47:46.832343315Z [INFO] [WEBHOOK] Procesando 1 mensajes del webhook jsonPayload={"category":"WEBHOOK","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","messageCount":1,"timestamp":"2025-07-23T07:47:46.830Z"} labels={"app":"whatsapp-bot","category":"WEBHOOK","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T07:47:46.830Z"
2025-07-23T07:52:06.994512877Z [INFO] [THREAD_PERSIST] 1 threads guardados jsonPayload={"category":"THREAD_PERSIST","environment":"cloud-run","file":"tmp/threads.json","flow":{"stage":"0_unknown"},"level":"INFO","source":"save_operation","threadsCount":1,"timestamp":"2025-07-23T07:52:04.383Z"} labels={"app":"whatsapp-bot","category":"THREAD_PERSIST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T07:52:04.383Z"
2025-07-23T07:52:06.994547675Z [INFO] [THREAD_PERSIST] Auto-guardado ejecutado (había cambios pendientes) jsonPayload={"category":"THREAD_PERSIST","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","timestamp":"2025-07-23T07:52:04.384Z"} labels={"app":"whatsapp-bot","category":"THREAD_PERSIST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T07:52:04.384Z"
2025-07-23T10:47:14.243647520Z [INFO] [MEMORY_USAGE] Métricas de memoria del sistema jsonPayload={"caches":{"centralizedCache":"Caches centralizados en historyInjection.ts","globalBuffers":0},"category":"MEMORY_USAGE","cpu":{"system":"245ms","user":"1212ms"},"environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","logReason":"memory_leak","memory":{"external":"3MB","heapTotal":"29MB","heapUsagePercent":"95%","heapUsed":"27MB","rss":"85MB"},"threads":{"active":1,"total":1},"timestamp":"2025-07-23T10:47:04.826Z","uptime":"10801s"} labels={"app":"whatsapp-bot","category":"MEMORY_USAGE","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T10:47:04.826Z"
2025-07-23T10:47:14.243695628Z [INFO] [MEMORY_LEAK_DETECTED] Posible memory leak crítico detectado jsonPayload={"category":"MEMORY_LEAK_DETECTED","environment":"cloud-run","flow":{"stage":"0_unknown"},"heapUsagePercent":"95%","heapUsedMB":27,"level":"FATAL","recommendation":"Uso de memoria crítico - considerar optimización o restart inmediato","threshold":95,"timestamp":"2025-07-23T10:47:04.826Z"} labels={"app":"whatsapp-bot","category":"MEMORY_LEAK_DETECTED","flow_stage":"0_unknown","level":"FATAL"} timestamp="2025-07-23T10:47:04.826Z"
2025-07-23T10:52:14.494794708Z [INFO] [MEMORY_USAGE] Métricas de memoria del sistema jsonPayload={"caches":{"centralizedCache":"Caches centralizados en historyInjection.ts","globalBuffers":0},"category":"MEMORY_USAGE","cpu":{"system":"245ms","user":"1214ms"},"environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","logReason":"memory_leak","memory":{"external":"3MB","heapTotal":"29MB","heapUsagePercent":"95%","heapUsed":"27MB","rss":"85MB"},"threads":{"active":1,"total":1},"timestamp":"2025-07-23T10:52:04.846Z","uptime":"11101s"} labels={"app":"whatsapp-bot","category":"MEMORY_USAGE","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T10:52:04.846Z"
2025-07-23T10:52:14.494840390Z [INFO] [MEMORY_LEAK_DETECTED] Posible memory leak crítico detectado jsonPayload={"category":"MEMORY_LEAK_DETECTED","environment":"cloud-run","flow":{"stage":"0_unknown"},"heapUsagePercent":"95%","heapUsedMB":27,"level":"FATAL","recommendation":"Uso de memoria crítico - considerar optimización o restart inmediato","threshold":95,"timestamp":"2025-07-23T10:52:04.846Z"} labels={"app":"whatsapp-bot","category":"MEMORY_LEAK_DETECTED","flow_stage":"0_unknown","level":"FATAL"} timestamp="2025-07-23T10:52:04.846Z"
2025-07-23T10:57:14.700340233Z [INFO] [MEMORY_USAGE] Métricas de memoria del sistema jsonPayload={"caches":{"centralizedCache":"Caches centralizados en historyInjection.ts","globalBuffers":0},"category":"MEMORY_USAGE","cpu":{"system":"247ms","user":"1215ms"},"environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","logReason":"memory_leak","memory":{"external":"3MB","heapTotal":"29MB","heapUsagePercent":"95%","heapUsed":"27MB","rss":"85MB"},"threads":{"active":1,"total":1},"timestamp":"2025-07-23T10:57:04.846Z","uptime":"11401s"} labels={"app":"whatsapp-bot","category":"MEMORY_USAGE","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T10:57:04.846Z"
2025-07-23T10:57:14.700389119Z [INFO] [MEMORY_LEAK_DETECTED] Posible memory leak crítico detectado jsonPayload={"category":"MEMORY_LEAK_DETECTED","environment":"cloud-run","flow":{"stage":"0_unknown"},"heapUsagePercent":"95%","heapUsedMB":27,"level":"FATAL","recommendation":"Uso de memoria crítico - considerar optimización o restart inmediato","threshold":95,"timestamp":"2025-07-23T10:57:04.846Z"} labels={"app":"whatsapp-bot","category":"MEMORY_LEAK_DETECTED","flow_stage":"0_unknown","level":"FATAL"} timestamp="2025-07-23T10:57:04.846Z"
2025-07-23T11:02:04.930080508Z [INFO] [MEMORY_USAGE] Métricas de memoria del sistema jsonPayload={"caches":{"centralizedCache":"Caches centralizados en historyInjection.ts","globalBuffers":0},"category":"MEMORY_USAGE","cpu":{"system":"249ms","user":"1215ms"},"environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","logReason":"memory_leak","memory":{"external":"3MB","heapTotal":"29MB","heapUsagePercent":"95%","heapUsed":"28MB","rss":"85MB"},"threads":{"active":1,"total":1},"timestamp":"2025-07-23T11:02:04.866Z","uptime":"11701s"} labels={"app":"whatsapp-bot","category":"MEMORY_USAGE","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T11:02:04.866Z"
2025-07-23T11:02:04.930124845Z [INFO] [MEMORY_LEAK_DETECTED] Posible memory leak crítico detectado jsonPayload={"category":"MEMORY_LEAK_DETECTED","environment":"cloud-run","flow":{"stage":"0_unknown"},"heapUsagePercent":"95%","heapUsedMB":28,"level":"FATAL","recommendation":"Uso de memoria crítico - considerar optimización o restart inmediato","threshold":95,"timestamp":"2025-07-23T11:02:04.866Z"} labels={"app":"whatsapp-bot","category":"MEMORY_LEAK_DETECTED","flow_stage":"0_unknown","level":"FATAL"} timestamp="2025-07-23T11:02:04.866Z"
2025-07-23T11:07:05.083833788Z [INFO] [MEMORY_USAGE] Métricas de memoria del sistema jsonPayload={"caches":{"centralizedCache":"Caches centralizados en historyInjection.ts","globalBuffers":0},"category":"MEMORY_USAGE","cpu":{"system":"249ms","user":"1216ms"},"environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","logReason":"memory_leak","memory":{"external":"3MB","heapTotal":"29MB","heapUsagePercent":"95%","heapUsed":"28MB","rss":"85MB"},"threads":{"active":1,"total":1},"timestamp":"2025-07-23T11:07:04.866Z","uptime":"12001s"} labels={"app":"whatsapp-bot","category":"MEMORY_USAGE","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T11:07:04.866Z"
2025-07-23T11:07:05.083868105Z [INFO] [MEMORY_LEAK_DETECTED] Posible memory leak crítico detectado jsonPayload={"category":"MEMORY_LEAK_DETECTED","environment":"cloud-run","flow":{"stage":"0_unknown"},"heapUsagePercent":"95%","heapUsedMB":28,"level":"FATAL","recommendation":"Uso de memoria crítico - considerar optimización o restart inmediato","threshold":95,"timestamp":"2025-07-23T11:07:04.866Z"} labels={"app":"whatsapp-bot","category":"MEMORY_LEAK_DETECTED","flow_stage":"0_unknown","level":"FATAL"} timestamp="2025-07-23T11:07:04.866Z"
2025-07-23T11:12:05.246011646Z [INFO] [MEMORY_USAGE] Métricas de memoria del sistema jsonPayload={"caches":{"centralizedCache":"Caches centralizados en historyInjection.ts","globalBuffers":0},"category":"MEMORY_USAGE","cpu":{"system":"250ms","user":"1218ms"},"environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","logReason":"memory_leak","memory":{"external":"3MB","heapTotal":"29MB","heapUsagePercent":"95%","heapUsed":"28MB","rss":"85MB"},"threads":{"active":1,"total":1},"timestamp":"2025-07-23T11:12:04.885Z","uptime":"12301s"} labels={"app":"whatsapp-bot","category":"MEMORY_USAGE","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T11:12:04.885Z"
2025-07-23T11:12:05.246040972Z [INFO] [MEMORY_LEAK_DETECTED] Posible memory leak crítico detectado jsonPayload={"category":"MEMORY_LEAK_DETECTED","environment":"cloud-run","flow":{"stage":"0_unknown"},"heapUsagePercent":"95%","heapUsedMB":28,"level":"FATAL","recommendation":"Uso de memoria crítico - considerar optimización o restart inmediato","threshold":95,"timestamp":"2025-07-23T11:12:04.886Z"} labels={"app":"whatsapp-bot","category":"MEMORY_LEAK_DETECTED","flow_stage":"0_unknown","level":"FATAL"} timestamp="2025-07-23T11:12:04.886Z"
2025-07-23T11:17:05.353598594Z [INFO] [MEMORY_USAGE] Métricas de memoria del sistema jsonPayload={"caches":{"centralizedCache":"Caches centralizados en historyInjection.ts","globalBuffers":0},"category":"MEMORY_USAGE","cpu":{"system":"250ms","user":"1220ms"},"environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","logReason":"memory_leak","memory":{"external":"3MB","heapTotal":"29MB","heapUsagePercent":"95%","heapUsed":"28MB","rss":"85MB"},"threads":{"active":1,"total":1},"timestamp":"2025-07-23T11:17:04.886Z","uptime":"12601s"} labels={"app":"whatsapp-bot","category":"MEMORY_USAGE","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T11:17:04.886Z"
2025-07-23T11:17:05.353647809Z [INFO] [MEMORY_LEAK_DETECTED] Posible memory leak crítico detectado jsonPayload={"category":"MEMORY_LEAK_DETECTED","environment":"cloud-run","flow":{"stage":"0_unknown"},"heapUsagePercent":"95%","heapUsedMB":28,"level":"FATAL","recommendation":"Uso de memoria crítico - considerar optimización o restart inmediato","threshold":95,"timestamp":"2025-07-23T11:17:04.886Z"} labels={"app":"whatsapp-bot","category":"MEMORY_LEAK_DETECTED","flow_stage":"0_unknown","level":"FATAL"} timestamp="2025-07-23T11:17:04.886Z"
2025-07-23T11:22:05.510200790Z [INFO] [MEMORY_USAGE] Métricas de memoria del sistema jsonPayload={"caches":{"centralizedCache":"Caches centralizados en historyInjection.ts","globalBuffers":0},"category":"MEMORY_USAGE","cpu":{"system":"250ms","user":"1222ms"},"environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","logReason":"memory_leak","memory":{"external":"3MB","heapTotal":"29MB","heapUsagePercent":"96%","heapUsed":"28MB","rss":"85MB"},"threads":{"active":1,"total":1},"timestamp":"2025-07-23T11:22:04.899Z","uptime":"12901s"} labels={"app":"whatsapp-bot","category":"MEMORY_USAGE","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T11:22:04.899Z"
2025-07-23T11:22:05.510241570Z [INFO] [MEMORY_LEAK_DETECTED] Posible memory leak crítico detectado jsonPayload={"category":"MEMORY_LEAK_DETECTED","environment":"cloud-run","flow":{"stage":"0_unknown"},"heapUsagePercent":"96%","heapUsedMB":28,"level":"FATAL","recommendation":"Uso de memoria crítico - considerar optimización o restart inmediato","threshold":95,"timestamp":"2025-07-23T11:22:04.900Z"} labels={"app":"whatsapp-bot","category":"MEMORY_LEAK_DETECTED","flow_stage":"0_unknown","level":"FATAL"} timestamp="2025-07-23T11:22:04.900Z"
2025-07-23T11:27:05.658502963Z [INFO] [MEMORY_USAGE] Métricas de memoria del sistema jsonPayload={"caches":{"centralizedCache":"Caches centralizados en historyInjection.ts","globalBuffers":0},"category":"MEMORY_USAGE","cpu":{"system":"251ms","user":"1224ms"},"environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","logReason":"memory_leak","memory":{"external":"3MB","heapTotal":"29MB","heapUsagePercent":"96%","heapUsed":"28MB","rss":"85MB"},"threads":{"active":1,"total":1},"timestamp":"2025-07-23T11:27:04.899Z","uptime":"13201s"} labels={"app":"whatsapp-bot","category":"MEMORY_USAGE","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T11:27:04.899Z"
2025-07-23T11:27:05.658546683Z [INFO] [MEMORY_LEAK_DETECTED] Posible memory leak crítico detectado jsonPayload={"category":"MEMORY_LEAK_DETECTED","environment":"cloud-run","flow":{"stage":"0_unknown"},"heapUsagePercent":"96%","heapUsedMB":28,"level":"FATAL","recommendation":"Uso de memoria crítico - considerar optimización o restart inmediato","threshold":95,"timestamp":"2025-07-23T11:27:04.899Z"} labels={"app":"whatsapp-bot","category":"MEMORY_LEAK_DETECTED","flow_stage":"0_unknown","level":"FATAL"} timestamp="2025-07-23T11:27:04.899Z"
2025-07-23T11:32:05.774981972Z [INFO] [MEMORY_USAGE] Métricas de memoria del sistema jsonPayload={"caches":{"centralizedCache":"Caches centralizados en historyInjection.ts","globalBuffers":0},"category":"MEMORY_USAGE","cpu":{"system":"251ms","user":"1225ms"},"environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","logReason":"memory_leak","memory":{"external":"3MB","heapTotal":"29MB","heapUsagePercent":"96%","heapUsed":"28MB","rss":"85MB"},"threads":{"active":1,"total":1},"timestamp":"2025-07-23T11:32:04.918Z","uptime":"13501s"} labels={"app":"whatsapp-bot","category":"MEMORY_USAGE","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T11:32:04.918Z"
2025-07-23T11:32:05.775019834Z [INFO] [MEMORY_LEAK_DETECTED] Posible memory leak crítico detectado jsonPayload={"category":"MEMORY_LEAK_DETECTED","environment":"cloud-run","flow":{"stage":"0_unknown"},"heapUsagePercent":"96%","heapUsedMB":28,"level":"FATAL","recommendation":"Uso de memoria crítico - considerar optimización o restart inmediato","threshold":95,"timestamp":"2025-07-23T11:32:04.918Z"} labels={"app":"whatsapp-bot","category":"MEMORY_LEAK_DETECTED","flow_stage":"0_unknown","level":"FATAL"} timestamp="2025-07-23T11:32:04.918Z"
2025-07-23T11:37:05.940072609Z [INFO] [MEMORY_USAGE] Métricas de memoria del sistema jsonPayload={"caches":{"centralizedCache":"Caches centralizados en historyInjection.ts","globalBuffers":0},"category":"MEMORY_USAGE","cpu":{"system":"251ms","user":"1227ms"},"environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","logReason":"memory_leak","memory":{"external":"3MB","heapTotal":"29MB","heapUsagePercent":"96%","heapUsed":"28MB","rss":"85MB"},"threads":{"active":1,"total":1},"timestamp":"2025-07-23T11:37:04.918Z","uptime":"13801s"} labels={"app":"whatsapp-bot","category":"MEMORY_USAGE","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T11:37:04.918Z"
2025-07-23T11:37:05.940114114Z [INFO] [MEMORY_LEAK_DETECTED] Posible memory leak crítico detectado jsonPayload={"category":"MEMORY_LEAK_DETECTED","environment":"cloud-run","flow":{"stage":"0_unknown"},"heapUsagePercent":"96%","heapUsedMB":28,"level":"FATAL","recommendation":"Uso de memoria crítico - considerar optimización o restart inmediato","threshold":95,"timestamp":"2025-07-23T11:37:04.918Z"} labels={"app":"whatsapp-bot","category":"MEMORY_LEAK_DETECTED","flow_stage":"0_unknown","level":"FATAL"} timestamp="2025-07-23T11:37:04.918Z"
2025-07-23T11:42:06.184407607Z [INFO] [MEMORY_USAGE] Métricas de memoria del sistema jsonPayload={"caches":{"centralizedCache":"Caches centralizados en historyInjection.ts","globalBuffers":0},"category":"MEMORY_USAGE","cpu":{"system":"252ms","user":"1229ms"},"environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","logReason":"memory_leak","memory":{"external":"3MB","heapTotal":"29MB","heapUsagePercent":"96%","heapUsed":"28MB","rss":"85MB"},"threads":{"active":1,"total":1},"timestamp":"2025-07-23T11:42:04.935Z","uptime":"14101s"} labels={"app":"whatsapp-bot","category":"MEMORY_USAGE","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T11:42:04.935Z"
2025-07-23T11:42:06.184444576Z [INFO] [MEMORY_LEAK_DETECTED] Posible memory leak crítico detectado jsonPayload={"category":"MEMORY_LEAK_DETECTED","environment":"cloud-run","flow":{"stage":"0_unknown"},"heapUsagePercent":"96%","heapUsedMB":28,"level":"FATAL","recommendation":"Uso de memoria crítico - considerar optimización o restart inmediato","threshold":95,"timestamp":"2025-07-23T11:42:04.935Z"} labels={"app":"whatsapp-bot","category":"MEMORY_LEAK_DETECTED","flow_stage":"0_unknown","level":"FATAL"} timestamp="2025-07-23T11:42:04.935Z"
2025-07-23T11:47:06.447515072Z [INFO] [MEMORY_USAGE] Métricas de memoria del sistema jsonPayload={"caches":{"centralizedCache":"Caches centralizados en historyInjection.ts","globalBuffers":0},"category":"MEMORY_USAGE","cpu":{"system":"252ms","user":"1230ms"},"environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","logReason":"memory_leak","memory":{"external":"3MB","heapTotal":"29MB","heapUsagePercent":"96%","heapUsed":"28MB","rss":"85MB"},"threads":{"active":1,"total":1},"timestamp":"2025-07-23T11:47:04.936Z","uptime":"14401s"} labels={"app":"whatsapp-bot","category":"MEMORY_USAGE","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T11:47:04.936Z"
2025-07-23T11:47:06.447551738Z [INFO] [MEMORY_LEAK_DETECTED] Posible memory leak crítico detectado jsonPayload={"category":"MEMORY_LEAK_DETECTED","environment":"cloud-run","flow":{"stage":"0_unknown"},"heapUsagePercent":"96%","heapUsedMB":28,"level":"FATAL","recommendation":"Uso de memoria crítico - considerar optimización o restart inmediato","threshold":95,"timestamp":"2025-07-23T11:47:04.936Z"} labels={"app":"whatsapp-bot","category":"MEMORY_LEAK_DETECTED","flow_stage":"0_unknown","level":"FATAL"} timestamp="2025-07-23T11:47:04.936Z"
2025-07-23T11:52:06.699831064Z [INFO] [MEMORY_USAGE] Métricas de memoria del sistema jsonPayload={"caches":{"centralizedCache":"Caches centralizados en historyInjection.ts","globalBuffers":0},"category":"MEMORY_USAGE","cpu":{"system":"252ms","user":"1232ms"},"environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","logReason":"memory_leak","memory":{"external":"3MB","heapTotal":"29MB","heapUsagePercent":"96%","heapUsed":"28MB","rss":"85MB"},"threads":{"active":1,"total":1},"timestamp":"2025-07-23T11:52:04.953Z","uptime":"14701s"} labels={"app":"whatsapp-bot","category":"MEMORY_USAGE","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T11:52:04.952Z"
2025-07-23T11:52:06.699864898Z [INFO] [MEMORY_LEAK_DETECTED] Posible memory leak crítico detectado jsonPayload={"category":"MEMORY_LEAK_DETECTED","environment":"cloud-run","flow":{"stage":"0_unknown"},"heapUsagePercent":"96%","heapUsedMB":28,"level":"FATAL","recommendation":"Uso de memoria crítico - considerar optimización o restart inmediato","threshold":95,"timestamp":"2025-07-23T11:52:04.953Z"} labels={"app":"whatsapp-bot","category":"MEMORY_LEAK_DETECTED","flow_stage":"0_unknown","level":"FATAL"} timestamp="2025-07-23T11:52:04.953Z"
2025-07-23T11:57:07.021674596Z [INFO] [MEMORY_USAGE] Métricas de memoria del sistema jsonPayload={"caches":{"centralizedCache":"Caches centralizados en historyInjection.ts","globalBuffers":0},"category":"MEMORY_USAGE","cpu":{"system":"253ms","user":"1234ms"},"environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","logReason":"memory_leak","memory":{"external":"3MB","heapTotal":"29MB","heapUsagePercent":"96%","heapUsed":"28MB","rss":"85MB"},"threads":{"active":1,"total":1},"timestamp":"2025-07-23T11:57:04.953Z","uptime":"15001s"} labels={"app":"whatsapp-bot","category":"MEMORY_USAGE","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T11:57:04.953Z"
2025-07-23T11:57:07.021705776Z [INFO] [MEMORY_LEAK_DETECTED] Posible memory leak crítico detectado jsonPayload={"category":"MEMORY_LEAK_DETECTED","environment":"cloud-run","flow":{"stage":"0_unknown"},"heapUsagePercent":"96%","heapUsedMB":28,"level":"FATAL","recommendation":"Uso de memoria crítico - considerar optimización o restart inmediato","threshold":95,"timestamp":"2025-07-23T11:57:04.953Z"} labels={"app":"whatsapp-bot","category":"MEMORY_LEAK_DETECTED","flow_stage":"0_unknown","level":"FATAL"} timestamp="2025-07-23T11:57:04.953Z"
2025-07-23T13:21:50.119768756Z [INFO] [PRESENCE_EVENT] Procesando 1 eventos de presencia jsonPayload={"category":"PRESENCE_EVENT","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","presenceCount":1,"timestamp":"2025-07-23T13:21:46.297Z"} labels={"app":"whatsapp-bot","category":"PRESENCE_EVENT","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:21:46.297Z"
2025-07-23T13:21:50.119806245Z [INFO] [PRESENCE_RECEIVED] Presencia para 573003913251: typing jsonPayload={"category":"PRESENCE_RECEIVED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","status":"typing","timestamp":"2025-07-23T13:21:46.297Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"PRESENCE_RECEIVED","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:21:46.297Z"
2025-07-23T13:21:50.119841454Z [INFO] [PRESENCE_EVENT] Procesando 1 eventos de presencia jsonPayload={"category":"PRESENCE_EVENT","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","presenceCount":1,"timestamp":"2025-07-23T13:21:47.647Z"} labels={"app":"whatsapp-bot","category":"PRESENCE_EVENT","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:21:47.647Z"
2025-07-23T13:21:50.119878417Z [INFO] [PRESENCE_RECEIVED] Presencia para 573003913251: typing jsonPayload={"category":"PRESENCE_RECEIVED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","status":"typing","timestamp":"2025-07-23T13:21:47.647Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"PRESENCE_RECEIVED","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:21:47.647Z"
📨 Webhook: 1 mensajes recibidos
2025-07-23T13:21:50.119928443Z [INFO] [WEBHOOK] Procesando 1 mensajes del webhook jsonPayload={"category":"WEBHOOK","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","messageCount":1,"timestamp":"2025-07-23T13:21:47.895Z"} labels={"app":"whatsapp-bot","category":"WEBHOOK","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:21:47.895Z"
2025-07-23T13:21:50.120410740Z [INFO] [MESSAGE_RECEIVED] Mensaje recibido jsonPayload={"body":"Hola...","category":"MESSAGE_RECEIVED","chatId":"573003913251@s.whatsapp.net","environment":"cloud-run","flow":{"stage":"1_receive"},"from":"573003913251","level":"INFO","timestamp":1753276906,"type":"text","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"MESSAGE_RECEIVED","flow_stage":"1_receive","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:21:47.895Z"
📥 [BUFFER] 573003913251: "Hola..." → ⏳ 5s...
2025-07-23T13:21:50.120568968Z [INFO] [GLOBAL_BUFFER_ADD] Mensaje agregado al buffer global jsonPayload={"bufferSize":1,"category":"GLOBAL_BUFFER_ADD","delay":5000,"environment":"cloud-run","flow":{"stage":"0_unknown"},"isMedia":false,"level":"INFO","messageText":"Hola...","timestamp":"2025-07-23T13:21:47.895Z","userJid":"573003913251","userName":"573003913251"} labels={"app":"whatsapp-bot","category":"GLOBAL_BUFFER_ADD","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:21:47.895Z"
📨 Webhook: 1 mensajes recibidos
2025-07-23T13:21:50.120622011Z [INFO] [WEBHOOK] Procesando 1 mensajes del webhook jsonPayload={"category":"WEBHOOK","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","messageCount":1,"timestamp":"2025-07-23T13:21:49.305Z"} labels={"app":"whatsapp-bot","category":"WEBHOOK","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:21:49.305Z"
2025-07-23T13:21:50.120650482Z [INFO] [MESSAGE_RECEIVED] Mensaje recibido jsonPayload={"body":"Buen día...","category":"MESSAGE_RECEIVED","chatId":"573003913251@s.whatsapp.net","environment":"cloud-run","flow":{"stage":"1_receive"},"from":"573003913251","level":"INFO","timestamp":1753276908,"type":"text","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"MESSAGE_RECEIVED","flow_stage":"1_receive","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:21:49.306Z"
📥 [BUFFER] 573003913251: "Buen día..." → ⏳ 5s...
2025-07-23T13:21:50.121000795Z [INFO] [GLOBAL_BUFFER_ADD] Mensaje agregado al buffer global jsonPayload={"bufferSize":2,"category":"GLOBAL_BUFFER_ADD","delay":5000,"environment":"cloud-run","flow":{"stage":"0_unknown"},"isMedia":false,"level":"INFO","messageText":"Buen día...","timestamp":"2025-07-23T13:21:49.306Z","userJid":"573003913251","userName":"573003913251"} labels={"app":"whatsapp-bot","category":"GLOBAL_BUFFER_ADD","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:21:49.306Z"
2025-07-23T13:21:50.121137207Z [INFO] [PRESENCE_EVENT] Procesando 1 eventos de presencia jsonPayload={"category":"PRESENCE_EVENT","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","presenceCount":1,"timestamp":"2025-07-23T13:21:49.342Z"} labels={"app":"whatsapp-bot","category":"PRESENCE_EVENT","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:21:49.342Z"
2025-07-23T13:21:50.121201882Z [INFO] [PRESENCE_RECEIVED] Presencia para 573003913251: typing jsonPayload={"category":"PRESENCE_RECEIVED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","status":"typing","timestamp":"2025-07-23T13:21:49.342Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"PRESENCE_RECEIVED","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:21:49.342Z"
2025-07-23T13:21:50.121228885Z [INFO] [GLOBAL_BUFFER_TYPING] Timer reiniciado por typing jsonPayload={"category":"GLOBAL_BUFFER_TYPING","delay":5000,"environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","timestamp":"2025-07-23T13:21:49.342Z","userJid":"573003913251","userName":"573003913251"} labels={"app":"whatsapp-bot","category":"GLOBAL_BUFFER_TYPING","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:21:49.342Z"
📨 Webhook: 1 mensajes recibidos
2025-07-23T13:21:51.902169700Z [INFO] [WEBHOOK] Procesando 1 mensajes del webhook jsonPayload={"category":"WEBHOOK","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","messageCount":1,"timestamp":"2025-07-23T13:21:51.896Z"} labels={"app":"whatsapp-bot","category":"WEBHOOK","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:21:51.896Z"
2025-07-23T13:21:51.902210387Z [INFO] [MESSAGE_RECEIVED] Mensaje recibido jsonPayload={"body":"Como va todo...","category":"MESSAGE_RECEIVED","chatId":"573003913251@s.whatsapp.net","environment":"cloud-run","flow":{"stage":"1_receive"},"from":"573003913251","level":"INFO","timestamp":1753276911,"type":"text","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"MESSAGE_RECEIVED","flow_stage":"1_receive","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:21:51.896Z"
📥 [BUFFER] 573003913251: "Como va todo..." → ⏳ 5s...
2025-07-23T13:21:51.902267480Z [INFO] [GLOBAL_BUFFER_ADD] Mensaje agregado al buffer global jsonPayload={"bufferSize":3,"category":"GLOBAL_BUFFER_ADD","delay":5000,"environment":"cloud-run","flow":{"stage":"0_unknown"},"isMedia":false,"level":"INFO","messageText":"Como va todo...","timestamp":"2025-07-23T13:21:51.896Z","userJid":"573003913251","userName":"573003913251"} labels={"app":"whatsapp-bot","category":"GLOBAL_BUFFER_ADD","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:21:51.896Z"
2025-07-23T13:21:56.900933677Z [INFO] [GLOBAL_BUFFER_PROCESS] Procesando buffer global después de 5 segundos jsonPayload={"category":"GLOBAL_BUFFER_PROCESS","combinedText":"Hola Buen día Como va todo...","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","messageCount":3,"timestamp":"2025-07-23T13:21:56.899Z","userJid":"573003913251","userName":"573003913251"} labels={"app":"whatsapp-bot","category":"GLOBAL_BUFFER_PROCESS","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:21:56.899Z"
2025-07-23T13:21:57.757199809Z [INFO] [QUEUE_ITEM_ADDED] Mensaje agregado a cola de usuario jsonPayload={"category":"QUEUE_ITEM_ADDED","environment":"cloud-run","flow":{"sequence":1,"stage":"0_unknown"},"hasActiveLock":false,"level":"INFO","messageId":"msg_1753276917754_rvc109e49","queueLength":1,"timestamp":"2025-07-23T13:21:57.754Z","totalQueues":1,"userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_ITEM_ADDED","flow_stage":"0_unknown","level":"INFO","message_id":"msg_1753276917754_rvc109e49","user_id":"573003913251"} timestamp="2025-07-23T13:21:57.754Z"
2025-07-23T13:21:57.757230156Z [INFO] [QUEUE_PROCESSING_START] Procesando cola de usuario jsonPayload={"category":"QUEUE_PROCESSING_START","environment":"cloud-run","flow":{"stage":"0_unknown"},"hasActiveLock":false,"level":"INFO","queueLength":1,"timestamp":"2025-07-23T13:21:57.755Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_PROCESSING_START","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:21:57.755Z"
2025-07-23T13:21:57.757267486Z [INFO] [QUEUE_ITEM_PROCESSING] Procesando mensaje de cola jsonPayload={"category":"QUEUE_ITEM_PROCESSING","environment":"cloud-run","flow":{"sequence":2,"stage":"0_unknown"},"level":"TRACE","messageId":"msg_1753276917754_rvc109e49","remainingInQueue":0,"timestamp":"2025-07-23T13:21:57.755Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_ITEM_PROCESSING","flow_stage":"0_unknown","level":"TRACE","message_id":"msg_1753276917754_rvc109e49","user_id":"573003913251"} timestamp="2025-07-23T13:21:57.755Z"
2025-07-23T13:21:58.412110857Z [INFO] [OPENAI_REQUEST] starting_process jsonPayload={"category":"OPENAI_REQUEST","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","timestamp":"2025-07-23T13:21:58.411Z"} labels={"app":"whatsapp-bot","category":"OPENAI_REQUEST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:21:58.411Z"
2025-07-23T13:21:58.412148771Z [INFO] [THREAD_REUSE] Thread reutilizado para 573003913251 jsonPayload={"category":"THREAD_REUSE","chatId":"573003913251@s.whatsapp.net","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:21:58.411Z","userName":"573003913251"} labels={"app":"whatsapp-bot","category":"THREAD_REUSE","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:21:58.411Z"
2025-07-23T13:21:58.412193027Z [INFO] [HISTORY_SKIP] Skip fetch historial: Thread existe jsonPayload={"category":"HISTORY_SKIP","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","reason":"thread_already_exists","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:21:58.411Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"HISTORY_SKIP","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:21:58.411Z"
2025-07-23T13:21:58.412193112Z [INFO] [HISTORY_INJECTION_COMPLETED] Inyección de historial completada jsonPayload={"category":"HISTORY_INJECTION_COMPLETED","contextLength":0,"environment":"cloud-run","flow":{"stage":"0_unknown"},"historyLines":0,"labelsCount":0,"level":"SUCCESS","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:21:58.411Z","tokensUsed":0,"userId":"573003913251"} labels={"app":"whatsapp-bot","category":"HISTORY_INJECTION_COMPLETED","flow_stage":"0_unknown","level":"SUCCESS","user_id":"573003913251"} timestamp="2025-07-23T13:21:58.411Z"
2025-07-23T13:21:58.412255005Z [INFO] [HISTORY_INJECTION_SKIP] Saltando inyección - thread existente sin necesidad de contexto jsonPayload={"category":"HISTORY_INJECTION_SKIP","environment":"cloud-run","flow":{"stage":"0_unknown"},"hasContextAnalysis":false,"isNewThread":false,"level":"INFO","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:21:58.411Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"HISTORY_INJECTION_SKIP","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:21:58.411Z"
2025-07-23T13:21:58.708949131Z [INFO] [CONTEXT_FRESH_RESTART] Generando contexto fresco después del reinicio jsonPayload={"cacheAge":20058,"category":"CONTEXT_FRESH_RESTART","environment":"cloud-run","flow":{"stage":"0_unknown"},"hadCachedContext":true,"level":"INFO","timestamp":"2025-07-23T13:21:58.706Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"CONTEXT_FRESH_RESTART","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:21:58.706Z"
2025-07-23T13:21:58.708995291Z [INFO] [WHAPI_LABELS] Obteniendo info del chat para 573003913251 jsonPayload={"category":"WHAPI_LABELS","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","timestamp":"2025-07-23T13:21:58.706Z"} labels={"app":"whatsapp-bot","category":"WHAPI_LABELS","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:21:58.706Z"
2025-07-23T13:21:59.214537375Z [INFO] [WHAPI_LABELS] Info del chat obtenida. Etiquetas: 2 jsonPayload={"category":"WHAPI_LABELS","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"SUCCESS","timestamp":"2025-07-23T13:21:59.213Z"} labels={"app":"whatsapp-bot","category":"WHAPI_LABELS","flow_stage":"0_unknown","level":"SUCCESS"} timestamp="2025-07-23T13:21:59.213Z"
2025-07-23T13:21:59.218066814Z [INFO] [CONTEXT_INJECTION] Contexto temporal generado jsonPayload={"category":"CONTEXT_INJECTION","clientName":"Sr Alex","contactName":"Sr Alex","contextLength":150,"environment":"cloud-run","flow":{"stage":"0_unknown"},"hasChatInfo":true,"hasProfile":true,"isFirstMessageAfterRestart":true,"labelsCount":2,"level":"INFO","timestamp":"2025-07-23T13:21:59.215Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"CONTEXT_INJECTION","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:21:59.215Z"
2025-07-23T13:21:59.218131215Z [INFO] [CONTEXT_DEBUG] Contexto enviado a OpenAI jsonPayload={"category":"CONTEXT_DEBUG","contextPreview":"Fecha: 23/07/2025 | Hora: 8:21 AM (Colombia)\nCliente: Sr Alex | Contacto WhatsApp: Sr Alex | Status: Colega Jefe, cotización\n---\nMensaje del cliente:\n","environment":"cloud-run","flow":{"stage":"0_unknown"},"isVoiceMessage":false,"level":"INFO","messagePreview":"Hola Buen día Como va todo","shortUserId":"573003913251","timestamp":"2025-07-23T13:21:59.215Z","totalLength":176} labels={"app":"whatsapp-bot","category":"CONTEXT_DEBUG","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:21:59.215Z"
2025-07-23T13:22:00.127061414Z [INFO] [OPENAI_REQUEST] message_added_with_context jsonPayload={"category":"OPENAI_REQUEST","contextLength":150,"environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","originalLength":26,"shortUserId":"573003913251","timestamp":"2025-07-23T13:22:00.108Z","totalLength":176} labels={"app":"whatsapp-bot","category":"OPENAI_REQUEST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:22:00.108Z"
2025-07-23T13:22:00.127091492Z [INFO] [OPENAI_REQUEST] creating_run jsonPayload={"category":"OPENAI_REQUEST","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","timestamp":"2025-07-23T13:22:00.108Z"} labels={"app":"whatsapp-bot","category":"OPENAI_REQUEST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:22:00.108Z"
2025-07-23T13:22:02.694094625Z [INFO] [OPENAI_REQUEST] run_started jsonPayload={"category":"OPENAI_REQUEST","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","timestamp":"2025-07-23T13:22:02.693Z"} labels={"app":"whatsapp-bot","category":"OPENAI_REQUEST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:22:02.693Z"
2025-07-23T13:22:05.074800829Z [INFO] [MEMORY_USAGE] Métricas de memoria del sistema jsonPayload={"caches":{"centralizedCache":"Caches centralizados en historyInjection.ts","globalBuffers":0},"category":"MEMORY_USAGE","cpu":{"system":"292ms","user":"1318ms"},"environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","logReason":"memory_leak","memory":{"external":"3MB","heapTotal":"29MB","heapUsagePercent":"96%","heapUsed":"28MB","rss":"84MB"},"threads":{"active":1,"total":1},"timestamp":"2025-07-23T13:22:05.070Z","uptime":"20101s"} labels={"app":"whatsapp-bot","category":"MEMORY_USAGE","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:22:05.070Z"
2025-07-23T13:22:05.074837686Z [INFO] [MEMORY_LEAK_DETECTED] Posible memory leak crítico detectado jsonPayload={"category":"MEMORY_LEAK_DETECTED","environment":"cloud-run","flow":{"stage":"0_unknown"},"heapUsagePercent":"96%","heapUsedMB":28,"level":"FATAL","recommendation":"Uso de memoria crítico - considerar optimización o restart inmediato","threshold":95,"timestamp":"2025-07-23T13:22:05.071Z"} labels={"app":"whatsapp-bot","category":"MEMORY_LEAK_DETECTED","flow_stage":"0_unknown","level":"FATAL"} timestamp="2025-07-23T13:22:05.071Z"
2025-07-23T13:22:05.260190056Z [INFO] [OPENAI_RUN_COMPLETED] Run completado para 573003913251 jsonPayload={"category":"OPENAI_RUN_COMPLETED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"SUCCESS","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:22:05.256Z"} labels={"app":"whatsapp-bot","category":"OPENAI_RUN_COMPLETED","flow_stage":"0_unknown","level":"SUCCESS"} timestamp="2025-07-23T13:22:05.256Z"
2025-07-23T13:22:05.260246335Z [INFO] [TOKEN_USAGE] Tokens utilizados jsonPayload={"category":"TOKEN_USAGE","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:22:05.256Z","totalTokens":1631} labels={"app":"whatsapp-bot","category":"TOKEN_USAGE","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:22:05.256Z"
2025-07-23T13:22:05.260304413Z [INFO] [OPENAI_USAGE] Run completado con métricas jsonPayload={"category":"OPENAI_USAGE","completionTokens":24,"contextTokens":0,"durationMs":6845,"environment":"cloud-run","flow":{"stage":"6_ai_request"},"level":"INFO","promptTokens":1607,"runId":"run_vZstl8zUdA8WcsuSTLYNSGr5","shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:22:05.257Z","tokensPerSecond":238,"totalTokens":1631} labels={"app":"whatsapp-bot","category":"OPENAI_USAGE","flow_stage":"6_ai_request","level":"INFO"} timestamp="2025-07-23T13:22:05.257Z"
2025-07-23T13:22:05.260350124Z [INFO] [OPENAI_LATENCY] Latencia del procesamiento jsonPayload={"category":"OPENAI_LATENCY","durationSeconds":"6.84","environment":"cloud-run","flow":{"stage":"6_ai_request"},"isHighLatency":false,"level":"INFO","shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:22:05.257Z","totalDurationMs":6845} labels={"app":"whatsapp-bot","category":"OPENAI_LATENCY","flow_stage":"6_ai_request","level":"INFO"} timestamp="2025-07-23T13:22:05.257Z"
2025-07-23T13:22:05.414636092Z [INFO] [OPENAI_RESPONSE] response_received jsonPayload={"category":"OPENAI_RESPONSE","environment":"cloud-run","flow":{"stage":"7_ai_response"},"level":"INFO","responseLength":77,"shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:22:05.413Z"} labels={"app":"whatsapp-bot","category":"OPENAI_RESPONSE","flow_stage":"7_ai_response","level":"INFO"} timestamp="2025-07-23T13:22:05.413Z"
2025-07-23T13:22:05.414640581Z [INFO] [PERFORMANCE_METRICS] Procesamiento completado exitosamente jsonPayload={"category":"PERFORMANCE_METRICS","contextTokens":0,"environment":"cloud-run","flow":{"stage":"9_complete"},"isEfficient":true,"level":"INFO","memory":{"heapTotalMB":30,"heapUsedMB":28,"rssMB":84},"responseLength":77,"shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:22:05.414Z","tokensPerSecond":233,"totalDurationMs":7003,"totalTokens":1631} labels={"app":"whatsapp-bot","category":"PERFORMANCE_METRICS","flow_stage":"9_complete","level":"INFO"} timestamp="2025-07-23T13:22:05.414Z"
2025-07-23T13:22:05.414879612Z [INFO] [WHATSAPP_SEND] Enviando mensaje a 573003913251 jsonPayload={"category":"WHATSAPP_SEND","chatId":"573003913251@s.whatsapp.net","environment":"cloud-run","flow":{"stage":"8_send"},"level":"INFO","messageLength":77,"preview":"¡Buenos días, Sr. Alex! Todo en orden, gracias. ¿Cómo puedo asistirte hoy? 😊...","timestamp":"2025-07-23T13:22:05.414Z"} labels={"app":"whatsapp-bot","category":"WHATSAPP_SEND","flow_stage":"8_send","level":"INFO"} timestamp="2025-07-23T13:22:05.414Z"
2025-07-23T13:22:06.045Z ✅ [573003913251] Mensaje enviado
2025-07-23T13:22:06.050017655Z [INFO] [QUEUE_ITEM_SUCCESS] Mensaje procesado exitosamente jsonPayload={"category":"QUEUE_ITEM_SUCCESS","environment":"cloud-run","flow":{"sequence":3,"stage":"0_unknown"},"level":"SUCCESS","messageId":"msg_1753276917754_rvc109e49","processedCount":1,"remainingInQueue":0,"timestamp":"2025-07-23T13:22:06.045Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_ITEM_SUCCESS","flow_stage":"0_unknown","level":"SUCCESS","message_id":"msg_1753276917754_rvc109e49","user_id":"573003913251"} timestamp="2025-07-23T13:22:06.045Z"
2025-07-23T13:22:06.050119353Z [INFO] [LOCK_ALREADY_RELEASED] Lock ya liberado para usuario jsonPayload={"activeLocks":0,"category":"LOCK_ALREADY_RELEASED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"TRACE","timestamp":"2025-07-23T13:22:06.045Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"LOCK_ALREADY_RELEASED","flow_stage":"0_unknown","level":"TRACE","user_id":"573003913251"} timestamp="2025-07-23T13:22:06.045Z"
2025-07-23T13:22:06.050166078Z [INFO] [QUEUE_PROCESSING_COMPLETE] Cola de usuario procesada completamente jsonPayload={"averageTimePerMessage":"8290ms","category":"QUEUE_PROCESSING_COMPLETE","environment":"cloud-run","errorCount":0,"flow":{"stage":"0_unknown"},"initialQueueLength":1,"level":"SUCCESS","processedCount":1,"processingDuration":"8290ms","remainingQueues":0,"timestamp":"2025-07-23T13:22:06.045Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_PROCESSING_COMPLETE","flow_stage":"0_unknown","level":"SUCCESS","user_id":"573003913251"} timestamp="2025-07-23T13:22:06.045Z"
📨 Webhook: 1 mensajes recibidos
2025-07-23T13:22:06.751908251Z [INFO] [WEBHOOK] Procesando 1 mensajes del webhook jsonPayload={"category":"WEBHOOK","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","messageCount":1,"timestamp":"2025-07-23T13:22:06.749Z"} labels={"app":"whatsapp-bot","category":"WEBHOOK","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:22:06.749Z"
2025-07-23T13:22:12.795038189Z [INFO] [PRESENCE_EVENT] Procesando 1 eventos de presencia jsonPayload={"category":"PRESENCE_EVENT","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","presenceCount":1,"timestamp":"2025-07-23T13:22:12.792Z"} labels={"app":"whatsapp-bot","category":"PRESENCE_EVENT","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:22:12.792Z"
2025-07-23T13:22:12.795071496Z [INFO] [PRESENCE_RECEIVED] Presencia para 573003913251: typing jsonPayload={"category":"PRESENCE_RECEIVED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","status":"typing","timestamp":"2025-07-23T13:22:12.793Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"PRESENCE_RECEIVED","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:22:12.793Z"
📨 Webhook: 1 mensajes recibidos
2025-07-23T13:22:17.270054872Z [INFO] [WEBHOOK] Procesando 1 mensajes del webhook jsonPayload={"category":"WEBHOOK","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","messageCount":1,"timestamp":"2025-07-23T13:22:17.264Z"} labels={"app":"whatsapp-bot","category":"WEBHOOK","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:22:17.264Z"
2025-07-23T13:22:17.270088708Z [INFO] [MESSAGE_RECEIVED] Mensaje recibido jsonPayload={"body":"Me gustaría consultar disponibilidad...","category":"MESSAGE_RECEIVED","chatId":"573003913251@s.whatsapp.net","environment":"cloud-run","flow":{"stage":"1_receive"},"from":"573003913251","level":"INFO","timestamp":1753276936,"type":"text","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"MESSAGE_RECEIVED","flow_stage":"1_receive","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:22:17.264Z"
📥 [BUFFER] 573003913251: "Me gustaría consultar disponib..." → ⏳ 5s...
2025-07-23T13:22:17.270138696Z [INFO] [GLOBAL_BUFFER_ADD] Mensaje agregado al buffer global jsonPayload={"bufferSize":1,"category":"GLOBAL_BUFFER_ADD","delay":5000,"environment":"cloud-run","flow":{"stage":"0_unknown"},"isMedia":false,"level":"INFO","messageText":"Me gustaría consultar disponibilidad...","timestamp":"2025-07-23T13:22:17.264Z","userJid":"573003913251","userName":"573003913251"} labels={"app":"whatsapp-bot","category":"GLOBAL_BUFFER_ADD","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:22:17.264Z"
2025-07-23T13:22:22.268443341Z [INFO] [GLOBAL_BUFFER_PROCESS] Procesando buffer global después de 5 segundos jsonPayload={"category":"GLOBAL_BUFFER_PROCESS","combinedText":"Me gustaría consultar disponibilidad...","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","messageCount":1,"timestamp":"2025-07-23T13:22:22.264Z","userJid":"573003913251","userName":"573003913251"} labels={"app":"whatsapp-bot","category":"GLOBAL_BUFFER_PROCESS","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:22:22.264Z"
2025-07-23T13:22:23.086327785Z [INFO] [QUEUE_ITEM_ADDED] Mensaje agregado a cola de usuario jsonPayload={"category":"QUEUE_ITEM_ADDED","environment":"cloud-run","flow":{"sequence":1,"stage":"0_unknown"},"hasActiveLock":false,"level":"INFO","messageId":"msg_1753276943081_aprnjnuvt","queueLength":1,"timestamp":"2025-07-23T13:22:23.081Z","totalQueues":1,"userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_ITEM_ADDED","flow_stage":"0_unknown","level":"INFO","message_id":"msg_1753276943081_aprnjnuvt","user_id":"573003913251"} timestamp="2025-07-23T13:22:23.081Z"
2025-07-23T13:22:23.086366796Z [INFO] [QUEUE_PROCESSING_START] Procesando cola de usuario jsonPayload={"category":"QUEUE_PROCESSING_START","environment":"cloud-run","flow":{"stage":"0_unknown"},"hasActiveLock":false,"level":"INFO","queueLength":1,"timestamp":"2025-07-23T13:22:23.081Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_PROCESSING_START","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:22:23.081Z"
2025-07-23T13:22:23.086399315Z [INFO] [QUEUE_ITEM_PROCESSING] Procesando mensaje de cola jsonPayload={"category":"QUEUE_ITEM_PROCESSING","environment":"cloud-run","flow":{"sequence":2,"stage":"0_unknown"},"level":"TRACE","messageId":"msg_1753276943081_aprnjnuvt","remainingInQueue":0,"timestamp":"2025-07-23T13:22:23.081Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_ITEM_PROCESSING","flow_stage":"0_unknown","level":"TRACE","message_id":"msg_1753276943081_aprnjnuvt","user_id":"573003913251"} timestamp="2025-07-23T13:22:23.081Z"
2025-07-23T13:22:23.559306332Z [INFO] [OPENAI_REQUEST] starting_process jsonPayload={"category":"OPENAI_REQUEST","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","timestamp":"2025-07-23T13:22:23.557Z"} labels={"app":"whatsapp-bot","category":"OPENAI_REQUEST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:22:23.557Z"
2025-07-23T13:22:23.559345163Z [INFO] [THREAD_REUSE] Thread reutilizado para 573003913251 jsonPayload={"category":"THREAD_REUSE","chatId":"573003913251@s.whatsapp.net","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:22:23.557Z","userName":"573003913251"} labels={"app":"whatsapp-bot","category":"THREAD_REUSE","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:22:23.557Z"
2025-07-23T13:22:23.559380906Z [INFO] [HISTORY_SKIP] Skip fetch historial: Thread existe jsonPayload={"category":"HISTORY_SKIP","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","reason":"thread_already_exists","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:22:23.557Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"HISTORY_SKIP","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:22:23.557Z"
2025-07-23T13:22:23.559390485Z [INFO] [HISTORY_INJECTION_COMPLETED] Inyección de historial completada jsonPayload={"category":"HISTORY_INJECTION_COMPLETED","contextLength":0,"environment":"cloud-run","flow":{"stage":"0_unknown"},"historyLines":0,"labelsCount":0,"level":"SUCCESS","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:22:23.557Z","tokensUsed":0,"userId":"573003913251"} labels={"app":"whatsapp-bot","category":"HISTORY_INJECTION_COMPLETED","flow_stage":"0_unknown","level":"SUCCESS","user_id":"573003913251"} timestamp="2025-07-23T13:22:23.557Z"
2025-07-23T13:22:23.559421949Z [INFO] [HISTORY_INJECTION_SKIP] Saltando inyección - thread existente sin necesidad de contexto jsonPayload={"category":"HISTORY_INJECTION_SKIP","environment":"cloud-run","flow":{"stage":"0_unknown"},"hasContextAnalysis":false,"isNewThread":false,"level":"INFO","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:22:23.557Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"HISTORY_INJECTION_SKIP","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:22:23.557Z"
2025-07-23T13:22:24.054951251Z [INFO] [CONTEXT_CACHE_HIT] Contexto temporal desde cache jsonPayload={"cacheAge":25,"category":"CONTEXT_CACHE_HIT","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","timestamp":"2025-07-23T13:22:24.051Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"CONTEXT_CACHE_HIT","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:22:24.051Z"
2025-07-23T13:22:24.055031430Z [INFO] [CONTEXT_DEBUG] Contexto enviado a OpenAI jsonPayload={"category":"CONTEXT_DEBUG","contextPreview":"Fecha: 23/07/2025 | Hora: 8:21 AM (Colombia)\nCliente: Sr Alex | Contacto WhatsApp: Sr Alex | Status: Colega Jefe, cotización\n---\nMensaje del cliente:\n","environment":"cloud-run","flow":{"stage":"0_unknown"},"isVoiceMessage":false,"level":"INFO","messagePreview":"Me gustaría consultar disponibilidad","shortUserId":"573003913251","timestamp":"2025-07-23T13:22:24.052Z","totalLength":186} labels={"app":"whatsapp-bot","category":"CONTEXT_DEBUG","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:22:24.052Z"
2025-07-23T13:22:24.421866092Z [INFO] [OPENAI_REQUEST] message_added_with_context jsonPayload={"category":"OPENAI_REQUEST","contextLength":150,"environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","originalLength":36,"shortUserId":"573003913251","timestamp":"2025-07-23T13:22:24.420Z","totalLength":186} labels={"app":"whatsapp-bot","category":"OPENAI_REQUEST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:22:24.420Z"
2025-07-23T13:22:24.421903591Z [INFO] [OPENAI_REQUEST] creating_run jsonPayload={"category":"OPENAI_REQUEST","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","timestamp":"2025-07-23T13:22:24.420Z"} labels={"app":"whatsapp-bot","category":"OPENAI_REQUEST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:22:24.420Z"
2025-07-23T13:22:25.418049539Z [INFO] [OPENAI_REQUEST] run_started jsonPayload={"category":"OPENAI_REQUEST","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","timestamp":"2025-07-23T13:22:25.416Z"} labels={"app":"whatsapp-bot","category":"OPENAI_REQUEST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:22:25.416Z"
2025-07-23T13:22:31.748209329Z [INFO] [OPENAI_RUN_COMPLETED] Run completado para 573003913251 jsonPayload={"category":"OPENAI_RUN_COMPLETED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"SUCCESS","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:22:31.746Z"} labels={"app":"whatsapp-bot","category":"OPENAI_RUN_COMPLETED","flow_stage":"0_unknown","level":"SUCCESS"} timestamp="2025-07-23T13:22:31.746Z"
2025-07-23T13:22:31.748246814Z [INFO] [TOKEN_USAGE] Tokens utilizados jsonPayload={"category":"TOKEN_USAGE","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:22:31.746Z","totalTokens":1717} labels={"app":"whatsapp-bot","category":"TOKEN_USAGE","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:22:31.746Z"
2025-07-23T13:22:31.748286007Z [INFO] [OPENAI_USAGE] Run completado con métricas jsonPayload={"category":"OPENAI_USAGE","completionTokens":27,"contextTokens":0,"durationMs":8189,"environment":"cloud-run","flow":{"stage":"6_ai_request"},"level":"INFO","promptTokens":1690,"runId":"run_bu1RLlLepGjEOqpzjfivyQl5","shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:22:31.746Z","tokensPerSecond":210,"totalTokens":1717} labels={"app":"whatsapp-bot","category":"OPENAI_USAGE","flow_stage":"6_ai_request","level":"INFO"} timestamp="2025-07-23T13:22:31.746Z"
2025-07-23T13:22:31.748317349Z [INFO] [OPENAI_LATENCY] Latencia del procesamiento jsonPayload={"category":"OPENAI_LATENCY","durationSeconds":"8.19","environment":"cloud-run","flow":{"stage":"6_ai_request"},"isHighLatency":false,"level":"INFO","shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:22:31.746Z","totalDurationMs":8189} labels={"app":"whatsapp-bot","category":"OPENAI_LATENCY","flow_stage":"6_ai_request","level":"INFO"} timestamp="2025-07-23T13:22:31.746Z"
2025-07-23T13:22:31.902486447Z [INFO] [OPENAI_RESPONSE] response_received jsonPayload={"category":"OPENAI_RESPONSE","environment":"cloud-run","flow":{"stage":"7_ai_response"},"level":"INFO","responseLength":83,"shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:22:31.899Z"} labels={"app":"whatsapp-bot","category":"OPENAI_RESPONSE","flow_stage":"7_ai_response","level":"INFO"} timestamp="2025-07-23T13:22:31.899Z"
2025-07-23T13:22:31.902534704Z [INFO] [PERFORMANCE_METRICS] Procesamiento completado exitosamente jsonPayload={"category":"PERFORMANCE_METRICS","contextTokens":0,"environment":"cloud-run","flow":{"stage":"9_complete"},"isEfficient":true,"level":"INFO","memory":{"heapTotalMB":30,"heapUsedMB":29,"rssMB":85},"responseLength":83,"shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:22:31.900Z","tokensPerSecond":206,"totalDurationMs":8343,"totalTokens":1717} labels={"app":"whatsapp-bot","category":"PERFORMANCE_METRICS","flow_stage":"9_complete","level":"INFO"} timestamp="2025-07-23T13:22:31.900Z"
2025-07-23T13:22:31.902583989Z [INFO] [WHATSAPP_SEND] Enviando mensaje a 573003913251 jsonPayload={"category":"WHATSAPP_SEND","chatId":"573003913251@s.whatsapp.net","environment":"cloud-run","flow":{"stage":"8_send"},"level":"INFO","messageLength":83,"preview":"Claro, Sr. Alex. ¿Cuáles son las fechas de entrada y salida que tiene en mente? 🏖️...","timestamp":"2025-07-23T13:22:31.900Z"} labels={"app":"whatsapp-bot","category":"WHATSAPP_SEND","flow_stage":"8_send","level":"INFO"} timestamp="2025-07-23T13:22:31.900Z"
2025-07-23T13:22:32.237Z ✅ [573003913251] Mensaje enviado
2025-07-23T13:22:32.242026822Z [INFO] [QUEUE_ITEM_SUCCESS] Mensaje procesado exitosamente jsonPayload={"category":"QUEUE_ITEM_SUCCESS","environment":"cloud-run","flow":{"sequence":3,"stage":"0_unknown"},"level":"SUCCESS","messageId":"msg_1753276943081_aprnjnuvt","processedCount":1,"remainingInQueue":0,"timestamp":"2025-07-23T13:22:32.238Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_ITEM_SUCCESS","flow_stage":"0_unknown","level":"SUCCESS","message_id":"msg_1753276943081_aprnjnuvt","user_id":"573003913251"} timestamp="2025-07-23T13:22:32.238Z"
2025-07-23T13:22:32.242056907Z [INFO] [LOCK_ALREADY_RELEASED] Lock ya liberado para usuario jsonPayload={"activeLocks":0,"category":"LOCK_ALREADY_RELEASED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"TRACE","timestamp":"2025-07-23T13:22:32.238Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"LOCK_ALREADY_RELEASED","flow_stage":"0_unknown","level":"TRACE","user_id":"573003913251"} timestamp="2025-07-23T13:22:32.238Z"
2025-07-23T13:22:32.242098677Z [INFO] [QUEUE_PROCESSING_COMPLETE] Cola de usuario procesada completamente jsonPayload={"averageTimePerMessage":"9157ms","category":"QUEUE_PROCESSING_COMPLETE","environment":"cloud-run","errorCount":0,"flow":{"stage":"0_unknown"},"initialQueueLength":1,"level":"SUCCESS","processedCount":1,"processingDuration":"9157ms","remainingQueues":0,"timestamp":"2025-07-23T13:22:32.238Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_PROCESSING_COMPLETE","flow_stage":"0_unknown","level":"SUCCESS","user_id":"573003913251"} timestamp="2025-07-23T13:22:32.238Z"
📨 Webhook: 1 mensajes recibidos
2025-07-23T13:22:33.080242858Z [INFO] [WEBHOOK] Procesando 1 mensajes del webhook jsonPayload={"category":"WEBHOOK","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","messageCount":1,"timestamp":"2025-07-23T13:22:33.079Z"} labels={"app":"whatsapp-bot","category":"WEBHOOK","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:22:33.079Z"
2025-07-23T13:22:36.310205930Z [INFO] [PRESENCE_EVENT] Procesando 1 eventos de presencia jsonPayload={"category":"PRESENCE_EVENT","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","presenceCount":1,"timestamp":"2025-07-23T13:22:36.294Z"} labels={"app":"whatsapp-bot","category":"PRESENCE_EVENT","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:22:36.293Z"
2025-07-23T13:22:36.310237631Z [INFO] [PRESENCE_RECEIVED] Presencia para 573003913251: typing jsonPayload={"category":"PRESENCE_RECEIVED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","status":"typing","timestamp":"2025-07-23T13:22:36.294Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"PRESENCE_RECEIVED","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:22:36.294Z"
📨 Webhook: 1 mensajes recibidos
2025-07-23T13:22:42.044838277Z [INFO] [WEBHOOK] Procesando 1 mensajes del webhook jsonPayload={"category":"WEBHOOK","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","messageCount":1,"timestamp":"2025-07-23T13:22:42.034Z"} labels={"app":"whatsapp-bot","category":"WEBHOOK","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:22:42.034Z"
2025-07-23T13:22:42.044869565Z [INFO] [MESSAGE_RECEIVED] Mensaje recibido jsonPayload={"body":"Desde hoy por 3 noches...","category":"MESSAGE_RECEIVED","chatId":"573003913251@s.whatsapp.net","environment":"cloud-run","flow":{"stage":"1_receive"},"from":"573003913251","level":"INFO","timestamp":1753276961,"type":"text","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"MESSAGE_RECEIVED","flow_stage":"1_receive","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:22:42.034Z"
📥 [BUFFER] 573003913251: "Desde hoy por 3 noches..." → ⏳ 5s...
2025-07-23T13:22:42.044910892Z [INFO] [GLOBAL_BUFFER_ADD] Mensaje agregado al buffer global jsonPayload={"bufferSize":1,"category":"GLOBAL_BUFFER_ADD","delay":5000,"environment":"cloud-run","flow":{"stage":"0_unknown"},"isMedia":false,"level":"INFO","messageText":"Desde hoy por 3 noches...","timestamp":"2025-07-23T13:22:42.034Z","userJid":"573003913251","userName":"573003913251"} labels={"app":"whatsapp-bot","category":"GLOBAL_BUFFER_ADD","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:22:42.034Z"
2025-07-23T13:22:47.043136803Z [INFO] [GLOBAL_BUFFER_PROCESS] Procesando buffer global después de 5 segundos jsonPayload={"category":"GLOBAL_BUFFER_PROCESS","combinedText":"Desde hoy por 3 noches...","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","messageCount":1,"timestamp":"2025-07-23T13:22:47.037Z","userJid":"573003913251","userName":"573003913251"} labels={"app":"whatsapp-bot","category":"GLOBAL_BUFFER_PROCESS","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:22:47.037Z"
2025-07-23T13:22:49.460277971Z [INFO] [QUEUE_ITEM_ADDED] Mensaje agregado a cola de usuario jsonPayload={"category":"QUEUE_ITEM_ADDED","environment":"cloud-run","flow":{"sequence":1,"stage":"0_unknown"},"hasActiveLock":false,"level":"INFO","messageId":"msg_1753276969452_zw4sn0o05","queueLength":1,"timestamp":"2025-07-23T13:22:49.452Z","totalQueues":1,"userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_ITEM_ADDED","flow_stage":"0_unknown","level":"INFO","message_id":"msg_1753276969452_zw4sn0o05","user_id":"573003913251"} timestamp="2025-07-23T13:22:49.452Z"
2025-07-23T13:22:49.460311642Z [INFO] [QUEUE_PROCESSING_START] Procesando cola de usuario jsonPayload={"category":"QUEUE_PROCESSING_START","environment":"cloud-run","flow":{"stage":"0_unknown"},"hasActiveLock":false,"level":"INFO","queueLength":1,"timestamp":"2025-07-23T13:22:49.452Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_PROCESSING_START","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:22:49.452Z"
2025-07-23T13:22:49.460341581Z [INFO] [QUEUE_ITEM_PROCESSING] Procesando mensaje de cola jsonPayload={"category":"QUEUE_ITEM_PROCESSING","environment":"cloud-run","flow":{"sequence":2,"stage":"0_unknown"},"level":"TRACE","messageId":"msg_1753276969452_zw4sn0o05","remainingInQueue":0,"timestamp":"2025-07-23T13:22:49.452Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_ITEM_PROCESSING","flow_stage":"0_unknown","level":"TRACE","message_id":"msg_1753276969452_zw4sn0o05","user_id":"573003913251"} timestamp="2025-07-23T13:22:49.452Z"
2025-07-23T13:22:50.055998693Z [INFO] [OPENAI_REQUEST] starting_process jsonPayload={"category":"OPENAI_REQUEST","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","timestamp":"2025-07-23T13:22:50.049Z"} labels={"app":"whatsapp-bot","category":"OPENAI_REQUEST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:22:50.049Z"
2025-07-23T13:22:50.056049455Z [INFO] [THREAD_REUSE] Thread reutilizado para 573003913251 jsonPayload={"category":"THREAD_REUSE","chatId":"573003913251@s.whatsapp.net","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:22:50.049Z","userName":"573003913251"} labels={"app":"whatsapp-bot","category":"THREAD_REUSE","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:22:50.049Z"
2025-07-23T13:22:50.056076301Z [INFO] [HISTORY_INJECTION_COMPLETED] Inyección de historial completada jsonPayload={"category":"HISTORY_INJECTION_COMPLETED","contextLength":0,"environment":"cloud-run","flow":{"stage":"0_unknown"},"historyLines":0,"labelsCount":0,"level":"SUCCESS","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:22:50.049Z","tokensUsed":0,"userId":"573003913251"} labels={"app":"whatsapp-bot","category":"HISTORY_INJECTION_COMPLETED","flow_stage":"0_unknown","level":"SUCCESS","user_id":"573003913251"} timestamp="2025-07-23T13:22:50.049Z"
2025-07-23T13:22:50.056089732Z [INFO] [HISTORY_SKIP] Skip fetch historial: Thread existe jsonPayload={"category":"HISTORY_SKIP","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","reason":"thread_already_exists","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:22:50.049Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"HISTORY_SKIP","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:22:50.049Z"
2025-07-23T13:22:50.056129590Z [INFO] [HISTORY_INJECTION_SKIP] Saltando inyección - thread existente sin necesidad de contexto jsonPayload={"category":"HISTORY_INJECTION_SKIP","environment":"cloud-run","flow":{"stage":"0_unknown"},"hasContextAnalysis":false,"isNewThread":false,"level":"INFO","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:22:50.049Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"HISTORY_INJECTION_SKIP","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:22:50.049Z"
2025-07-23T13:22:50.530370152Z [INFO] [CONTEXT_CACHE_HIT] Contexto temporal desde cache jsonPayload={"cacheAge":52,"category":"CONTEXT_CACHE_HIT","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","timestamp":"2025-07-23T13:22:50.520Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"CONTEXT_CACHE_HIT","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:22:50.520Z"
2025-07-23T13:22:50.530419008Z [INFO] [CONTEXT_DEBUG] Contexto enviado a OpenAI jsonPayload={"category":"CONTEXT_DEBUG","contextPreview":"Fecha: 23/07/2025 | Hora: 8:21 AM (Colombia)\nCliente: Sr Alex | Contacto WhatsApp: Sr Alex | Status: Colega Jefe, cotización\n---\nMensaje del cliente:\n","environment":"cloud-run","flow":{"stage":"0_unknown"},"isVoiceMessage":false,"level":"INFO","messagePreview":"Desde hoy por 3 noches","shortUserId":"573003913251","timestamp":"2025-07-23T13:22:50.520Z","totalLength":172} labels={"app":"whatsapp-bot","category":"CONTEXT_DEBUG","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:22:50.520Z"
2025-07-23T13:22:50.933046169Z [INFO] [OPENAI_REQUEST] message_added_with_context jsonPayload={"category":"OPENAI_REQUEST","contextLength":150,"environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","originalLength":22,"shortUserId":"573003913251","timestamp":"2025-07-23T13:22:50.930Z","totalLength":172} labels={"app":"whatsapp-bot","category":"OPENAI_REQUEST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:22:50.930Z"
2025-07-23T13:22:50.933076743Z [INFO] [OPENAI_REQUEST] creating_run jsonPayload={"category":"OPENAI_REQUEST","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","timestamp":"2025-07-23T13:22:50.930Z"} labels={"app":"whatsapp-bot","category":"OPENAI_REQUEST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:22:50.930Z"
2025-07-23T13:22:52.112344866Z [INFO] [OPENAI_REQUEST] run_started jsonPayload={"category":"OPENAI_REQUEST","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","timestamp":"2025-07-23T13:22:52.109Z"} labels={"app":"whatsapp-bot","category":"OPENAI_REQUEST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:22:52.109Z"
2025-07-23T13:22:54.882591981Z [INFO] [WHATSAPP_SEND] Enviando mensaje a 573003913251 jsonPayload={"category":"WHATSAPP_SEND","chatId":"573003913251@s.whatsapp.net","environment":"cloud-run","flow":{"stage":"8_send"},"level":"INFO","messageLength":54,"preview":"Permítame consultar disponibilidad en mi sistema... 🔍...","timestamp":"2025-07-23T13:22:54.879Z"} labels={"app":"whatsapp-bot","category":"WHATSAPP_SEND","flow_stage":"8_send","level":"INFO"} timestamp="2025-07-23T13:22:54.879Z"
2025-07-23T13:22:55.214Z ✅ [573003913251] Mensaje enviado
2025-07-23T13:22:55.217116782Z [INFO] [AVAILABILITY_INTERIM_SENT] Mensaje interino enviado jsonPayload={"category":"AVAILABILITY_INTERIM_SENT","chatId":"573003913251@s.whatsapp.net","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","timestamp":"2025-07-23T13:22:55.214Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"AVAILABILITY_INTERIM_SENT","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:22:55.214Z"
2025-07-23T13:22:55.217154767Z [INFO] [FUNCTION_CALLING_START] function_calling_required jsonPayload={"category":"FUNCTION_CALLING_START","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","runId":"run_6SQFq37CZ8uy6X8Qgqwe5cHS","shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:22:55.214Z","toolCallsCount":1} labels={"app":"whatsapp-bot","category":"FUNCTION_CALLING_START","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:22:55.214Z"
2025-07-23T13:22:55.217195882Z [INFO] [FUNCTION_EXECUTING] function_executing jsonPayload={"args":{"endDate":"2025-07-26","startDate":"2025-07-23"},"category":"FUNCTION_EXECUTING","environment":"cloud-run","flow":{"stage":"0_unknown"},"functionName":"check_availability","level":"INFO","shortUserId":"573003913251","timestamp":"2025-07-23T13:22:55.214Z","toolCallId":"call_kVM0a5Dqz9MBw1YF8iF0zKA7"} labels={"app":"whatsapp-bot","category":"FUNCTION_EXECUTING","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:22:55.214Z"
2025-07-23T13:22:55.229930495Z [INFO] [BEDS24_REQUEST] Procesando consulta de disponibilidad jsonPayload={"category":"BEDS24_REQUEST","dateAdjusted":false,"endDate":"2025-07-26","environment":"cloud-run","flow":{"stage":"4_beds_request"},"hasSpecificProperty":false,"hasSpecificRoom":false,"level":"INFO","maxTransfers":3,"nights":3,"originalEndDate":"2025-07-26","originalStartDate":"2025-07-23","propertyId":null,"requestType":"availability_check","roomId":null,"startDate":"2025-07-23","timestamp":"2025-07-23T13:22:55.227Z"} labels={"app":"whatsapp-bot","category":"BEDS24_REQUEST","flow_stage":"4_beds_request","level":"INFO"} timestamp="2025-07-23T13:22:55.227Z"
2025-07-23T13:22:55.229981310Z [INFO] [AVAILABILITY_HANDLER] Procesando consulta de disponibilidad jsonPayload={"category":"AVAILABILITY_HANDLER","dateAdjusted":false,"endDate":"2025-07-26","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","propertyId":null,"roomId":null,"startDate":"2025-07-23","timestamp":"2025-07-23T13:22:55.228Z"} labels={"app":"whatsapp-bot","category":"AVAILABILITY_HANDLER","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:22:55.228Z"
2025-07-23T13:22:55.230027498Z [INFO] [BEDS24_CACHE_MISS] Cache de disponibilidad no encontrado o expirado jsonPayload={"cacheKey":"availability_2025-07-23_2025-07-26_any_any","category":"BEDS24_CACHE_MISS","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","timestamp":"2025-07-23T13:22:55.228Z"} labels={"app":"whatsapp-bot","category":"BEDS24_CACHE_MISS","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:22:55.228Z"
2025-07-23T13:22:55.230072563Z [INFO] [BEDS24_PROCESSING] Calculando noches de estadía jsonPayload={"category":"BEDS24_PROCESSING","dateCalculation":"stay_nights_only","endDate":"2025-07-26","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","nightsRange":["2025-07-23","2025-07-24","2025-07-25"],"startDate":"2025-07-23","timestamp":"2025-07-23T13:22:55.229Z","totalNights":3} labels={"app":"whatsapp-bot","category":"BEDS24_PROCESSING","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:22:55.229Z"
2025-07-23T13:22:55.776729111Z [INFO] [BEDS24_API_CALL] Consulta optimizada a Beds24 (solo calendar) jsonPayload={"category":"BEDS24_API_CALL","dateRange":"2025-07-23 - 2025-07-26","endpoint":"inventory/rooms/calendar","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","method":"GET","nightsCalculated":3,"optimization":"single-endpoint","parameters":{"endDate":"2025-07-26","includeMaxStay":true,"includeMinStay":true,"includeMultiplier":true,"includeNumAvail":true,"includeOverride":true,"includePrices":true,"startDate":"2025-07-23"},"success":true,"timestamp":"2025-07-23T13:22:55.773Z","totalProperties":7} labels={"app":"whatsapp-bot","category":"BEDS24_API_CALL","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:22:55.773Z"
2025-07-23T13:22:55.776779593Z [INFO] [BEDS24_RESPONSE_DETAIL] Respuesta cruda de Beds24 API jsonPayload={"category":"BEDS24_RESPONSE_DETAIL","environment":"cloud-run","firstRoom":{"calendarEntries":4,"name":"Apartamento 2005-A","propertyId":173207,"roomId":378110,"sampleEntry":{"from":"2025-07-23","maxStay":365,"minStay":3,"multiplier":1,"numAvail":0,"override":"none","price1":175000,"to":"2025-07-23"}},"flow":{"stage":"0_unknown"},"level":"INFO","responseSize":2947,"responseStructure":["roomId","propertyId","name","calendar"],"success":true,"timestamp":"2025-07-23T13:22:55.773Z","totalRooms":7} labels={"app":"whatsapp-bot","category":"BEDS24_RESPONSE_DETAIL","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:22:55.773Z"
2025-07-23T13:22:55.776813031Z [INFO] [BEDS24_DATA_MAPPING] Procesando datos de Beds24 jsonPayload={"beds24DataCount":7,"category":"BEDS24_DATA_MAPPING","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","originalEndDate":"2025-07-26","originalStartDate":"2025-07-23","timestamp":"2025-07-23T13:22:55.774Z"} labels={"app":"whatsapp-bot","category":"BEDS24_DATA_MAPPING","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:22:55.774Z"
2025-07-23T13:22:55.776874667Z [INFO] [BEDS24_CLASSIFICATION] Propiedades clasificadas jsonPayload={"category":"BEDS24_CLASSIFICATION","completeOptions":3,"environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","nightsAnalyzed":3,"partialOptions":2,"timestamp":"2025-07-23T13:22:55.774Z","willGenerateSplits":false} labels={"app":"whatsapp-bot","category":"BEDS24_CLASSIFICATION","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:22:55.774Z"
2025-07-23T13:22:55.776947147Z [INFO] [BEDS24_RESPONSE_SUMMARY] Encontradas 3 opciones completas y 0 opciones con traslado jsonPayload={"category":"BEDS24_RESPONSE_SUMMARY","completeOptionsDetail":[{"pricePerNight":175000,"propertyName":"Apartamento 1820","totalPrice":525000},{"pricePerNight":155000,"propertyName":"1722-B","totalPrice":465000},{"pricePerNight":175000,"propertyName":"Apartamento 1722-A","totalPrice":525000}],"dateRange":"2025-07-23 al 2025-07-26","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","splitOptionsDetail":[],"timestamp":"2025-07-23T13:22:55.775Z","totalNights":3} labels={"app":"whatsapp-bot","category":"BEDS24_RESPONSE_SUMMARY","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:22:55.775Z"
2025-07-23T13:22:55.776970946Z [INFO] [BEDS24_RESPONSE_DETAIL] Respuesta completa de Beds24 enviada a OpenAI jsonPayload={"category":"BEDS24_RESPONSE_DETAIL","completeOptionsCount":3,"environment":"cloud-run","estimatedTokens":103,"flow":{"stage":"0_unknown"},"fullResponse":"{\"dateRange\":\"2025-07-23 al 2025-07-26\",\"totalNights\":3,\"completeOptions\":[{\"propertyName\":\"Apartamento 1820\",\"totalPrice\":525000,\"pricePerNight\":175000},{\"propertyName\":\"1722-B\",\"totalPrice\":465000,\"pricePerNight\":155000},{\"propertyName\":\"Apartamento 1722-A\",\"totalPrice\":525000,\"pricePerNight\":175000}],\"splitOptions\":[],\"hasCompleteOptions\":true,\"hasSplitOptions\":false,\"timestamp\":\"2025-07-23T13:22:55.775Z\"}","hasCompleteOptions":true,"hasSplitOptions":false,"level":"INFO","responseLength":412,"responsePreview":"{\"dateRange\":\"2025-07-23 al 2025-07-26\",\"totalNights\":3,\"completeOptions\":[{\"propertyName\":\"Apartamento 1820\",\"totalPrice\":525000,\"pricePerNight\":175000},{\"propertyName\":\"1722-B\",\"totalPrice\":465000,\"...","splitOptionsCount":0,"timestamp":"2025-07-23T13:22:55.775Z","totalNights":3} labels={"app":"whatsapp-bot","category":"BEDS24_RESPONSE_DETAIL","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:22:55.775Z"
2025-07-23T13:22:55.776992385Z [INFO] [BEDS24_DEBUG_OUTPUT] Respuesta formateada para OpenAI jsonPayload={"category":"BEDS24_DEBUG_OUTPUT","environment":"cloud-run","flow":{"stage":"0_unknown"},"hasCompleteOptions":true,"hasSplitOptions":false,"level":"INFO","responseLength":412,"responsePreview":"{\"dateRange\":\"2025-07-23 al 2025-07-26\",\"totalNights\":3,\"completeOptions\":[{\"propertyName\":\"Apartamento 1820\",\"totalPrice\":525000,\"pricePerNight\":175000},{\"propertyName\":\"1722-B\",\"totalPrice\":465000,\"","timestamp":"2025-07-23T13:22:55.775Z"} labels={"app":"whatsapp-bot","category":"BEDS24_DEBUG_OUTPUT","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:22:55.775Z"
2025-07-23T13:22:55.777029923Z [INFO] [AVAILABILITY_HANDLER] Consulta completada exitosamente jsonPayload={"apiResponseSize":771,"category":"AVAILABILITY_HANDLER","completeOptions":3,"dateAdjusted":false,"dateRange":"2025-07-23 a 2025-07-26","environment":"cloud-run","flow":{"stage":"0_unknown"},"isEfficient":true,"level":"SUCCESS","processingMs":548,"responseSize":771,"splitOptions":0,"timestamp":"2025-07-23T13:22:55.776Z"} labels={"app":"whatsapp-bot","category":"AVAILABILITY_HANDLER","flow_stage":"0_unknown","level":"SUCCESS"} timestamp="2025-07-23T13:22:55.775Z"
2025-07-23T13:22:55.777080747Z [INFO] [FUNCTION_HANDLER] function_success jsonPayload={"category":"FUNCTION_HANDLER","environment":"cloud-run","flow":{"stage":"0_unknown"},"functionName":"check_availability","level":"INFO","resultLength":412,"shortUserId":"573003913251","status":"success","timestamp":"2025-07-23T13:22:55.776Z","toolCallId":"call_kVM0a5Dqz9MBw1YF8iF0zKA7"} labels={"app":"whatsapp-bot","category":"FUNCTION_HANDLER","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:22:55.776Z"
📨 Webhook: 1 mensajes recibidos
2025-07-23T13:22:56.134263045Z [INFO] [WEBHOOK] Procesando 1 mensajes del webhook jsonPayload={"category":"WEBHOOK","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","messageCount":1,"timestamp":"2025-07-23T13:22:56.131Z"} labels={"app":"whatsapp-bot","category":"WEBHOOK","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:22:56.131Z"
2025-07-23T13:22:56.731414287Z [INFO] [TOOL_OUTPUTS_SUBMITTED] Tool outputs enviados a OpenAI jsonPayload={"category":"TOOL_OUTPUTS_SUBMITTED","environment":"cloud-run","flow":{"stage":"6_ai_request"},"level":"INFO","outputs":[{"id":"call_kVM0a5Dqz9MBw1YF8iF0zKA7","outputLength":412,"outputPreview":"{\"dateRange\":\"2025-07-23 al 2025-07-26\",\"totalNights\":3,\"completeOptions\":[{\"propertyName\":\"Apartame..."}],"runId":"run_6SQFq37CZ8uy6X8Qgqwe5cHS","shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:22:56.728Z","totalOutputs":1} labels={"app":"whatsapp-bot","category":"TOOL_OUTPUTS_SUBMITTED","flow_stage":"6_ai_request","level":"INFO"} timestamp="2025-07-23T13:22:56.728Z"
2025-07-23T13:22:56.731451525Z [INFO] [POST_SUBMIT_STATUS] Status después de submit tool outputs jsonPayload={"category":"POST_SUBMIT_STATUS","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","runId":"run_6SQFq37CZ8uy6X8Qgqwe5cHS","runStatus":"requires_action","shortUserId":"573003913251","timestamp":"2025-07-23T13:22:56.729Z"} labels={"app":"whatsapp-bot","category":"POST_SUBMIT_STATUS","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:22:56.729Z"
2025-07-23T13:22:58.006278860Z [INFO] [POST_TOOL_POLLING] Polling post-tool - Intento 1/5 jsonPayload={"attempt":1,"category":"POST_TOOL_POLLING","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","runId":"run_6SQFq37CZ8uy6X8Qgqwe5cHS","shortUserId":"573003913251","status":"in_progress","timestamp":"2025-07-23T13:22:58.004Z"} labels={"app":"whatsapp-bot","category":"POST_TOOL_POLLING","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:22:58.004Z"
2025-07-23T13:22:59.300680438Z [INFO] [POST_TOOL_POLLING] Polling post-tool - Intento 2/5 jsonPayload={"attempt":2,"category":"POST_TOOL_POLLING","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","runId":"run_6SQFq37CZ8uy6X8Qgqwe5cHS","shortUserId":"573003913251","status":"in_progress","timestamp":"2025-07-23T13:22:59.295Z"} labels={"app":"whatsapp-bot","category":"POST_TOOL_POLLING","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:22:59.295Z"
2025-07-23T13:23:01.573667532Z [INFO] [POST_TOOL_POLLING] Polling post-tool - Intento 3/5 jsonPayload={"attempt":3,"category":"POST_TOOL_POLLING","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","runId":"run_6SQFq37CZ8uy6X8Qgqwe5cHS","shortUserId":"573003913251","status":"completed","timestamp":"2025-07-23T13:23:01.564Z"} labels={"app":"whatsapp-bot","category":"POST_TOOL_POLLING","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:23:01.564Z"
2025-07-23T13:23:01.573701987Z [INFO] [POST_TOOL_POLLING_COMPLETE] Polling post-tool completado jsonPayload={"attempts":2,"category":"POST_TOOL_POLLING_COMPLETE","environment":"cloud-run","finalStatus":"completed","flow":{"stage":"0_unknown"},"level":"INFO","runId":"run_6SQFq37CZ8uy6X8Qgqwe5cHS","shortUserId":"573003913251","timestamp":"2025-07-23T13:23:01.564Z"} labels={"app":"whatsapp-bot","category":"POST_TOOL_POLLING_COMPLETE","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:23:01.564Z"
2025-07-23T13:23:01.751587664Z [INFO] [FUNCTION_CALLING_RESPONSE] Respuesta final recibida después de function calling jsonPayload={"category":"FUNCTION_CALLING_RESPONSE","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"SUCCESS","responseLength":355,"shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:23:01.743Z","toolCallsExecuted":1} labels={"app":"whatsapp-bot","category":"FUNCTION_CALLING_RESPONSE","flow_stage":"0_unknown","level":"SUCCESS"} timestamp="2025-07-23T13:23:01.743Z"
✅ [TOOL_SUCCESS] Respuesta recibida después de 1 tool calls
2025-07-23T13:23:01.751660939Z [INFO] [WHATSAPP_SEND_CHUNKS] Enviando mensaje en 3 partes a 573003913251 jsonPayload={"category":"WHATSAPP_SEND_CHUNKS","chatId":"573003913251@s.whatsapp.net","chunks":3,"environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","timestamp":"2025-07-23T13:23:01.743Z","totalLength":355} labels={"app":"whatsapp-bot","category":"WHATSAPP_SEND_CHUNKS","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:23:01.743Z"
2025-07-23T13:23:02.095Z ✅ [573003913251] Parte 1/3 enviada
2025-07-23T13:23:02.443Z ✅ [573003913251] Parte 2/3 enviada
📨 Webhook: 1 mensajes recibidos
2025-07-23T13:23:02.637932126Z [INFO] [WEBHOOK] Procesando 1 mensajes del webhook jsonPayload={"category":"WEBHOOK","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","messageCount":1,"timestamp":"2025-07-23T13:23:02.634Z"} labels={"app":"whatsapp-bot","category":"WEBHOOK","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:23:02.634Z"
2025-07-23T13:23:03.007Z ✅ [573003913251] Parte 3/3 enviada
2025-07-23T13:23:03.008556692Z [INFO] [QUEUE_ITEM_SUCCESS] Mensaje procesado exitosamente jsonPayload={"category":"QUEUE_ITEM_SUCCESS","environment":"cloud-run","flow":{"sequence":3,"stage":"0_unknown"},"level":"SUCCESS","messageId":"msg_1753276969452_zw4sn0o05","processedCount":1,"remainingInQueue":0,"timestamp":"2025-07-23T13:23:03.007Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_ITEM_SUCCESS","flow_stage":"0_unknown","level":"SUCCESS","message_id":"msg_1753276969452_zw4sn0o05","user_id":"573003913251"} timestamp="2025-07-23T13:23:03.007Z"
2025-07-23T13:23:03.008563778Z [INFO] [QUEUE_PROCESSING_COMPLETE] Cola de usuario procesada completamente jsonPayload={"averageTimePerMessage":"13555ms","category":"QUEUE_PROCESSING_COMPLETE","environment":"cloud-run","errorCount":0,"flow":{"stage":"0_unknown"},"initialQueueLength":1,"level":"SUCCESS","processedCount":1,"processingDuration":"13555ms","remainingQueues":0,"timestamp":"2025-07-23T13:23:03.007Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_PROCESSING_COMPLETE","flow_stage":"0_unknown","level":"SUCCESS","user_id":"573003913251"} timestamp="2025-07-23T13:23:03.007Z"
2025-07-23T13:23:03.008599378Z [INFO] [LOCK_ALREADY_RELEASED] Lock ya liberado para usuario jsonPayload={"activeLocks":0,"category":"LOCK_ALREADY_RELEASED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"TRACE","timestamp":"2025-07-23T13:23:03.007Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"LOCK_ALREADY_RELEASED","flow_stage":"0_unknown","level":"TRACE","user_id":"573003913251"} timestamp="2025-07-23T13:23:03.007Z"
📨 Webhook: 1 mensajes recibidos
2025-07-23T13:23:03.012210763Z [INFO] [WEBHOOK] Procesando 1 mensajes del webhook jsonPayload={"category":"WEBHOOK","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","messageCount":1,"timestamp":"2025-07-23T13:23:03.009Z"} labels={"app":"whatsapp-bot","category":"WEBHOOK","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:23:03.009Z"
📨 Webhook: 1 mensajes recibidos
2025-07-23T13:23:03.468086939Z [INFO] [WEBHOOK] Procesando 1 mensajes del webhook jsonPayload={"category":"WEBHOOK","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","messageCount":1,"timestamp":"2025-07-23T13:23:03.460Z"} labels={"app":"whatsapp-bot","category":"WEBHOOK","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:23:03.460Z"
2025-07-23T13:23:07.636277967Z [INFO] [PRESENCE_EVENT] Procesando 1 eventos de presencia jsonPayload={"category":"PRESENCE_EVENT","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","presenceCount":1,"timestamp":"2025-07-23T13:23:07.633Z"} labels={"app":"whatsapp-bot","category":"PRESENCE_EVENT","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:23:07.633Z"
2025-07-23T13:23:07.636324480Z [INFO] [PRESENCE_RECEIVED] Presencia para 573003913251: typing jsonPayload={"category":"PRESENCE_RECEIVED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","status":"typing","timestamp":"2025-07-23T13:23:07.633Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"PRESENCE_RECEIVED","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:23:07.633Z"
2025-07-23T13:23:10.608816270Z [INFO] [PRESENCE_EVENT] Procesando 1 eventos de presencia jsonPayload={"category":"PRESENCE_EVENT","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","presenceCount":1,"timestamp":"2025-07-23T13:23:10.606Z"} labels={"app":"whatsapp-bot","category":"PRESENCE_EVENT","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:23:10.606Z"
2025-07-23T13:23:10.608862032Z [INFO] [PRESENCE_RECEIVED] Presencia para 573003913251: online jsonPayload={"category":"PRESENCE_RECEIVED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","status":"online","timestamp":"2025-07-23T13:23:10.606Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"PRESENCE_RECEIVED","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:23:10.606Z"
2025-07-23T13:23:10.814872989Z [INFO] [PRESENCE_EVENT] Procesando 1 eventos de presencia jsonPayload={"category":"PRESENCE_EVENT","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","presenceCount":1,"timestamp":"2025-07-23T13:23:10.812Z"} labels={"app":"whatsapp-bot","category":"PRESENCE_EVENT","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:23:10.812Z"
2025-07-23T13:23:10.814925358Z [INFO] [PRESENCE_RECEIVED] Presencia para 573003913251: typing jsonPayload={"category":"PRESENCE_RECEIVED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","status":"typing","timestamp":"2025-07-23T13:23:10.812Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"PRESENCE_RECEIVED","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:23:10.812Z"
2025-07-23T13:23:14.969003900Z [INFO] [PRESENCE_EVENT] Procesando 1 eventos de presencia jsonPayload={"category":"PRESENCE_EVENT","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","presenceCount":1,"timestamp":"2025-07-23T13:23:14.967Z"} labels={"app":"whatsapp-bot","category":"PRESENCE_EVENT","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:23:14.967Z"
2025-07-23T13:23:14.969043668Z [INFO] [PRESENCE_RECEIVED] Presencia para 573003913251: typing jsonPayload={"category":"PRESENCE_RECEIVED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","status":"typing","timestamp":"2025-07-23T13:23:14.967Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"PRESENCE_RECEIVED","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:23:14.967Z"
📨 Webhook: 1 mensajes recibidos
2025-07-23T13:23:15.014476572Z [INFO] [WEBHOOK] Procesando 1 mensajes del webhook jsonPayload={"category":"WEBHOOK","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","messageCount":1,"timestamp":"2025-07-23T13:23:15.013Z"} labels={"app":"whatsapp-bot","category":"WEBHOOK","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:23:15.013Z"
2025-07-23T13:23:15.014516650Z [INFO] [MESSAGE_RECEIVED] Mensaje recibido jsonPayload={"body":"Si tienes fotos...","category":"MESSAGE_RECEIVED","chatId":"573003913251@s.whatsapp.net","environment":"cloud-run","flow":{"stage":"1_receive"},"from":"573003913251","level":"INFO","timestamp":1753276994,"type":"text","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"MESSAGE_RECEIVED","flow_stage":"1_receive","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:23:15.013Z"
📥 [BUFFER] 573003913251: "Si tienes fotos..." → ⏳ 5s...
2025-07-23T13:23:15.014578980Z [INFO] [GLOBAL_BUFFER_ADD] Mensaje agregado al buffer global jsonPayload={"bufferSize":1,"category":"GLOBAL_BUFFER_ADD","delay":5000,"environment":"cloud-run","flow":{"stage":"0_unknown"},"isMedia":false,"level":"INFO","messageText":"Si tienes fotos...","timestamp":"2025-07-23T13:23:15.013Z","userJid":"573003913251","userName":"573003913251"} labels={"app":"whatsapp-bot","category":"GLOBAL_BUFFER_ADD","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:23:15.013Z"
📨 Webhook: 1 mensajes recibidos
2025-07-23T13:23:18.893383299Z [INFO] [WEBHOOK] Procesando 1 mensajes del webhook jsonPayload={"category":"WEBHOOK","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","messageCount":1,"timestamp":"2025-07-23T13:23:18.890Z"} labels={"app":"whatsapp-bot","category":"WEBHOOK","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:23:18.890Z"
2025-07-23T13:23:18.893421093Z [INFO] [MESSAGE_RECEIVED] Mensaje recibido jsonPayload={"body":"?...","category":"MESSAGE_RECEIVED","chatId":"573003913251@s.whatsapp.net","environment":"cloud-run","flow":{"stage":"1_receive"},"from":"573003913251","level":"INFO","timestamp":1753276994,"type":"text","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"MESSAGE_RECEIVED","flow_stage":"1_receive","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:23:18.890Z"
📥 [BUFFER] 573003913251: "?..." → ⏳ 5s...
2025-07-23T13:23:18.893471275Z [INFO] [GLOBAL_BUFFER_ADD] Mensaje agregado al buffer global jsonPayload={"bufferSize":2,"category":"GLOBAL_BUFFER_ADD","delay":5000,"environment":"cloud-run","flow":{"stage":"0_unknown"},"isMedia":false,"level":"INFO","messageText":"?...","timestamp":"2025-07-23T13:23:18.890Z","userJid":"573003913251","userName":"573003913251"} labels={"app":"whatsapp-bot","category":"GLOBAL_BUFFER_ADD","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:23:18.890Z"
2025-07-23T13:23:23.897250642Z [INFO] [GLOBAL_BUFFER_PROCESS] Procesando buffer global después de 5 segundos jsonPayload={"category":"GLOBAL_BUFFER_PROCESS","combinedText":"Si tienes fotos ?...","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","messageCount":2,"timestamp":"2025-07-23T13:23:23.891Z","userJid":"573003913251","userName":"573003913251"} labels={"app":"whatsapp-bot","category":"GLOBAL_BUFFER_PROCESS","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:23:23.891Z"
2025-07-23T13:23:25.001482025Z [INFO] [QUEUE_ITEM_ADDED] Mensaje agregado a cola de usuario jsonPayload={"category":"QUEUE_ITEM_ADDED","environment":"cloud-run","flow":{"sequence":1,"stage":"0_unknown"},"hasActiveLock":false,"level":"INFO","messageId":"msg_1753277004997_w9ywy9qn1","queueLength":1,"timestamp":"2025-07-23T13:23:24.997Z","totalQueues":1,"userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_ITEM_ADDED","flow_stage":"0_unknown","level":"INFO","message_id":"msg_1753277004997_w9ywy9qn1","user_id":"573003913251"} timestamp="2025-07-23T13:23:24.997Z"
2025-07-23T13:23:25.001521069Z [INFO] [QUEUE_PROCESSING_START] Procesando cola de usuario jsonPayload={"category":"QUEUE_PROCESSING_START","environment":"cloud-run","flow":{"stage":"0_unknown"},"hasActiveLock":false,"level":"INFO","queueLength":1,"timestamp":"2025-07-23T13:23:24.998Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_PROCESSING_START","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:23:24.998Z"
2025-07-23T13:23:25.001562480Z [INFO] [QUEUE_ITEM_PROCESSING] Procesando mensaje de cola jsonPayload={"category":"QUEUE_ITEM_PROCESSING","environment":"cloud-run","flow":{"sequence":2,"stage":"0_unknown"},"level":"TRACE","messageId":"msg_1753277004997_w9ywy9qn1","remainingInQueue":0,"timestamp":"2025-07-23T13:23:24.998Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_ITEM_PROCESSING","flow_stage":"0_unknown","level":"TRACE","message_id":"msg_1753277004997_w9ywy9qn1","user_id":"573003913251"} timestamp="2025-07-23T13:23:24.998Z"
2025-07-23T13:23:25.569735127Z [INFO] [OPENAI_REQUEST] starting_process jsonPayload={"category":"OPENAI_REQUEST","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","timestamp":"2025-07-23T13:23:25.565Z"} labels={"app":"whatsapp-bot","category":"OPENAI_REQUEST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:23:25.565Z"
2025-07-23T13:23:25.569770034Z [INFO] [HISTORY_INJECTION_COMPLETED] Inyección de historial completada jsonPayload={"category":"HISTORY_INJECTION_COMPLETED","contextLength":0,"environment":"cloud-run","flow":{"stage":"0_unknown"},"historyLines":0,"labelsCount":0,"level":"SUCCESS","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:23:25.565Z","tokensUsed":0,"userId":"573003913251"} labels={"app":"whatsapp-bot","category":"HISTORY_INJECTION_COMPLETED","flow_stage":"0_unknown","level":"SUCCESS","user_id":"573003913251"} timestamp="2025-07-23T13:23:25.565Z"
2025-07-23T13:23:25.569806221Z [INFO] [THREAD_REUSE] Thread reutilizado para 573003913251 jsonPayload={"category":"THREAD_REUSE","chatId":"573003913251@s.whatsapp.net","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:23:25.565Z","userName":"573003913251"} labels={"app":"whatsapp-bot","category":"THREAD_REUSE","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:23:25.565Z"
2025-07-23T13:23:25.569866659Z [INFO] [HISTORY_SKIP] Skip fetch historial: Thread existe jsonPayload={"category":"HISTORY_SKIP","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","reason":"thread_already_exists","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:23:25.565Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"HISTORY_SKIP","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:23:25.565Z"
2025-07-23T13:23:25.569925400Z [INFO] [HISTORY_INJECTION_SKIP] Saltando inyección - thread existente sin necesidad de contexto jsonPayload={"category":"HISTORY_INJECTION_SKIP","environment":"cloud-run","flow":{"stage":"0_unknown"},"hasContextAnalysis":false,"isNewThread":false,"level":"INFO","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:23:25.565Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"HISTORY_INJECTION_SKIP","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:23:25.565Z"
2025-07-23T13:23:26.281883954Z [INFO] [CONTEXT_CACHE_HIT] Contexto temporal desde cache jsonPayload={"cacheAge":88,"category":"CONTEXT_CACHE_HIT","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","timestamp":"2025-07-23T13:23:26.280Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"CONTEXT_CACHE_HIT","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:23:26.280Z"
2025-07-23T13:23:26.281937058Z [INFO] [CONTEXT_DEBUG] Contexto enviado a OpenAI jsonPayload={"category":"CONTEXT_DEBUG","contextPreview":"Fecha: 23/07/2025 | Hora: 8:21 AM (Colombia)\nCliente: Sr Alex | Contacto WhatsApp: Sr Alex | Status: Colega Jefe, cotización\n---\nMensaje del cliente:\n","environment":"cloud-run","flow":{"stage":"0_unknown"},"isVoiceMessage":false,"level":"INFO","messagePreview":"Si tienes fotos ?","shortUserId":"573003913251","timestamp":"2025-07-23T13:23:26.280Z","totalLength":167} labels={"app":"whatsapp-bot","category":"CONTEXT_DEBUG","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:23:26.280Z"
2025-07-23T13:23:26.654825063Z [INFO] [OPENAI_REQUEST] message_added_with_context jsonPayload={"category":"OPENAI_REQUEST","contextLength":150,"environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","originalLength":17,"shortUserId":"573003913251","timestamp":"2025-07-23T13:23:26.654Z","totalLength":167} labels={"app":"whatsapp-bot","category":"OPENAI_REQUEST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:23:26.654Z"
2025-07-23T13:23:26.654862036Z [INFO] [OPENAI_REQUEST] creating_run jsonPayload={"category":"OPENAI_REQUEST","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","timestamp":"2025-07-23T13:23:26.654Z"} labels={"app":"whatsapp-bot","category":"OPENAI_REQUEST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:23:26.654Z"
2025-07-23T13:23:27.891772728Z [INFO] [OPENAI_REQUEST] run_started jsonPayload={"category":"OPENAI_REQUEST","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","timestamp":"2025-07-23T13:23:27.887Z"} labels={"app":"whatsapp-bot","category":"OPENAI_REQUEST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:23:27.887Z"
2025-07-23T13:23:35.311007385Z [INFO] [OPENAI_RUN_COMPLETED] Run completado para 573003913251 jsonPayload={"category":"OPENAI_RUN_COMPLETED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"SUCCESS","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:23:35.306Z"} labels={"app":"whatsapp-bot","category":"OPENAI_RUN_COMPLETED","flow_stage":"0_unknown","level":"SUCCESS"} timestamp="2025-07-23T13:23:35.306Z"
2025-07-23T13:23:35.311051812Z [INFO] [TOKEN_USAGE] Tokens utilizados jsonPayload={"category":"TOKEN_USAGE","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:23:35.306Z","totalTokens":2240} labels={"app":"whatsapp-bot","category":"TOKEN_USAGE","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:23:35.306Z"
2025-07-23T13:23:35.311102620Z [INFO] [OPENAI_USAGE] Run completado con métricas jsonPayload={"category":"OPENAI_USAGE","completionTokens":121,"contextTokens":0,"durationMs":9741,"environment":"cloud-run","flow":{"stage":"6_ai_request"},"level":"INFO","promptTokens":2119,"runId":"run_osl1gJ0vvw6AwTor0axw0UbB","shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:23:35.307Z","tokensPerSecond":230,"totalTokens":2240} labels={"app":"whatsapp-bot","category":"OPENAI_USAGE","flow_stage":"6_ai_request","level":"INFO"} timestamp="2025-07-23T13:23:35.307Z"
2025-07-23T13:23:35.311140284Z [INFO] [OPENAI_LATENCY] Latencia del procesamiento jsonPayload={"category":"OPENAI_LATENCY","durationSeconds":"9.74","environment":"cloud-run","flow":{"stage":"6_ai_request"},"isHighLatency":false,"level":"INFO","shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:23:35.307Z","totalDurationMs":9741} labels={"app":"whatsapp-bot","category":"OPENAI_LATENCY","flow_stage":"6_ai_request","level":"INFO"} timestamp="2025-07-23T13:23:35.307Z"
2025-07-23T13:23:35.546355156Z [INFO] [OPENAI_RESPONSE] response_received jsonPayload={"category":"OPENAI_RESPONSE","environment":"cloud-run","flow":{"stage":"7_ai_response"},"level":"INFO","responseLength":353,"shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:23:35.543Z"} labels={"app":"whatsapp-bot","category":"OPENAI_RESPONSE","flow_stage":"7_ai_response","level":"INFO"} timestamp="2025-07-23T13:23:35.543Z"
2025-07-23T13:23:35.546387410Z [INFO] [PERFORMANCE_METRICS] Procesamiento completado exitosamente jsonPayload={"category":"PERFORMANCE_METRICS","contextTokens":0,"environment":"cloud-run","flow":{"stage":"9_complete"},"isEfficient":false,"level":"INFO","memory":{"heapTotalMB":31,"heapUsedMB":30,"rssMB":86},"responseLength":353,"shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:23:35.543Z","tokensPerSecond":224,"totalDurationMs":9978,"totalTokens":2240} labels={"app":"whatsapp-bot","category":"PERFORMANCE_METRICS","flow_stage":"9_complete","level":"INFO"} timestamp="2025-07-23T13:23:35.543Z"
2025-07-23T13:23:35.546411949Z [INFO] [WHATSAPP_SEND_CHUNKS] Enviando mensaje en 3 partes a 573003913251 jsonPayload={"category":"WHATSAPP_SEND_CHUNKS","chatId":"573003913251@s.whatsapp.net","chunks":3,"environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","timestamp":"2025-07-23T13:23:35.544Z","totalLength":353} labels={"app":"whatsapp-bot","category":"WHATSAPP_SEND_CHUNKS","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:23:35.544Z"
2025-07-23T13:23:36.039Z ✅ [573003913251] Parte 1/3 enviada
📨 Webhook: 1 mensajes recibidos
2025-07-23T13:23:36.908162087Z [INFO] [WEBHOOK] Procesando 1 mensajes del webhook jsonPayload={"category":"WEBHOOK","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","messageCount":1,"timestamp":"2025-07-23T13:23:36.903Z"} labels={"app":"whatsapp-bot","category":"WEBHOOK","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:23:36.903Z"
2025-07-23T13:23:38.370Z ✅ [573003913251] Parte 2/3 enviada
📨 Webhook: 1 mensajes recibidos
2025-07-23T13:23:38.918143628Z [INFO] [WEBHOOK] Procesando 1 mensajes del webhook jsonPayload={"category":"WEBHOOK","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","messageCount":1,"timestamp":"2025-07-23T13:23:38.910Z"} labels={"app":"whatsapp-bot","category":"WEBHOOK","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:23:38.910Z"
2025-07-23T13:23:39.270Z ✅ [573003913251] Parte 3/3 enviada
2025-07-23T13:23:39.272368065Z [INFO] [QUEUE_ITEM_SUCCESS] Mensaje procesado exitosamente jsonPayload={"category":"QUEUE_ITEM_SUCCESS","environment":"cloud-run","flow":{"sequence":3,"stage":"0_unknown"},"level":"SUCCESS","messageId":"msg_1753277004997_w9ywy9qn1","processedCount":1,"remainingInQueue":0,"timestamp":"2025-07-23T13:23:39.270Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_ITEM_SUCCESS","flow_stage":"0_unknown","level":"SUCCESS","message_id":"msg_1753277004997_w9ywy9qn1","user_id":"573003913251"} timestamp="2025-07-23T13:23:39.270Z"
2025-07-23T13:23:39.272403731Z [INFO] [LOCK_ALREADY_RELEASED] Lock ya liberado para usuario jsonPayload={"activeLocks":0,"category":"LOCK_ALREADY_RELEASED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"TRACE","timestamp":"2025-07-23T13:23:39.270Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"LOCK_ALREADY_RELEASED","flow_stage":"0_unknown","level":"TRACE","user_id":"573003913251"} timestamp="2025-07-23T13:23:39.270Z"
2025-07-23T13:23:39.272452747Z [INFO] [QUEUE_PROCESSING_COMPLETE] Cola de usuario procesada completamente jsonPayload={"averageTimePerMessage":"14272ms","category":"QUEUE_PROCESSING_COMPLETE","environment":"cloud-run","errorCount":0,"flow":{"stage":"0_unknown"},"initialQueueLength":1,"level":"SUCCESS","processedCount":1,"processingDuration":"14272ms","remainingQueues":0,"timestamp":"2025-07-23T13:23:39.270Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_PROCESSING_COMPLETE","flow_stage":"0_unknown","level":"SUCCESS","user_id":"573003913251"} timestamp="2025-07-23T13:23:39.270Z"
📨 Webhook: 1 mensajes recibidos
2025-07-23T13:23:39.865409248Z [INFO] [WEBHOOK] Procesando 1 mensajes del webhook jsonPayload={"category":"WEBHOOK","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","messageCount":1,"timestamp":"2025-07-23T13:23:39.847Z"} labels={"app":"whatsapp-bot","category":"WEBHOOK","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:23:39.847Z"
2025-07-23T13:23:44.523607850Z [INFO] [PRESENCE_EVENT] Procesando 1 eventos de presencia jsonPayload={"category":"PRESENCE_EVENT","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","presenceCount":1,"timestamp":"2025-07-23T13:23:44.504Z"} labels={"app":"whatsapp-bot","category":"PRESENCE_EVENT","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:23:44.503Z"
2025-07-23T13:23:44.523660424Z [INFO] [PRESENCE_RECEIVED] Presencia para 573003913251: typing jsonPayload={"category":"PRESENCE_RECEIVED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","status":"typing","timestamp":"2025-07-23T13:23:44.504Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"PRESENCE_RECEIVED","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:23:44.504Z"
📨 Webhook: 1 mensajes recibidos
2025-07-23T13:23:47.899460029Z [INFO] [WEBHOOK] Procesando 1 mensajes del webhook jsonPayload={"category":"WEBHOOK","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","messageCount":1,"timestamp":"2025-07-23T13:23:47.895Z"} labels={"app":"whatsapp-bot","category":"WEBHOOK","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:23:47.895Z"
2025-07-23T13:23:47.899514629Z [INFO] [MESSAGE_RECEIVED] Mensaje recibido jsonPayload={"body":"Ok yo te aviso...","category":"MESSAGE_RECEIVED","chatId":"573003913251@s.whatsapp.net","environment":"cloud-run","flow":{"stage":"1_receive"},"from":"573003913251","level":"INFO","timestamp":1753277027,"type":"text","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"MESSAGE_RECEIVED","flow_stage":"1_receive","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:23:47.895Z"
📥 [BUFFER] 573003913251: "Ok yo te aviso..." → ⏳ 5s...
2025-07-23T13:23:47.899590183Z [INFO] [GLOBAL_BUFFER_ADD] Mensaje agregado al buffer global jsonPayload={"bufferSize":1,"category":"GLOBAL_BUFFER_ADD","delay":5000,"environment":"cloud-run","flow":{"stage":"0_unknown"},"isMedia":false,"level":"INFO","messageText":"Ok yo te aviso...","timestamp":"2025-07-23T13:23:47.895Z","userJid":"573003913251","userName":"573003913251"} labels={"app":"whatsapp-bot","category":"GLOBAL_BUFFER_ADD","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:23:47.895Z"
2025-07-23T13:23:52.899478388Z [INFO] [GLOBAL_BUFFER_PROCESS] Procesando buffer global después de 5 segundos jsonPayload={"category":"GLOBAL_BUFFER_PROCESS","combinedText":"Ok yo te aviso...","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","messageCount":1,"timestamp":"2025-07-23T13:23:52.896Z","userJid":"573003913251","userName":"573003913251"} labels={"app":"whatsapp-bot","category":"GLOBAL_BUFFER_PROCESS","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:23:52.896Z"
2025-07-23T13:23:54.896686233Z [INFO] [QUEUE_ITEM_ADDED] Mensaje agregado a cola de usuario jsonPayload={"category":"QUEUE_ITEM_ADDED","environment":"cloud-run","flow":{"sequence":1,"stage":"0_unknown"},"hasActiveLock":false,"level":"INFO","messageId":"msg_1753277034888_w643na9wd","queueLength":1,"timestamp":"2025-07-23T13:23:54.888Z","totalQueues":1,"userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_ITEM_ADDED","flow_stage":"0_unknown","level":"INFO","message_id":"msg_1753277034888_w643na9wd","user_id":"573003913251"} timestamp="2025-07-23T13:23:54.888Z"
2025-07-23T13:23:54.896751724Z [INFO] [QUEUE_PROCESSING_START] Procesando cola de usuario jsonPayload={"category":"QUEUE_PROCESSING_START","environment":"cloud-run","flow":{"stage":"0_unknown"},"hasActiveLock":false,"level":"INFO","queueLength":1,"timestamp":"2025-07-23T13:23:54.888Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_PROCESSING_START","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:23:54.888Z"
2025-07-23T13:23:54.898937443Z [INFO] [QUEUE_ITEM_PROCESSING] Procesando mensaje de cola jsonPayload={"category":"QUEUE_ITEM_PROCESSING","environment":"cloud-run","flow":{"sequence":2,"stage":"0_unknown"},"level":"TRACE","messageId":"msg_1753277034888_w643na9wd","remainingInQueue":0,"timestamp":"2025-07-23T13:23:54.889Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_ITEM_PROCESSING","flow_stage":"0_unknown","level":"TRACE","message_id":"msg_1753277034888_w643na9wd","user_id":"573003913251"} timestamp="2025-07-23T13:23:54.889Z"
2025-07-23T13:23:55.585919245Z [INFO] [OPENAI_REQUEST] starting_process jsonPayload={"category":"OPENAI_REQUEST","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","timestamp":"2025-07-23T13:23:55.567Z"} labels={"app":"whatsapp-bot","category":"OPENAI_REQUEST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:23:55.567Z"
2025-07-23T13:23:55.585962244Z [INFO] [THREAD_REUSE] Thread reutilizado para 573003913251 jsonPayload={"category":"THREAD_REUSE","chatId":"573003913251@s.whatsapp.net","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:23:55.567Z","userName":"573003913251"} labels={"app":"whatsapp-bot","category":"THREAD_REUSE","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:23:55.567Z"
2025-07-23T13:23:55.585999089Z [INFO] [HISTORY_SKIP] Skip fetch historial: Thread existe jsonPayload={"category":"HISTORY_SKIP","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","reason":"thread_already_exists","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:23:55.567Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"HISTORY_SKIP","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:23:55.567Z"
2025-07-23T13:23:55.586041053Z [INFO] [HISTORY_INJECTION_SKIP] Saltando inyección - thread existente sin necesidad de contexto jsonPayload={"category":"HISTORY_INJECTION_SKIP","environment":"cloud-run","flow":{"stage":"0_unknown"},"hasContextAnalysis":false,"isNewThread":false,"level":"INFO","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:23:55.567Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"HISTORY_INJECTION_SKIP","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:23:55.567Z"
2025-07-23T13:23:55.586912254Z [INFO] [HISTORY_INJECTION_COMPLETED] Inyección de historial completada jsonPayload={"category":"HISTORY_INJECTION_COMPLETED","contextLength":0,"environment":"cloud-run","flow":{"stage":"0_unknown"},"historyLines":0,"labelsCount":0,"level":"SUCCESS","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:23:55.567Z","tokensUsed":0,"userId":"573003913251"} labels={"app":"whatsapp-bot","category":"HISTORY_INJECTION_COMPLETED","flow_stage":"0_unknown","level":"SUCCESS","user_id":"573003913251"} timestamp="2025-07-23T13:23:55.567Z"
2025-07-23T13:23:56.029510236Z [INFO] [CONTEXT_CACHE_HIT] Contexto temporal desde cache jsonPayload={"cacheAge":117,"category":"CONTEXT_CACHE_HIT","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","timestamp":"2025-07-23T13:23:56.026Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"CONTEXT_CACHE_HIT","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:23:56.026Z"
2025-07-23T13:23:56.029579213Z [INFO] [CONTEXT_DEBUG] Contexto enviado a OpenAI jsonPayload={"category":"CONTEXT_DEBUG","contextPreview":"Fecha: 23/07/2025 | Hora: 8:21 AM (Colombia)\nCliente: Sr Alex | Contacto WhatsApp: Sr Alex | Status: Colega Jefe, cotización\n---\nMensaje del cliente:\n","environment":"cloud-run","flow":{"stage":"0_unknown"},"isVoiceMessage":false,"level":"INFO","messagePreview":"Ok yo te aviso","shortUserId":"573003913251","timestamp":"2025-07-23T13:23:56.026Z","totalLength":164} labels={"app":"whatsapp-bot","category":"CONTEXT_DEBUG","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:23:56.026Z"
2025-07-23T13:23:56.382400426Z [INFO] [OPENAI_REQUEST] message_added_with_context jsonPayload={"category":"OPENAI_REQUEST","contextLength":150,"environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","originalLength":14,"shortUserId":"573003913251","timestamp":"2025-07-23T13:23:56.360Z","totalLength":164} labels={"app":"whatsapp-bot","category":"OPENAI_REQUEST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:23:56.360Z"
2025-07-23T13:23:56.382432099Z [INFO] [OPENAI_REQUEST] creating_run jsonPayload={"category":"OPENAI_REQUEST","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","timestamp":"2025-07-23T13:23:56.361Z"} labels={"app":"whatsapp-bot","category":"OPENAI_REQUEST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:23:56.361Z"
2025-07-23T13:23:57.597768854Z [INFO] [OPENAI_REQUEST] run_started jsonPayload={"category":"OPENAI_REQUEST","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","timestamp":"2025-07-23T13:23:57.595Z"} labels={"app":"whatsapp-bot","category":"OPENAI_REQUEST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:23:57.595Z"
2025-07-23T13:24:00.771137483Z [INFO] [OPENAI_RUN_COMPLETED] Run completado para 573003913251 jsonPayload={"category":"OPENAI_RUN_COMPLETED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"SUCCESS","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:24:00.765Z"} labels={"app":"whatsapp-bot","category":"OPENAI_RUN_COMPLETED","flow_stage":"0_unknown","level":"SUCCESS"} timestamp="2025-07-23T13:24:00.765Z"
2025-07-23T13:24:00.771180917Z [INFO] [TOKEN_USAGE] Tokens utilizados jsonPayload={"category":"TOKEN_USAGE","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:24:00.765Z","totalTokens":2325} labels={"app":"whatsapp-bot","category":"TOKEN_USAGE","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:24:00.765Z"
2025-07-23T13:24:00.771225055Z [INFO] [OPENAI_USAGE] Run completado con métricas jsonPayload={"category":"OPENAI_USAGE","completionTokens":26,"contextTokens":0,"durationMs":5198,"environment":"cloud-run","flow":{"stage":"6_ai_request"},"level":"INFO","promptTokens":2299,"runId":"run_IRfzzb8rfVMTVC58FuIipnP1","shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:24:00.765Z","tokensPerSecond":447,"totalTokens":2325} labels={"app":"whatsapp-bot","category":"OPENAI_USAGE","flow_stage":"6_ai_request","level":"INFO"} timestamp="2025-07-23T13:24:00.765Z"
2025-07-23T13:24:00.771270778Z [INFO] [OPENAI_LATENCY] Latencia del procesamiento jsonPayload={"category":"OPENAI_LATENCY","durationSeconds":"5.20","environment":"cloud-run","flow":{"stage":"6_ai_request"},"isHighLatency":false,"level":"INFO","shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:24:00.765Z","totalDurationMs":5198} labels={"app":"whatsapp-bot","category":"OPENAI_LATENCY","flow_stage":"6_ai_request","level":"INFO"} timestamp="2025-07-23T13:24:00.765Z"
2025-07-23T13:24:00.907126286Z [INFO] [OPENAI_RESPONSE] response_received jsonPayload={"category":"OPENAI_RESPONSE","environment":"cloud-run","flow":{"stage":"7_ai_response"},"level":"INFO","responseLength":89,"shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:24:00.905Z"} labels={"app":"whatsapp-bot","category":"OPENAI_RESPONSE","flow_stage":"7_ai_response","level":"INFO"} timestamp="2025-07-23T13:24:00.905Z"
2025-07-23T13:24:00.907715903Z [INFO] [PERFORMANCE_METRICS] Procesamiento completado exitosamente jsonPayload={"category":"PERFORMANCE_METRICS","contextTokens":0,"environment":"cloud-run","flow":{"stage":"9_complete"},"isEfficient":false,"level":"INFO","memory":{"heapTotalMB":32,"heapUsedMB":30,"rssMB":87},"responseLength":89,"shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:24:00.905Z","tokensPerSecond":436,"totalDurationMs":5338,"totalTokens":2325} labels={"app":"whatsapp-bot","category":"PERFORMANCE_METRICS","flow_stage":"9_complete","level":"INFO"} timestamp="2025-07-23T13:24:00.905Z"
2025-07-23T13:24:00.907783158Z [INFO] [WHATSAPP_SEND] Enviando mensaje a 573003913251 jsonPayload={"category":"WHATSAPP_SEND","chatId":"573003913251@s.whatsapp.net","environment":"cloud-run","flow":{"stage":"8_send"},"level":"INFO","messageLength":89,"preview":"Perfecto, Sr. Alex. Estoy aquí para ayudar cuando lo necesite. ¡Que tenga un buen día! 😊...","timestamp":"2025-07-23T13:24:00.905Z"} labels={"app":"whatsapp-bot","category":"WHATSAPP_SEND","flow_stage":"8_send","level":"INFO"} timestamp="2025-07-23T13:24:00.905Z"
2025-07-23T13:24:01.286Z ✅ [573003913251] Mensaje enviado
2025-07-23T13:24:01.304756697Z [INFO] [QUEUE_ITEM_SUCCESS] Mensaje procesado exitosamente jsonPayload={"category":"QUEUE_ITEM_SUCCESS","environment":"cloud-run","flow":{"sequence":3,"stage":"0_unknown"},"level":"SUCCESS","messageId":"msg_1753277034888_w643na9wd","processedCount":1,"remainingInQueue":0,"timestamp":"2025-07-23T13:24:01.286Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_ITEM_SUCCESS","flow_stage":"0_unknown","level":"SUCCESS","message_id":"msg_1753277034888_w643na9wd","user_id":"573003913251"} timestamp="2025-07-23T13:24:01.286Z"
2025-07-23T13:24:01.304783048Z [INFO] [LOCK_ALREADY_RELEASED] Lock ya liberado para usuario jsonPayload={"activeLocks":0,"category":"LOCK_ALREADY_RELEASED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"TRACE","timestamp":"2025-07-23T13:24:01.287Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"LOCK_ALREADY_RELEASED","flow_stage":"0_unknown","level":"TRACE","user_id":"573003913251"} timestamp="2025-07-23T13:24:01.287Z"
2025-07-23T13:24:01.304811321Z [INFO] [QUEUE_PROCESSING_COMPLETE] Cola de usuario procesada completamente jsonPayload={"averageTimePerMessage":"6399ms","category":"QUEUE_PROCESSING_COMPLETE","environment":"cloud-run","errorCount":0,"flow":{"stage":"0_unknown"},"initialQueueLength":1,"level":"SUCCESS","processedCount":1,"processingDuration":"6399ms","remainingQueues":0,"timestamp":"2025-07-23T13:24:01.287Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_PROCESSING_COMPLETE","flow_stage":"0_unknown","level":"SUCCESS","user_id":"573003913251"} timestamp="2025-07-23T13:24:01.287Z"
📨 Webhook: 1 mensajes recibidos
2025-07-23T13:24:02.137152670Z [INFO] [WEBHOOK] Procesando 1 mensajes del webhook jsonPayload={"category":"WEBHOOK","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","messageCount":1,"timestamp":"2025-07-23T13:24:02.133Z"} labels={"app":"whatsapp-bot","category":"WEBHOOK","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:24:02.133Z"
2025-07-23T13:24:05.831899750Z [INFO] [PRESENCE_EVENT] Procesando 1 eventos de presencia jsonPayload={"category":"PRESENCE_EVENT","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","presenceCount":1,"timestamp":"2025-07-23T13:24:05.825Z"} labels={"app":"whatsapp-bot","category":"PRESENCE_EVENT","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:24:05.825Z"
2025-07-23T13:24:05.831939995Z [INFO] [PRESENCE_RECEIVED] Presencia para 573003913251: typing jsonPayload={"category":"PRESENCE_RECEIVED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","status":"typing","timestamp":"2025-07-23T13:24:05.825Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"PRESENCE_RECEIVED","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:24:05.825Z"
📨 Webhook: 1 mensajes recibidos
2025-07-23T13:24:09.024684930Z [INFO] [WEBHOOK] Procesando 1 mensajes del webhook jsonPayload={"category":"WEBHOOK","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","messageCount":1,"timestamp":"2025-07-23T13:24:09.018Z"} labels={"app":"whatsapp-bot","category":"WEBHOOK","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:24:09.018Z"
2025-07-23T13:24:09.024724973Z [INFO] [MESSAGE_RECEIVED] Mensaje recibido jsonPayload={"body":"Gracias...","category":"MESSAGE_RECEIVED","chatId":"573003913251@s.whatsapp.net","environment":"cloud-run","flow":{"stage":"1_receive"},"from":"573003913251","level":"INFO","timestamp":1753277048,"type":"text","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"MESSAGE_RECEIVED","flow_stage":"1_receive","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:24:09.019Z"
📥 [BUFFER] 573003913251: "Gracias..." → ⏳ 5s...
2025-07-23T13:24:09.024775311Z [INFO] [GLOBAL_BUFFER_ADD] Mensaje agregado al buffer global jsonPayload={"bufferSize":1,"category":"GLOBAL_BUFFER_ADD","delay":5000,"environment":"cloud-run","flow":{"stage":"0_unknown"},"isMedia":false,"level":"INFO","messageText":"Gracias...","timestamp":"2025-07-23T13:24:09.020Z","userJid":"573003913251","userName":"573003913251"} labels={"app":"whatsapp-bot","category":"GLOBAL_BUFFER_ADD","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:24:09.020Z"
2025-07-23T13:24:10.932747726Z [INFO] [PRESENCE_EVENT] Procesando 1 eventos de presencia jsonPayload={"category":"PRESENCE_EVENT","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","presenceCount":1,"timestamp":"2025-07-23T13:24:10.930Z"} labels={"app":"whatsapp-bot","category":"PRESENCE_EVENT","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:24:10.930Z"
2025-07-23T13:24:10.932779214Z [INFO] [PRESENCE_RECEIVED] Presencia para 573003913251: typing jsonPayload={"category":"PRESENCE_RECEIVED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","status":"typing","timestamp":"2025-07-23T13:24:10.930Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"PRESENCE_RECEIVED","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:24:10.930Z"
2025-07-23T13:24:10.932806760Z [INFO] [GLOBAL_BUFFER_TYPING] Timer reiniciado por typing jsonPayload={"category":"GLOBAL_BUFFER_TYPING","delay":5000,"environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","timestamp":"2025-07-23T13:24:10.931Z","userJid":"573003913251","userName":"573003913251"} labels={"app":"whatsapp-bot","category":"GLOBAL_BUFFER_TYPING","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:24:10.931Z"
2025-07-23T13:24:15.935003494Z [INFO] [GLOBAL_BUFFER_PROCESS] Procesando buffer global después de 5 segundos jsonPayload={"category":"GLOBAL_BUFFER_PROCESS","combinedText":"Gracias...","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","messageCount":1,"timestamp":"2025-07-23T13:24:15.933Z","userJid":"573003913251","userName":"573003913251"} labels={"app":"whatsapp-bot","category":"GLOBAL_BUFFER_PROCESS","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:24:15.933Z"
2025-07-23T13:24:16.038004135Z [INFO] [PRESENCE_EVENT] Procesando 1 eventos de presencia jsonPayload={"category":"PRESENCE_EVENT","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","presenceCount":1,"timestamp":"2025-07-23T13:24:16.033Z"} labels={"app":"whatsapp-bot","category":"PRESENCE_EVENT","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:24:16.033Z"
2025-07-23T13:24:16.038055054Z [INFO] [PRESENCE_RECEIVED] Presencia para 573003913251: typing jsonPayload={"category":"PRESENCE_RECEIVED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","status":"typing","timestamp":"2025-07-23T13:24:16.033Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"PRESENCE_RECEIVED","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:24:16.033Z"
📨 Webhook: 1 mensajes recibidos
2025-07-23T13:24:16.146341040Z [INFO] [WEBHOOK] Procesando 1 mensajes del webhook jsonPayload={"category":"WEBHOOK","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","messageCount":1,"timestamp":"2025-07-23T13:24:16.139Z"} labels={"app":"whatsapp-bot","category":"WEBHOOK","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:24:16.139Z"
2025-07-23T13:24:16.146379814Z [INFO] [MESSAGE_RECEIVED] Mensaje recibido jsonPayload={"body":"Sólo que aún estamos...","category":"MESSAGE_RECEIVED","chatId":"573003913251@s.whatsapp.net","environment":"cloud-run","flow":{"stage":"1_receive"},"from":"573003913251","level":"INFO","timestamp":1753277055,"type":"text","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"MESSAGE_RECEIVED","flow_stage":"1_receive","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:24:16.139Z"
📥 [BUFFER] 573003913251: "Sólo que aún estamos..." → ⏳ 5s...
2025-07-23T13:24:16.146424260Z [INFO] [GLOBAL_BUFFER_ADD] Mensaje agregado al buffer global jsonPayload={"bufferSize":1,"category":"GLOBAL_BUFFER_ADD","delay":5000,"environment":"cloud-run","flow":{"stage":"0_unknown"},"isMedia":false,"level":"INFO","messageText":"Sólo que aún estamos...","timestamp":"2025-07-23T13:24:16.139Z","userJid":"573003913251","userName":"573003913251"} labels={"app":"whatsapp-bot","category":"GLOBAL_BUFFER_ADD","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:24:16.139Z"
2025-07-23T13:24:17.204529924Z [INFO] [QUEUE_ITEM_ADDED] Mensaje agregado a cola de usuario jsonPayload={"category":"QUEUE_ITEM_ADDED","environment":"cloud-run","flow":{"sequence":1,"stage":"0_unknown"},"hasActiveLock":false,"level":"INFO","messageId":"msg_1753277057203_aokasb1o2","queueLength":1,"timestamp":"2025-07-23T13:24:17.203Z","totalQueues":1,"userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_ITEM_ADDED","flow_stage":"0_unknown","level":"INFO","message_id":"msg_1753277057203_aokasb1o2","user_id":"573003913251"} timestamp="2025-07-23T13:24:17.203Z"
2025-07-23T13:24:17.204561692Z [INFO] [QUEUE_PROCESSING_START] Procesando cola de usuario jsonPayload={"category":"QUEUE_PROCESSING_START","environment":"cloud-run","flow":{"stage":"0_unknown"},"hasActiveLock":false,"level":"INFO","queueLength":1,"timestamp":"2025-07-23T13:24:17.203Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_PROCESSING_START","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:24:17.203Z"
2025-07-23T13:24:17.208017835Z [INFO] [QUEUE_ITEM_PROCESSING] Procesando mensaje de cola jsonPayload={"category":"QUEUE_ITEM_PROCESSING","environment":"cloud-run","flow":{"sequence":2,"stage":"0_unknown"},"level":"TRACE","messageId":"msg_1753277057203_aokasb1o2","remainingInQueue":0,"timestamp":"2025-07-23T13:24:17.204Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_ITEM_PROCESSING","flow_stage":"0_unknown","level":"TRACE","message_id":"msg_1753277057203_aokasb1o2","user_id":"573003913251"} timestamp="2025-07-23T13:24:17.203Z"
2025-07-23T13:24:19.109534921Z [INFO] [OPENAI_REQUEST] starting_process jsonPayload={"category":"OPENAI_REQUEST","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","timestamp":"2025-07-23T13:24:19.103Z"} labels={"app":"whatsapp-bot","category":"OPENAI_REQUEST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:24:19.103Z"
2025-07-23T13:24:19.109572662Z [INFO] [THREAD_REUSE] Thread reutilizado para 573003913251 jsonPayload={"category":"THREAD_REUSE","chatId":"573003913251@s.whatsapp.net","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:24:19.103Z","userName":"573003913251"} labels={"app":"whatsapp-bot","category":"THREAD_REUSE","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:24:19.103Z"
2025-07-23T13:24:19.109609656Z [INFO] [HISTORY_SKIP] Skip fetch historial: Thread existe jsonPayload={"category":"HISTORY_SKIP","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","reason":"thread_already_exists","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:24:19.103Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"HISTORY_SKIP","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:24:19.103Z"
2025-07-23T13:24:19.109675500Z [INFO] [HISTORY_INJECTION_SKIP] Saltando inyección - thread existente sin necesidad de contexto jsonPayload={"category":"HISTORY_INJECTION_SKIP","environment":"cloud-run","flow":{"stage":"0_unknown"},"hasContextAnalysis":false,"isNewThread":false,"level":"INFO","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:24:19.103Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"HISTORY_INJECTION_SKIP","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:24:19.103Z"
2025-07-23T13:24:19.109947055Z [INFO] [HISTORY_INJECTION_COMPLETED] Inyección de historial completada jsonPayload={"category":"HISTORY_INJECTION_COMPLETED","contextLength":0,"environment":"cloud-run","flow":{"stage":"0_unknown"},"historyLines":0,"labelsCount":0,"level":"SUCCESS","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:24:19.103Z","tokensUsed":0,"userId":"573003913251"} labels={"app":"whatsapp-bot","category":"HISTORY_INJECTION_COMPLETED","flow_stage":"0_unknown","level":"SUCCESS","user_id":"573003913251"} timestamp="2025-07-23T13:24:19.103Z"
2025-07-23T13:24:19.651774671Z [INFO] [CONTEXT_CACHE_HIT] Contexto temporal desde cache jsonPayload={"cacheAge":141,"category":"CONTEXT_CACHE_HIT","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","timestamp":"2025-07-23T13:24:19.647Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"CONTEXT_CACHE_HIT","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:24:19.647Z"
2025-07-23T13:24:19.651849781Z [INFO] [CONTEXT_DEBUG] Contexto enviado a OpenAI jsonPayload={"category":"CONTEXT_DEBUG","contextPreview":"Fecha: 23/07/2025 | Hora: 8:21 AM (Colombia)\nCliente: Sr Alex | Contacto WhatsApp: Sr Alex | Status: Colega Jefe, cotización\n---\nMensaje del cliente:\n","environment":"cloud-run","flow":{"stage":"0_unknown"},"isVoiceMessage":false,"level":"INFO","messagePreview":"Gracias","shortUserId":"573003913251","timestamp":"2025-07-23T13:24:19.647Z","totalLength":157} labels={"app":"whatsapp-bot","category":"CONTEXT_DEBUG","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:24:19.647Z"
2025-07-23T13:24:20.813181490Z [INFO] [OPENAI_REQUEST] message_added_with_context jsonPayload={"category":"OPENAI_REQUEST","contextLength":150,"environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","originalLength":7,"shortUserId":"573003913251","timestamp":"2025-07-23T13:24:20.809Z","totalLength":157} labels={"app":"whatsapp-bot","category":"OPENAI_REQUEST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:24:20.809Z"
2025-07-23T13:24:20.813223204Z [INFO] [OPENAI_REQUEST] creating_run jsonPayload={"category":"OPENAI_REQUEST","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","timestamp":"2025-07-23T13:24:20.810Z"} labels={"app":"whatsapp-bot","category":"OPENAI_REQUEST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:24:20.810Z"
2025-07-23T13:24:21.146029694Z [INFO] [BUFFER_PROCESS_SKIPPED] Procesamiento ya activo para usuario jsonPayload={"category":"BUFFER_PROCESS_SKIPPED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"WARNING","messageCount":1,"timestamp":"2025-07-23T13:24:21.141Z","userJid":"573003913251","userName":"573003913251"} labels={"app":"whatsapp-bot","category":"BUFFER_PROCESS_SKIPPED","flow_stage":"0_unknown","level":"WARNING"} timestamp="2025-07-23T13:24:21.141Z"
2025-07-23T13:24:21.846640918Z [INFO] [OPENAI_REQUEST] run_started jsonPayload={"category":"OPENAI_REQUEST","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","timestamp":"2025-07-23T13:24:21.843Z"} labels={"app":"whatsapp-bot","category":"OPENAI_REQUEST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:24:21.843Z"
2025-07-23T13:24:26.063324348Z [INFO] [PRESENCE_EVENT] Procesando 1 eventos de presencia jsonPayload={"category":"PRESENCE_EVENT","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","presenceCount":1,"timestamp":"2025-07-23T13:24:26.060Z"} labels={"app":"whatsapp-bot","category":"PRESENCE_EVENT","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:24:26.060Z"
2025-07-23T13:24:26.063367144Z [INFO] [PRESENCE_RECEIVED] Presencia para 573003913251: typing jsonPayload={"category":"PRESENCE_RECEIVED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","status":"typing","timestamp":"2025-07-23T13:24:26.060Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"PRESENCE_RECEIVED","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:24:26.060Z"
2025-07-23T13:24:26.063402083Z [INFO] [GLOBAL_BUFFER_TYPING] Timer reiniciado por typing jsonPayload={"category":"GLOBAL_BUFFER_TYPING","delay":5000,"environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","timestamp":"2025-07-23T13:24:26.060Z","userJid":"573003913251","userName":"573003913251"} labels={"app":"whatsapp-bot","category":"GLOBAL_BUFFER_TYPING","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:24:26.060Z"
2025-07-23T13:24:27.037486931Z [INFO] [OPENAI_RUN_COMPLETED] Run completado para 573003913251 jsonPayload={"category":"OPENAI_RUN_COMPLETED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"SUCCESS","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:24:27.033Z"} labels={"app":"whatsapp-bot","category":"OPENAI_RUN_COMPLETED","flow_stage":"0_unknown","level":"SUCCESS"} timestamp="2025-07-23T13:24:27.033Z"
2025-07-23T13:24:27.037521017Z [INFO] [TOKEN_USAGE] Tokens utilizados jsonPayload={"category":"TOKEN_USAGE","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:24:27.033Z","totalTokens":2405} labels={"app":"whatsapp-bot","category":"TOKEN_USAGE","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:24:27.033Z"
2025-07-23T13:24:27.037557307Z [INFO] [OPENAI_USAGE] Run completado con métricas jsonPayload={"category":"OPENAI_USAGE","completionTokens":24,"contextTokens":0,"durationMs":7930,"environment":"cloud-run","flow":{"stage":"6_ai_request"},"level":"INFO","promptTokens":2381,"runId":"run_jketNPiMjV4R5tCx2jjlezmY","shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:24:27.033Z","tokensPerSecond":303,"totalTokens":2405} labels={"app":"whatsapp-bot","category":"OPENAI_USAGE","flow_stage":"6_ai_request","level":"INFO"} timestamp="2025-07-23T13:24:27.033Z"
2025-07-23T13:24:27.037593498Z [INFO] [OPENAI_LATENCY] Latencia del procesamiento jsonPayload={"category":"OPENAI_LATENCY","durationSeconds":"7.93","environment":"cloud-run","flow":{"stage":"6_ai_request"},"isHighLatency":false,"level":"INFO","shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:24:27.033Z","totalDurationMs":7930} labels={"app":"whatsapp-bot","category":"OPENAI_LATENCY","flow_stage":"6_ai_request","level":"INFO"} timestamp="2025-07-23T13:24:27.033Z"
2025-07-23T13:24:27.234711476Z [INFO] [OPENAI_RESPONSE] response_received jsonPayload={"category":"OPENAI_RESPONSE","environment":"cloud-run","flow":{"stage":"7_ai_response"},"level":"INFO","responseLength":76,"shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:24:27.227Z"} labels={"app":"whatsapp-bot","category":"OPENAI_RESPONSE","flow_stage":"7_ai_response","level":"INFO"} timestamp="2025-07-23T13:24:27.227Z"
2025-07-23T13:24:27.234768068Z [INFO] [PERFORMANCE_METRICS] Procesamiento completado exitosamente jsonPayload={"category":"PERFORMANCE_METRICS","contextTokens":0,"environment":"cloud-run","flow":{"stage":"9_complete"},"isEfficient":false,"level":"INFO","memory":{"heapTotalMB":32,"heapUsedMB":31,"rssMB":88},"responseLength":76,"shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:24:27.227Z","tokensPerSecond":296,"totalDurationMs":8124,"totalTokens":2405} labels={"app":"whatsapp-bot","category":"PERFORMANCE_METRICS","flow_stage":"9_complete","level":"INFO"} timestamp="2025-07-23T13:24:27.227Z"
2025-07-23T13:24:27.234825886Z [INFO] [WHATSAPP_SEND] Enviando mensaje a 573003913251 jsonPayload={"category":"WHATSAPP_SEND","chatId":"573003913251@s.whatsapp.net","environment":"cloud-run","flow":{"stage":"8_send"},"level":"INFO","messageLength":76,"preview":"¡De nada, Sr. Alex! 😊 Si necesita algo más, no dude en preguntar. ¡Saludos!...","timestamp":"2025-07-23T13:24:27.228Z"} labels={"app":"whatsapp-bot","category":"WHATSAPP_SEND","flow_stage":"8_send","level":"INFO"} timestamp="2025-07-23T13:24:27.228Z"
2025-07-23T13:24:27.714Z ✅ [573003913251] Mensaje enviado
2025-07-23T13:24:27.752783888Z [INFO] [QUEUE_ITEM_SUCCESS] Mensaje procesado exitosamente jsonPayload={"category":"QUEUE_ITEM_SUCCESS","environment":"cloud-run","flow":{"sequence":3,"stage":"0_unknown"},"level":"SUCCESS","messageId":"msg_1753277057203_aokasb1o2","processedCount":1,"remainingInQueue":0,"timestamp":"2025-07-23T13:24:27.715Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_ITEM_SUCCESS","flow_stage":"0_unknown","level":"SUCCESS","message_id":"msg_1753277057203_aokasb1o2","user_id":"573003913251"} timestamp="2025-07-23T13:24:27.715Z"
2025-07-23T13:24:27.752822800Z [INFO] [LOCK_ALREADY_RELEASED] Lock ya liberado para usuario jsonPayload={"activeLocks":0,"category":"LOCK_ALREADY_RELEASED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"TRACE","timestamp":"2025-07-23T13:24:27.715Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"LOCK_ALREADY_RELEASED","flow_stage":"0_unknown","level":"TRACE","user_id":"573003913251"} timestamp="2025-07-23T13:24:27.715Z"
2025-07-23T13:24:27.752892521Z [INFO] [QUEUE_PROCESSING_COMPLETE] Cola de usuario procesada completamente jsonPayload={"averageTimePerMessage":"10512ms","category":"QUEUE_PROCESSING_COMPLETE","environment":"cloud-run","errorCount":0,"flow":{"stage":"0_unknown"},"initialQueueLength":1,"level":"SUCCESS","processedCount":1,"processingDuration":"10512ms","remainingQueues":0,"timestamp":"2025-07-23T13:24:27.715Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_PROCESSING_COMPLETE","flow_stage":"0_unknown","level":"SUCCESS","user_id":"573003913251"} timestamp="2025-07-23T13:24:27.715Z"
📨 Webhook: 1 mensajes recibidos
2025-07-23T13:24:28.602233563Z [INFO] [WEBHOOK] Procesando 1 mensajes del webhook jsonPayload={"category":"WEBHOOK","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","messageCount":1,"timestamp":"2025-07-23T13:24:28.599Z"} labels={"app":"whatsapp-bot","category":"WEBHOOK","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:24:28.599Z"
📨 Webhook: 1 mensajes recibidos
2025-07-23T13:24:30.605887891Z [INFO] [WEBHOOK] Procesando 1 mensajes del webhook jsonPayload={"category":"WEBHOOK","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","messageCount":1,"timestamp":"2025-07-23T13:24:30.604Z"} labels={"app":"whatsapp-bot","category":"WEBHOOK","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:24:30.604Z"
2025-07-23T13:24:30.605927898Z [INFO] [MESSAGE_RECEIVED] Mensaje recibido jsonPayload={"body":"Definiendo con mi familia pa es ver que día vamos...","category":"MESSAGE_RECEIVED","chatId":"573003913251@s.whatsapp.net","environment":"cloud-run","flow":{"stage":"1_receive"},"from":"573003913251","level":"INFO","timestamp":1753277069,"type":"text","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"MESSAGE_RECEIVED","flow_stage":"1_receive","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:24:30.604Z"
📥 [BUFFER] 573003913251: "Definiendo con mi familia pa e..." → ⏳ 5s...
2025-07-23T13:24:30.606000054Z [INFO] [GLOBAL_BUFFER_ADD] Mensaje agregado al buffer global jsonPayload={"bufferSize":2,"category":"GLOBAL_BUFFER_ADD","delay":5000,"environment":"cloud-run","flow":{"stage":"0_unknown"},"isMedia":false,"level":"INFO","messageText":"Definiendo con mi familia pa es ver que día vamos...","timestamp":"2025-07-23T13:24:30.604Z","userJid":"573003913251","userName":"573003913251"} labels={"app":"whatsapp-bot","category":"GLOBAL_BUFFER_ADD","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:24:30.604Z"
2025-07-23T13:24:35.616396851Z [INFO] [GLOBAL_BUFFER_PROCESS] Procesando buffer global después de 5 segundos jsonPayload={"category":"GLOBAL_BUFFER_PROCESS","combinedText":"Sólo que aún estamos Definiendo con mi familia pa es ver que día vamos...","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","messageCount":2,"timestamp":"2025-07-23T13:24:35.605Z","userJid":"573003913251","userName":"573003913251"} labels={"app":"whatsapp-bot","category":"GLOBAL_BUFFER_PROCESS","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:24:35.605Z"
2025-07-23T13:24:36.846051893Z [INFO] [QUEUE_ITEM_ADDED] Mensaje agregado a cola de usuario jsonPayload={"category":"QUEUE_ITEM_ADDED","environment":"cloud-run","flow":{"sequence":1,"stage":"0_unknown"},"hasActiveLock":false,"level":"INFO","messageId":"msg_1753277076836_9a1xokfh2","queueLength":1,"timestamp":"2025-07-23T13:24:36.836Z","totalQueues":1,"userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_ITEM_ADDED","flow_stage":"0_unknown","level":"INFO","message_id":"msg_1753277076836_9a1xokfh2","user_id":"573003913251"} timestamp="2025-07-23T13:24:36.836Z"
2025-07-23T13:24:36.846087285Z [INFO] [QUEUE_PROCESSING_START] Procesando cola de usuario jsonPayload={"category":"QUEUE_PROCESSING_START","environment":"cloud-run","flow":{"stage":"0_unknown"},"hasActiveLock":false,"level":"INFO","queueLength":1,"timestamp":"2025-07-23T13:24:36.836Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_PROCESSING_START","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:24:36.836Z"
2025-07-23T13:24:36.846122853Z [INFO] [QUEUE_ITEM_PROCESSING] Procesando mensaje de cola jsonPayload={"category":"QUEUE_ITEM_PROCESSING","environment":"cloud-run","flow":{"sequence":2,"stage":"0_unknown"},"level":"TRACE","messageId":"msg_1753277076836_9a1xokfh2","remainingInQueue":0,"timestamp":"2025-07-23T13:24:36.836Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_ITEM_PROCESSING","flow_stage":"0_unknown","level":"TRACE","message_id":"msg_1753277076836_9a1xokfh2","user_id":"573003913251"} timestamp="2025-07-23T13:24:36.836Z"
2025-07-23T13:24:37.924888941Z [INFO] [OPENAI_REQUEST] starting_process jsonPayload={"category":"OPENAI_REQUEST","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","timestamp":"2025-07-23T13:24:37.921Z"} labels={"app":"whatsapp-bot","category":"OPENAI_REQUEST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:24:37.921Z"
2025-07-23T13:24:37.924937622Z [INFO] [THREAD_REUSE] Thread reutilizado para 573003913251 jsonPayload={"category":"THREAD_REUSE","chatId":"573003913251@s.whatsapp.net","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:24:37.921Z","userName":"573003913251"} labels={"app":"whatsapp-bot","category":"THREAD_REUSE","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:24:37.921Z"
2025-07-23T13:24:37.924979817Z [INFO] [HISTORY_SKIP] Skip fetch historial: Thread existe jsonPayload={"category":"HISTORY_SKIP","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","reason":"thread_already_exists","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:24:37.921Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"HISTORY_SKIP","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:24:37.921Z"
2025-07-23T13:24:37.925033030Z [INFO] [HISTORY_INJECTION_SKIP] Saltando inyección - thread existente sin necesidad de contexto jsonPayload={"category":"HISTORY_INJECTION_SKIP","environment":"cloud-run","flow":{"stage":"0_unknown"},"hasContextAnalysis":false,"isNewThread":false,"level":"INFO","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:24:37.921Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"HISTORY_INJECTION_SKIP","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:24:37.921Z"
2025-07-23T13:24:37.925719837Z [INFO] [HISTORY_INJECTION_COMPLETED] Inyección de historial completada jsonPayload={"category":"HISTORY_INJECTION_COMPLETED","contextLength":0,"environment":"cloud-run","flow":{"stage":"0_unknown"},"historyLines":0,"labelsCount":0,"level":"SUCCESS","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:24:37.921Z","tokensUsed":0,"userId":"573003913251"} labels={"app":"whatsapp-bot","category":"HISTORY_INJECTION_COMPLETED","flow_stage":"0_unknown","level":"SUCCESS","user_id":"573003913251"} timestamp="2025-07-23T13:24:37.921Z"
2025-07-23T13:24:38.615146164Z [INFO] [CONTEXT_CACHE_HIT] Contexto temporal desde cache jsonPayload={"cacheAge":160,"category":"CONTEXT_CACHE_HIT","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","timestamp":"2025-07-23T13:24:38.609Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"CONTEXT_CACHE_HIT","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:24:38.609Z"
2025-07-23T13:24:38.615191394Z [INFO] [CONTEXT_DEBUG] Contexto enviado a OpenAI jsonPayload={"category":"CONTEXT_DEBUG","contextPreview":"Fecha: 23/07/2025 | Hora: 8:21 AM (Colombia)\nCliente: Sr Alex | Contacto WhatsApp: Sr Alex | Status: Colega Jefe, cotización\n---\nMensaje del cliente:\n","environment":"cloud-run","flow":{"stage":"0_unknown"},"isVoiceMessage":false,"level":"INFO","messagePreview":"Sólo que aún estamos Definiendo con mi familia pa es ver que día vamos","shortUserId":"573003913251","timestamp":"2025-07-23T13:24:38.609Z","totalLength":220} labels={"app":"whatsapp-bot","category":"CONTEXT_DEBUG","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:24:38.609Z"
2025-07-23T13:24:39.046461824Z [INFO] [OPENAI_REQUEST] message_added_with_context jsonPayload={"category":"OPENAI_REQUEST","contextLength":150,"environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","originalLength":70,"shortUserId":"573003913251","timestamp":"2025-07-23T13:24:39.030Z","totalLength":220} labels={"app":"whatsapp-bot","category":"OPENAI_REQUEST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:24:39.030Z"
2025-07-23T13:24:39.046494897Z [INFO] [OPENAI_REQUEST] creating_run jsonPayload={"category":"OPENAI_REQUEST","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","timestamp":"2025-07-23T13:24:39.031Z"} labels={"app":"whatsapp-bot","category":"OPENAI_REQUEST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:24:39.031Z"
2025-07-23T13:24:40.068834885Z [INFO] [OPENAI_REQUEST] run_started jsonPayload={"category":"OPENAI_REQUEST","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","timestamp":"2025-07-23T13:24:40.055Z"} labels={"app":"whatsapp-bot","category":"OPENAI_REQUEST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:24:40.055Z"
2025-07-23T13:24:42.741413359Z [INFO] [OPENAI_RUN_COMPLETED] Run completado para 573003913251 jsonPayload={"category":"OPENAI_RUN_COMPLETED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"SUCCESS","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:24:42.738Z"} labels={"app":"whatsapp-bot","category":"OPENAI_RUN_COMPLETED","flow_stage":"0_unknown","level":"SUCCESS"} timestamp="2025-07-23T13:24:42.738Z"
2025-07-23T13:24:42.741489465Z [INFO] [TOKEN_USAGE] Tokens utilizados jsonPayload={"category":"TOKEN_USAGE","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:24:42.739Z","totalTokens":2509} labels={"app":"whatsapp-bot","category":"TOKEN_USAGE","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:24:42.739Z"
2025-07-23T13:24:42.741544745Z [INFO] [OPENAI_USAGE] Run completado con métricas jsonPayload={"category":"OPENAI_USAGE","completionTokens":32,"contextTokens":0,"durationMs":4818,"environment":"cloud-run","flow":{"stage":"6_ai_request"},"level":"INFO","promptTokens":2477,"runId":"run_6m8NnnunlIQ4KaNcMg5TmU6g","shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:24:42.739Z","tokensPerSecond":521,"totalTokens":2509} labels={"app":"whatsapp-bot","category":"OPENAI_USAGE","flow_stage":"6_ai_request","level":"INFO"} timestamp="2025-07-23T13:24:42.739Z"
2025-07-23T13:24:42.741583976Z [INFO] [OPENAI_LATENCY] Latencia del procesamiento jsonPayload={"category":"OPENAI_LATENCY","durationSeconds":"4.82","environment":"cloud-run","flow":{"stage":"6_ai_request"},"isHighLatency":false,"level":"INFO","shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:24:42.739Z","totalDurationMs":4818} labels={"app":"whatsapp-bot","category":"OPENAI_LATENCY","flow_stage":"6_ai_request","level":"INFO"} timestamp="2025-07-23T13:24:42.739Z"
2025-07-23T13:24:43.190422453Z [INFO] [OPENAI_RESPONSE] response_received jsonPayload={"category":"OPENAI_RESPONSE","environment":"cloud-run","flow":{"stage":"7_ai_response"},"level":"INFO","responseLength":128,"shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:24:43.187Z"} labels={"app":"whatsapp-bot","category":"OPENAI_RESPONSE","flow_stage":"7_ai_response","level":"INFO"} timestamp="2025-07-23T13:24:43.187Z"
2025-07-23T13:24:43.190470043Z [INFO] [PERFORMANCE_METRICS] Procesamiento completado exitosamente jsonPayload={"category":"PERFORMANCE_METRICS","contextTokens":0,"environment":"cloud-run","flow":{"stage":"9_complete"},"isEfficient":false,"level":"INFO","memory":{"heapTotalMB":33,"heapUsedMB":31,"rssMB":88},"responseLength":128,"shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:24:43.188Z","tokensPerSecond":476,"totalDurationMs":5266,"totalTokens":2509} labels={"app":"whatsapp-bot","category":"PERFORMANCE_METRICS","flow_stage":"9_complete","level":"INFO"} timestamp="2025-07-23T13:24:43.188Z"
2025-07-23T13:24:43.190511264Z [INFO] [WHATSAPP_SEND] Enviando mensaje a 573003913251 jsonPayload={"category":"WHATSAPP_SEND","chatId":"573003913251@s.whatsapp.net","environment":"cloud-run","flow":{"stage":"8_send"},"level":"INFO","messageLength":128,"preview":"Entiendo, Sr. Alex. Tómense su tiempo para decidir. Estoy aquí para ayudar cuando tengan claridad so...","timestamp":"2025-07-23T13:24:43.188Z"} labels={"app":"whatsapp-bot","category":"WHATSAPP_SEND","flow_stage":"8_send","level":"INFO"} timestamp="2025-07-23T13:24:43.188Z"
2025-07-23T13:24:43.674Z ✅ [573003913251] Mensaje enviado
2025-07-23T13:24:43.683103188Z [INFO] [QUEUE_ITEM_SUCCESS] Mensaje procesado exitosamente jsonPayload={"category":"QUEUE_ITEM_SUCCESS","environment":"cloud-run","flow":{"sequence":3,"stage":"0_unknown"},"level":"SUCCESS","messageId":"msg_1753277076836_9a1xokfh2","processedCount":1,"remainingInQueue":0,"timestamp":"2025-07-23T13:24:43.674Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_ITEM_SUCCESS","flow_stage":"0_unknown","level":"SUCCESS","message_id":"msg_1753277076836_9a1xokfh2","user_id":"573003913251"} timestamp="2025-07-23T13:24:43.674Z"
2025-07-23T13:24:43.683201547Z [INFO] [LOCK_ALREADY_RELEASED] Lock ya liberado para usuario jsonPayload={"activeLocks":0,"category":"LOCK_ALREADY_RELEASED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"TRACE","timestamp":"2025-07-23T13:24:43.674Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"LOCK_ALREADY_RELEASED","flow_stage":"0_unknown","level":"TRACE","user_id":"573003913251"} timestamp="2025-07-23T13:24:43.674Z"
2025-07-23T13:24:43.683233441Z [INFO] [QUEUE_PROCESSING_COMPLETE] Cola de usuario procesada completamente jsonPayload={"averageTimePerMessage":"6838ms","category":"QUEUE_PROCESSING_COMPLETE","environment":"cloud-run","errorCount":0,"flow":{"stage":"0_unknown"},"initialQueueLength":1,"level":"SUCCESS","processedCount":1,"processingDuration":"6838ms","remainingQueues":0,"timestamp":"2025-07-23T13:24:43.674Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_PROCESSING_COMPLETE","flow_stage":"0_unknown","level":"SUCCESS","user_id":"573003913251"} timestamp="2025-07-23T13:24:43.674Z"
📨 Webhook: 1 mensajes recibidos
2025-07-23T13:24:44.487481071Z [INFO] [WEBHOOK] Procesando 1 mensajes del webhook jsonPayload={"category":"WEBHOOK","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","messageCount":1,"timestamp":"2025-07-23T13:24:44.485Z"} labels={"app":"whatsapp-bot","category":"WEBHOOK","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:24:44.485Z"
2025-07-23T13:31:14.737849119Z [INFO] [PRESENCE_EVENT] Procesando 1 eventos de presencia jsonPayload={"category":"PRESENCE_EVENT","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","presenceCount":1,"timestamp":"2025-07-23T13:31:10.619Z"} labels={"app":"whatsapp-bot","category":"PRESENCE_EVENT","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:31:10.619Z"
2025-07-23T13:31:14.737894195Z [INFO] [PRESENCE_RECEIVED] Presencia para 573003913251: typing jsonPayload={"category":"PRESENCE_RECEIVED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","status":"typing","timestamp":"2025-07-23T13:31:10.619Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"PRESENCE_RECEIVED","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:31:10.619Z"
2025-07-23T13:31:14.737894291Z [INFO] [PRESENCE_RECEIVED] Presencia para 573003913251: typing jsonPayload={"category":"PRESENCE_RECEIVED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","status":"typing","timestamp":"2025-07-23T13:31:11.338Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"PRESENCE_RECEIVED","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:31:11.338Z"
2025-07-23T13:31:14.737929254Z [INFO] [PRESENCE_EVENT] Procesando 1 eventos de presencia jsonPayload={"category":"PRESENCE_EVENT","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","presenceCount":1,"timestamp":"2025-07-23T13:31:11.275Z"} labels={"app":"whatsapp-bot","category":"PRESENCE_EVENT","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:31:11.275Z"
2025-07-23T13:31:14.737962793Z [INFO] [PRESENCE_RECEIVED] Presencia para 573003913251: online jsonPayload={"category":"PRESENCE_RECEIVED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","status":"online","timestamp":"2025-07-23T13:31:11.275Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"PRESENCE_RECEIVED","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:31:11.275Z"
2025-07-23T13:31:14.738007393Z [INFO] [PRESENCE_EVENT] Procesando 1 eventos de presencia jsonPayload={"category":"PRESENCE_EVENT","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","presenceCount":1,"timestamp":"2025-07-23T13:31:11.338Z"} labels={"app":"whatsapp-bot","category":"PRESENCE_EVENT","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:31:11.338Z"
📨 Webhook: 1 mensajes recibidos
2025-07-23T13:31:20.103083787Z [INFO] [WEBHOOK] Procesando 1 mensajes del webhook jsonPayload={"category":"WEBHOOK","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","messageCount":1,"timestamp":"2025-07-23T13:31:20.102Z"} labels={"app":"whatsapp-bot","category":"WEBHOOK","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:31:20.102Z"
2025-07-23T13:31:20.103112315Z [INFO] [MESSAGE_RECEIVED] Mensaje recibido jsonPayload={"body":"Tienes contexto pasado q hablamos ayer ?...","category":"MESSAGE_RECEIVED","chatId":"573003913251@s.whatsapp.net","environment":"cloud-run","flow":{"stage":"1_receive"},"from":"573003913251","level":"INFO","timestamp":1753277479,"type":"text","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"MESSAGE_RECEIVED","flow_stage":"1_receive","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:31:20.102Z"
📥 [BUFFER] 573003913251: "Tienes contexto pasado q habla..." → ⏳ 5s...
2025-07-23T13:31:20.103152695Z [INFO] [GLOBAL_BUFFER_ADD] Mensaje agregado al buffer global jsonPayload={"bufferSize":1,"category":"GLOBAL_BUFFER_ADD","delay":5000,"environment":"cloud-run","flow":{"stage":"0_unknown"},"isMedia":false,"level":"INFO","messageText":"Tienes contexto pasado q hablamos ayer ?...","timestamp":"2025-07-23T13:31:20.102Z","userJid":"573003913251","userName":"573003913251"} labels={"app":"whatsapp-bot","category":"GLOBAL_BUFFER_ADD","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:31:20.102Z"
2025-07-23T13:31:25.109459282Z [INFO] [GLOBAL_BUFFER_PROCESS] Procesando buffer global después de 5 segundos jsonPayload={"category":"GLOBAL_BUFFER_PROCESS","combinedText":"Tienes contexto pasado q hablamos ayer ?...","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","messageCount":1,"timestamp":"2025-07-23T13:31:25.104Z","userJid":"573003913251","userName":"573003913251"} labels={"app":"whatsapp-bot","category":"GLOBAL_BUFFER_PROCESS","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:31:25.104Z"
2025-07-23T13:31:28.372354565Z [INFO] [QUEUE_ITEM_ADDED] Mensaje agregado a cola de usuario jsonPayload={"category":"QUEUE_ITEM_ADDED","environment":"cloud-run","flow":{"sequence":1,"stage":"0_unknown"},"hasActiveLock":false,"level":"INFO","messageId":"msg_1753277488367_yp0hps6zb","queueLength":1,"timestamp":"2025-07-23T13:31:28.368Z","totalQueues":1,"userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_ITEM_ADDED","flow_stage":"0_unknown","level":"INFO","message_id":"msg_1753277488367_yp0hps6zb","user_id":"573003913251"} timestamp="2025-07-23T13:31:28.368Z"
2025-07-23T13:31:28.372396619Z [INFO] [QUEUE_PROCESSING_START] Procesando cola de usuario jsonPayload={"category":"QUEUE_PROCESSING_START","environment":"cloud-run","flow":{"stage":"0_unknown"},"hasActiveLock":false,"level":"INFO","queueLength":1,"timestamp":"2025-07-23T13:31:28.368Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_PROCESSING_START","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:31:28.368Z"
2025-07-23T13:31:28.372435336Z [INFO] [QUEUE_ITEM_PROCESSING] Procesando mensaje de cola jsonPayload={"category":"QUEUE_ITEM_PROCESSING","environment":"cloud-run","flow":{"sequence":2,"stage":"0_unknown"},"level":"TRACE","messageId":"msg_1753277488367_yp0hps6zb","remainingInQueue":0,"timestamp":"2025-07-23T13:31:28.368Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_ITEM_PROCESSING","flow_stage":"0_unknown","level":"TRACE","message_id":"msg_1753277488367_yp0hps6zb","user_id":"573003913251"} timestamp="2025-07-23T13:31:28.368Z"
2025-07-23T13:31:37.670687066Z [INFO] [OPENAI_REQUEST] starting_process jsonPayload={"category":"OPENAI_REQUEST","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","timestamp":"2025-07-23T13:31:37.668Z"} labels={"app":"whatsapp-bot","category":"OPENAI_REQUEST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:31:37.668Z"
2025-07-23T13:31:37.670728111Z [INFO] [THREAD_REUSE] Thread reutilizado para 573003913251 jsonPayload={"category":"THREAD_REUSE","chatId":"573003913251@s.whatsapp.net","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:31:37.669Z","userName":"573003913251"} labels={"app":"whatsapp-bot","category":"THREAD_REUSE","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:31:37.669Z"
2025-07-23T13:31:37.670757803Z [INFO] [HISTORY_SKIP] Skip fetch historial: Thread existe jsonPayload={"category":"HISTORY_SKIP","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","reason":"thread_already_exists","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:31:37.669Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"HISTORY_SKIP","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:31:37.669Z"
2025-07-23T13:31:37.670788358Z [INFO] [HISTORY_INJECTION_SKIP] Saltando inyección - thread existente sin necesidad de contexto jsonPayload={"category":"HISTORY_INJECTION_SKIP","environment":"cloud-run","flow":{"stage":"0_unknown"},"hasContextAnalysis":false,"isNewThread":false,"level":"INFO","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:31:37.669Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"HISTORY_INJECTION_SKIP","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:31:37.669Z"
2025-07-23T13:31:37.670879172Z [INFO] [HISTORY_INJECTION_COMPLETED] Inyección de historial completada jsonPayload={"category":"HISTORY_INJECTION_COMPLETED","contextLength":0,"environment":"cloud-run","flow":{"stage":"0_unknown"},"historyLines":0,"labelsCount":0,"level":"SUCCESS","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:31:37.669Z","tokensUsed":0,"userId":"573003913251"} labels={"app":"whatsapp-bot","category":"HISTORY_INJECTION_COMPLETED","flow_stage":"0_unknown","level":"SUCCESS","user_id":"573003913251"} timestamp="2025-07-23T13:31:37.669Z"
2025-07-23T13:31:38.977906343Z [INFO] [CONTEXT_CACHE_HIT] Contexto temporal desde cache jsonPayload={"cacheAge":580,"category":"CONTEXT_CACHE_HIT","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","timestamp":"2025-07-23T13:31:38.968Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"CONTEXT_CACHE_HIT","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:31:38.968Z"
2025-07-23T13:31:38.977949361Z [INFO] [CONTEXT_DEBUG] Contexto enviado a OpenAI jsonPayload={"category":"CONTEXT_DEBUG","contextPreview":"Fecha: 23/07/2025 | Hora: 8:21 AM (Colombia)\nCliente: Sr Alex | Contacto WhatsApp: Sr Alex | Status: Colega Jefe, cotización\n---\nMensaje del cliente:\n","environment":"cloud-run","flow":{"stage":"0_unknown"},"isVoiceMessage":false,"level":"INFO","messagePreview":"Tienes contexto pasado q hablamos ayer ?","shortUserId":"573003913251","timestamp":"2025-07-23T13:31:38.968Z","totalLength":190} labels={"app":"whatsapp-bot","category":"CONTEXT_DEBUG","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:31:38.968Z"
2025-07-23T13:31:39.388350101Z [INFO] [OPENAI_REQUEST] message_added_with_context jsonPayload={"category":"OPENAI_REQUEST","contextLength":150,"environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","originalLength":40,"shortUserId":"573003913251","timestamp":"2025-07-23T13:31:39.386Z","totalLength":190} labels={"app":"whatsapp-bot","category":"OPENAI_REQUEST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:31:39.385Z"
2025-07-23T13:31:39.388388591Z [INFO] [OPENAI_REQUEST] creating_run jsonPayload={"category":"OPENAI_REQUEST","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","timestamp":"2025-07-23T13:31:39.386Z"} labels={"app":"whatsapp-bot","category":"OPENAI_REQUEST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:31:39.386Z"
2025-07-23T13:31:40.455097479Z [INFO] [OPENAI_REQUEST] run_started jsonPayload={"category":"OPENAI_REQUEST","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","timestamp":"2025-07-23T13:31:40.452Z"} labels={"app":"whatsapp-bot","category":"OPENAI_REQUEST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:31:40.452Z"
2025-07-23T13:31:47.300382503Z [INFO] [FUNCTION_CALLING_START] function_calling_required jsonPayload={"category":"FUNCTION_CALLING_START","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","runId":"run_9hLJLaGKD6yMCFi8pcW5YSUj","shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:31:47.298Z","toolCallsCount":1} labels={"app":"whatsapp-bot","category":"FUNCTION_CALLING_START","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:31:47.298Z"
2025-07-23T13:31:47.300416683Z [INFO] [FUNCTION_EXECUTING] function_executing jsonPayload={"args":{"context_level":"recent_30"},"category":"FUNCTION_EXECUTING","environment":"cloud-run","flow":{"stage":"0_unknown"},"functionName":"get_conversation_context","level":"INFO","shortUserId":"573003913251","timestamp":"2025-07-23T13:31:47.298Z","toolCallId":"call_JKJbKRzTtPd3k3fRdK0fkBMP"} labels={"app":"whatsapp-bot","category":"FUNCTION_EXECUTING","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:31:47.298Z"
[2025-07-23T08:31:47.298Z] [INFO] CONTEXT_FUNCTION [unknown.ts]: Solicitando contexto de conversación | {"contextLevel":"recent_30"}
2025-07-23T13:31:47.300443924Z [INFO] [CHAT_HISTORY] Obteniendo historial de chat para undefined jsonPayload={"category":"CHAT_HISTORY","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","timestamp":"2025-07-23T13:31:47.300Z"} labels={"app":"whatsapp-bot","category":"CHAT_HISTORY","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:31:47.300Z"
[2025-07-23T08:31:47.298Z] [INFO] CONTEXT_FUNCTION [unknown.ts]: Solicitando contexto de conversación | {"contextLevel":"recent_30"}
2025-07-23T13:31:47.677075334Z [INFO] [CHAT_HISTORY] Error obteniendo historial: Request failed with status code 400 jsonPayload={"category":"CHAT_HISTORY","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"ERROR","timestamp":"2025-07-23T13:31:47.675Z"} labels={"app":"whatsapp-bot","category":"CHAT_HISTORY","flow_stage":"0_unknown","level":"ERROR"} timestamp="2025-07-23T13:31:47.675Z"
[2025-07-23T08:31:47.675Z] [SUCCESS] CONTEXT_FUNCTION [unknown.ts]: Contexto obtenido exitosamente | {"contextLevel":"recent_30","messageCount":30,"contextLength":52}
2025-07-23T13:31:47.677163385Z [INFO] [FUNCTION_HANDLER] function_success jsonPayload={"category":"FUNCTION_HANDLER","environment":"cloud-run","flow":{"stage":"0_unknown"},"functionName":"get_conversation_context","level":"INFO","resultLength":187,"shortUserId":"573003913251","status":"success","timestamp":"2025-07-23T13:31:47.676Z","toolCallId":"call_JKJbKRzTtPd3k3fRdK0fkBMP"} labels={"app":"whatsapp-bot","category":"FUNCTION_HANDLER","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:31:47.676Z"
[2025-07-23T08:31:47.675Z] [SUCCESS] CONTEXT_FUNCTION [unknown.ts]: Contexto obtenido exitosamente | {"contextLevel":"recent_30","messageCount":30,"contextLength":52}
2025-07-23T13:31:49.542246496Z [INFO] [TOOL_OUTPUTS_SUBMITTED] Tool outputs enviados a OpenAI jsonPayload={"category":"TOOL_OUTPUTS_SUBMITTED","environment":"cloud-run","flow":{"stage":"6_ai_request"},"level":"INFO","outputs":[{"id":"call_JKJbKRzTtPd3k3fRdK0fkBMP","outputLength":187,"outputPreview":"{\"success\":true,\"context\":\"No hay mensajes disponibles para el nivel recent_30.\",\"context_level\":\"re..."}],"runId":"run_9hLJLaGKD6yMCFi8pcW5YSUj","shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:31:49.522Z","totalOutputs":1} labels={"app":"whatsapp-bot","category":"TOOL_OUTPUTS_SUBMITTED","flow_stage":"6_ai_request","level":"INFO"} timestamp="2025-07-23T13:31:49.522Z"
2025-07-23T13:31:49.542303181Z [INFO] [POST_SUBMIT_STATUS] Status después de submit tool outputs jsonPayload={"category":"POST_SUBMIT_STATUS","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","runId":"run_9hLJLaGKD6yMCFi8pcW5YSUj","runStatus":"requires_action","shortUserId":"573003913251","timestamp":"2025-07-23T13:31:49.522Z"} labels={"app":"whatsapp-bot","category":"POST_SUBMIT_STATUS","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:31:49.522Z"
2025-07-23T13:31:51.080375862Z [INFO] [POST_TOOL_POLLING] Polling post-tool - Intento 1/5 jsonPayload={"attempt":1,"category":"POST_TOOL_POLLING","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","runId":"run_9hLJLaGKD6yMCFi8pcW5YSUj","shortUserId":"573003913251","status":"queued","timestamp":"2025-07-23T13:31:51.074Z"} labels={"app":"whatsapp-bot","category":"POST_TOOL_POLLING","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:31:51.074Z"
2025-07-23T13:31:52.301920089Z [INFO] [POST_TOOL_POLLING] Polling post-tool - Intento 2/5 jsonPayload={"attempt":2,"category":"POST_TOOL_POLLING","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","runId":"run_9hLJLaGKD6yMCFi8pcW5YSUj","shortUserId":"573003913251","status":"in_progress","timestamp":"2025-07-23T13:31:52.300Z"} labels={"app":"whatsapp-bot","category":"POST_TOOL_POLLING","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:31:52.300Z"
2025-07-23T13:31:54.606795372Z [INFO] [POST_TOOL_POLLING] Polling post-tool - Intento 3/5 jsonPayload={"attempt":3,"category":"POST_TOOL_POLLING","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","runId":"run_9hLJLaGKD6yMCFi8pcW5YSUj","shortUserId":"573003913251","status":"in_progress","timestamp":"2025-07-23T13:31:54.603Z"} labels={"app":"whatsapp-bot","category":"POST_TOOL_POLLING","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:31:54.603Z"
2025-07-23T13:31:57.870678047Z [INFO] [POST_TOOL_POLLING] Polling post-tool - Intento 4/5 jsonPayload={"attempt":4,"category":"POST_TOOL_POLLING","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","runId":"run_9hLJLaGKD6yMCFi8pcW5YSUj","shortUserId":"573003913251","status":"completed","timestamp":"2025-07-23T13:31:57.868Z"} labels={"app":"whatsapp-bot","category":"POST_TOOL_POLLING","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:31:57.868Z"
2025-07-23T13:31:57.870728438Z [INFO] [POST_TOOL_POLLING_COMPLETE] Polling post-tool completado jsonPayload={"attempts":3,"category":"POST_TOOL_POLLING_COMPLETE","environment":"cloud-run","finalStatus":"completed","flow":{"stage":"0_unknown"},"level":"INFO","runId":"run_9hLJLaGKD6yMCFi8pcW5YSUj","shortUserId":"573003913251","timestamp":"2025-07-23T13:31:57.868Z"} labels={"app":"whatsapp-bot","category":"POST_TOOL_POLLING_COMPLETE","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:31:57.868Z"
2025-07-23T13:31:58.005043710Z [INFO] [FUNCTION_CALLING_RESPONSE] Respuesta final recibida después de function calling jsonPayload={"category":"FUNCTION_CALLING_RESPONSE","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"SUCCESS","responseLength":124,"shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:31:58.003Z","toolCallsExecuted":1} labels={"app":"whatsapp-bot","category":"FUNCTION_CALLING_RESPONSE","flow_stage":"0_unknown","level":"SUCCESS"} timestamp="2025-07-23T13:31:58.003Z"
✅ [TOOL_SUCCESS] Respuesta recibida después de 1 tool calls
2025-07-23T13:31:58.005116120Z [INFO] [WHATSAPP_SEND] Enviando mensaje a 573003913251 jsonPayload={"category":"WHATSAPP_SEND","chatId":"573003913251@s.whatsapp.net","environment":"cloud-run","flow":{"stage":"8_send"},"level":"INFO","messageLength":124,"preview":"No tengo mensajes anteriores del día de ayer. Si puedes recordarme de qué hablamos, estaré encantado...","timestamp":"2025-07-23T13:31:58.003Z"} labels={"app":"whatsapp-bot","category":"WHATSAPP_SEND","flow_stage":"8_send","level":"INFO"} timestamp="2025-07-23T13:31:58.003Z"
2025-07-23T13:31:58.648Z ✅ [573003913251] Mensaje enviado
2025-07-23T13:31:58.655099530Z [INFO] [QUEUE_ITEM_SUCCESS] Mensaje procesado exitosamente jsonPayload={"category":"QUEUE_ITEM_SUCCESS","environment":"cloud-run","flow":{"sequence":3,"stage":"0_unknown"},"level":"SUCCESS","messageId":"msg_1753277488367_yp0hps6zb","processedCount":1,"remainingInQueue":0,"timestamp":"2025-07-23T13:31:58.648Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_ITEM_SUCCESS","flow_stage":"0_unknown","level":"SUCCESS","message_id":"msg_1753277488367_yp0hps6zb","user_id":"573003913251"} timestamp="2025-07-23T13:31:58.648Z"
2025-07-23T13:31:58.655126316Z [INFO] [LOCK_ALREADY_RELEASED] Lock ya liberado para usuario jsonPayload={"activeLocks":0,"category":"LOCK_ALREADY_RELEASED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"TRACE","timestamp":"2025-07-23T13:31:58.648Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"LOCK_ALREADY_RELEASED","flow_stage":"0_unknown","level":"TRACE","user_id":"573003913251"} timestamp="2025-07-23T13:31:58.648Z"
2025-07-23T13:31:58.655155455Z [INFO] [QUEUE_PROCESSING_COMPLETE] Cola de usuario procesada completamente jsonPayload={"averageTimePerMessage":"30280ms","category":"QUEUE_PROCESSING_COMPLETE","environment":"cloud-run","errorCount":0,"flow":{"stage":"0_unknown"},"initialQueueLength":1,"level":"SUCCESS","processedCount":1,"processingDuration":"30280ms","remainingQueues":0,"timestamp":"2025-07-23T13:31:58.648Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_PROCESSING_COMPLETE","flow_stage":"0_unknown","level":"SUCCESS","user_id":"573003913251"} timestamp="2025-07-23T13:31:58.648Z"
📨 Webhook: 1 mensajes recibidos
2025-07-23T13:31:59.522632692Z [INFO] [WEBHOOK] Procesando 1 mensajes del webhook jsonPayload={"category":"WEBHOOK","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","messageCount":1,"timestamp":"2025-07-23T13:31:59.519Z"} labels={"app":"whatsapp-bot","category":"WEBHOOK","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:31:59.519Z"
2025-07-23T13:32:19.522569492Z [INFO] [PRESENCE_EVENT] Procesando 1 eventos de presencia jsonPayload={"category":"PRESENCE_EVENT","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","presenceCount":1,"timestamp":"2025-07-23T13:32:12.132Z"} labels={"app":"whatsapp-bot","category":"PRESENCE_EVENT","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:32:12.132Z"
2025-07-23T13:32:19.522597843Z [INFO] [PRESENCE_RECEIVED] Presencia para 573003913251: typing jsonPayload={"category":"PRESENCE_RECEIVED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","status":"typing","timestamp":"2025-07-23T13:32:12.132Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"PRESENCE_RECEIVED","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:32:12.132Z"
📨 Webhook: 1 mensajes recibidos
2025-07-23T13:32:20.409002728Z [INFO] [WEBHOOK] Procesando 1 mensajes del webhook jsonPayload={"category":"WEBHOOK","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","messageCount":1,"timestamp":"2025-07-23T13:32:20.399Z"} labels={"app":"whatsapp-bot","category":"WEBHOOK","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:32:20.399Z"
2025-07-23T13:32:20.409044027Z [INFO] [MESSAGE_RECEIVED] Mensaje recibido jsonPayload={"body":"Ejecuta la función get context...","category":"MESSAGE_RECEIVED","chatId":"573003913251@s.whatsapp.net","environment":"cloud-run","flow":{"stage":"1_receive"},"from":"573003913251","level":"INFO","timestamp":1753277539,"type":"text","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"MESSAGE_RECEIVED","flow_stage":"1_receive","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:32:20.399Z"
📥 [BUFFER] 573003913251: "Ejecuta la función get context..." → ⏳ 5s...
2025-07-23T13:32:20.409094524Z [INFO] [GLOBAL_BUFFER_ADD] Mensaje agregado al buffer global jsonPayload={"bufferSize":1,"category":"GLOBAL_BUFFER_ADD","delay":5000,"environment":"cloud-run","flow":{"stage":"0_unknown"},"isMedia":false,"level":"INFO","messageText":"Ejecuta la función get context...","timestamp":"2025-07-23T13:32:20.399Z","userJid":"573003913251","userName":"573003913251"} labels={"app":"whatsapp-bot","category":"GLOBAL_BUFFER_ADD","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:32:20.399Z"
2025-07-23T13:32:25.410776267Z [INFO] [GLOBAL_BUFFER_PROCESS] Procesando buffer global después de 5 segundos jsonPayload={"category":"GLOBAL_BUFFER_PROCESS","combinedText":"Ejecuta la función get context...","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","messageCount":1,"timestamp":"2025-07-23T13:32:25.402Z","userJid":"573003913251","userName":"573003913251"} labels={"app":"whatsapp-bot","category":"GLOBAL_BUFFER_PROCESS","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:32:25.402Z"
2025-07-23T13:32:26.792659371Z [INFO] [QUEUE_ITEM_ADDED] Mensaje agregado a cola de usuario jsonPayload={"category":"QUEUE_ITEM_ADDED","environment":"cloud-run","flow":{"sequence":1,"stage":"0_unknown"},"hasActiveLock":false,"level":"INFO","messageId":"msg_1753277546789_b0bwx7w20","queueLength":1,"timestamp":"2025-07-23T13:32:26.789Z","totalQueues":1,"userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_ITEM_ADDED","flow_stage":"0_unknown","level":"INFO","message_id":"msg_1753277546789_b0bwx7w20","user_id":"573003913251"} timestamp="2025-07-23T13:32:26.789Z"
2025-07-23T13:32:26.792691429Z [INFO] [QUEUE_PROCESSING_START] Procesando cola de usuario jsonPayload={"category":"QUEUE_PROCESSING_START","environment":"cloud-run","flow":{"stage":"0_unknown"},"hasActiveLock":false,"level":"INFO","queueLength":1,"timestamp":"2025-07-23T13:32:26.790Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_PROCESSING_START","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:32:26.790Z"
2025-07-23T13:32:26.792720600Z [INFO] [QUEUE_ITEM_PROCESSING] Procesando mensaje de cola jsonPayload={"category":"QUEUE_ITEM_PROCESSING","environment":"cloud-run","flow":{"sequence":2,"stage":"0_unknown"},"level":"TRACE","messageId":"msg_1753277546789_b0bwx7w20","remainingInQueue":0,"timestamp":"2025-07-23T13:32:26.790Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_ITEM_PROCESSING","flow_stage":"0_unknown","level":"TRACE","message_id":"msg_1753277546789_b0bwx7w20","user_id":"573003913251"} timestamp="2025-07-23T13:32:26.790Z"
2025-07-23T13:32:27.410885103Z [INFO] [OPENAI_REQUEST] starting_process jsonPayload={"category":"OPENAI_REQUEST","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","timestamp":"2025-07-23T13:32:27.407Z"} labels={"app":"whatsapp-bot","category":"OPENAI_REQUEST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:32:27.407Z"
2025-07-23T13:32:27.410929480Z [INFO] [THREAD_REUSE] Thread reutilizado para 573003913251 jsonPayload={"category":"THREAD_REUSE","chatId":"573003913251@s.whatsapp.net","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:32:27.407Z","userName":"573003913251"} labels={"app":"whatsapp-bot","category":"THREAD_REUSE","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:32:27.407Z"
2025-07-23T13:32:27.410962338Z [INFO] [HISTORY_SKIP] Skip fetch historial: Thread existe jsonPayload={"category":"HISTORY_SKIP","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","reason":"thread_already_exists","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:32:27.407Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"HISTORY_SKIP","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:32:27.407Z"
2025-07-23T13:32:27.410979342Z [INFO] [HISTORY_INJECTION_COMPLETED] Inyección de historial completada jsonPayload={"category":"HISTORY_INJECTION_COMPLETED","contextLength":0,"environment":"cloud-run","flow":{"stage":"0_unknown"},"historyLines":0,"labelsCount":0,"level":"SUCCESS","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:32:27.407Z","tokensUsed":0,"userId":"573003913251"} labels={"app":"whatsapp-bot","category":"HISTORY_INJECTION_COMPLETED","flow_stage":"0_unknown","level":"SUCCESS","user_id":"573003913251"} timestamp="2025-07-23T13:32:27.407Z"
2025-07-23T13:32:27.410998853Z [INFO] [HISTORY_INJECTION_SKIP] Saltando inyección - thread existente sin necesidad de contexto jsonPayload={"category":"HISTORY_INJECTION_SKIP","environment":"cloud-run","flow":{"stage":"0_unknown"},"hasContextAnalysis":false,"isNewThread":false,"level":"INFO","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:32:27.407Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"HISTORY_INJECTION_SKIP","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:32:27.407Z"
2025-07-23T13:32:28.000219383Z [INFO] [CONTEXT_CACHE_HIT] Contexto temporal desde cache jsonPayload={"cacheAge":629,"category":"CONTEXT_CACHE_HIT","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","timestamp":"2025-07-23T13:32:27.991Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"CONTEXT_CACHE_HIT","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:32:27.991Z"
2025-07-23T13:32:28.000340514Z [INFO] [CONTEXT_DEBUG] Contexto enviado a OpenAI jsonPayload={"category":"CONTEXT_DEBUG","contextPreview":"Fecha: 23/07/2025 | Hora: 8:21 AM (Colombia)\nCliente: Sr Alex | Contacto WhatsApp: Sr Alex | Status: Colega Jefe, cotización\n---\nMensaje del cliente:\n","environment":"cloud-run","flow":{"stage":"0_unknown"},"isVoiceMessage":false,"level":"INFO","messagePreview":"Ejecuta la función get context","shortUserId":"573003913251","timestamp":"2025-07-23T13:32:27.991Z","totalLength":180} labels={"app":"whatsapp-bot","category":"CONTEXT_DEBUG","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:32:27.991Z"
2025-07-23T13:32:28.296442852Z [INFO] [OPENAI_REQUEST] message_added_with_context jsonPayload={"category":"OPENAI_REQUEST","contextLength":150,"environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","originalLength":30,"shortUserId":"573003913251","timestamp":"2025-07-23T13:32:28.288Z","totalLength":180} labels={"app":"whatsapp-bot","category":"OPENAI_REQUEST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:32:28.288Z"
2025-07-23T13:32:28.296491225Z [INFO] [OPENAI_REQUEST] creating_run jsonPayload={"category":"OPENAI_REQUEST","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","timestamp":"2025-07-23T13:32:28.288Z"} labels={"app":"whatsapp-bot","category":"OPENAI_REQUEST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:32:28.288Z"
2025-07-23T13:32:29.444555924Z [INFO] [OPENAI_REQUEST] run_started jsonPayload={"category":"OPENAI_REQUEST","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","timestamp":"2025-07-23T13:32:29.437Z"} labels={"app":"whatsapp-bot","category":"OPENAI_REQUEST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:32:29.437Z"
2025-07-23T13:32:33.296538881Z [INFO] [FUNCTION_CALLING_START] function_calling_required jsonPayload={"category":"FUNCTION_CALLING_START","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","runId":"run_mNPyXijSSN8nKp18pzP23mTa","shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:32:33.293Z","toolCallsCount":1} labels={"app":"whatsapp-bot","category":"FUNCTION_CALLING_START","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:32:33.293Z"
2025-07-23T13:32:33.296583336Z [INFO] [FUNCTION_EXECUTING] function_executing jsonPayload={"args":{"context_level":"recent_60"},"category":"FUNCTION_EXECUTING","environment":"cloud-run","flow":{"stage":"0_unknown"},"functionName":"get_conversation_context","level":"INFO","shortUserId":"573003913251","timestamp":"2025-07-23T13:32:33.293Z","toolCallId":"call_KqeW1Qfb1f4ItMH8QcgNbfAU"} labels={"app":"whatsapp-bot","category":"FUNCTION_EXECUTING","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:32:33.293Z"
[2025-07-23T08:32:33.293Z] [INFO] CONTEXT_FUNCTION [unknown.ts]: Solicitando contexto de conversación | {"contextLevel":"recent_60"}
2025-07-23T13:32:33.296646534Z [INFO] [CHAT_HISTORY] Obteniendo historial de chat para undefined jsonPayload={"category":"CHAT_HISTORY","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","timestamp":"2025-07-23T13:32:33.294Z"} labels={"app":"whatsapp-bot","category":"CHAT_HISTORY","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:32:33.294Z"
[2025-07-23T08:32:33.293Z] [INFO] CONTEXT_FUNCTION [unknown.ts]: Solicitando contexto de conversación | {"contextLevel":"recent_60"}
2025-07-23T13:32:33.682342324Z [INFO] [CHAT_HISTORY] Error obteniendo historial: Request failed with status code 400 jsonPayload={"category":"CHAT_HISTORY","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"ERROR","timestamp":"2025-07-23T13:32:33.679Z"} labels={"app":"whatsapp-bot","category":"CHAT_HISTORY","flow_stage":"0_unknown","level":"ERROR"} timestamp="2025-07-23T13:32:33.679Z"
[2025-07-23T08:32:33.679Z] [SUCCESS] CONTEXT_FUNCTION [unknown.ts]: Contexto obtenido exitosamente | {"contextLevel":"recent_60","messageCount":60,"contextLength":52}
2025-07-23T13:32:33.682397543Z [INFO] [FUNCTION_HANDLER] function_success jsonPayload={"category":"FUNCTION_HANDLER","environment":"cloud-run","flow":{"stage":"0_unknown"},"functionName":"get_conversation_context","level":"INFO","resultLength":187,"shortUserId":"573003913251","status":"success","timestamp":"2025-07-23T13:32:33.679Z","toolCallId":"call_KqeW1Qfb1f4ItMH8QcgNbfAU"} labels={"app":"whatsapp-bot","category":"FUNCTION_HANDLER","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:32:33.679Z"
[2025-07-23T08:32:33.679Z] [SUCCESS] CONTEXT_FUNCTION [unknown.ts]: Contexto obtenido exitosamente | {"contextLevel":"recent_60","messageCount":60,"contextLength":52}
2025-07-23T13:32:37.690347986Z [INFO] [TOOL_OUTPUTS_SUBMITTED] Tool outputs enviados a OpenAI jsonPayload={"category":"TOOL_OUTPUTS_SUBMITTED","environment":"cloud-run","flow":{"stage":"6_ai_request"},"level":"INFO","outputs":[{"id":"call_KqeW1Qfb1f4ItMH8QcgNbfAU","outputLength":187,"outputPreview":"{\"success\":true,\"context\":\"No hay mensajes disponibles para el nivel recent_60.\",\"context_level\":\"re..."}],"runId":"run_mNPyXijSSN8nKp18pzP23mTa","shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:32:37.629Z","totalOutputs":1} labels={"app":"whatsapp-bot","category":"TOOL_OUTPUTS_SUBMITTED","flow_stage":"6_ai_request","level":"INFO"} timestamp="2025-07-23T13:32:37.629Z"
2025-07-23T13:32:37.690382190Z [INFO] [POST_SUBMIT_STATUS] Status después de submit tool outputs jsonPayload={"category":"POST_SUBMIT_STATUS","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","runId":"run_mNPyXijSSN8nKp18pzP23mTa","runStatus":"requires_action","shortUserId":"573003913251","timestamp":"2025-07-23T13:32:37.629Z"} labels={"app":"whatsapp-bot","category":"POST_SUBMIT_STATUS","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:32:37.629Z"
2025-07-23T13:32:38.909936236Z [INFO] [POST_TOOL_POLLING] Polling post-tool - Intento 1/5 jsonPayload={"attempt":1,"category":"POST_TOOL_POLLING","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","runId":"run_mNPyXijSSN8nKp18pzP23mTa","shortUserId":"573003913251","status":"in_progress","timestamp":"2025-07-23T13:32:38.904Z"} labels={"app":"whatsapp-bot","category":"POST_TOOL_POLLING","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:32:38.904Z"
2025-07-23T13:32:40.305291432Z [INFO] [POST_TOOL_POLLING] Polling post-tool - Intento 2/5 jsonPayload={"attempt":2,"category":"POST_TOOL_POLLING","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","runId":"run_mNPyXijSSN8nKp18pzP23mTa","shortUserId":"573003913251","status":"in_progress","timestamp":"2025-07-23T13:32:40.301Z"} labels={"app":"whatsapp-bot","category":"POST_TOOL_POLLING","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:32:40.301Z"
2025-07-23T13:32:42.852175540Z [INFO] [POST_TOOL_POLLING] Polling post-tool - Intento 3/5 jsonPayload={"attempt":3,"category":"POST_TOOL_POLLING","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","runId":"run_mNPyXijSSN8nKp18pzP23mTa","shortUserId":"573003913251","status":"in_progress","timestamp":"2025-07-23T13:32:42.831Z"} labels={"app":"whatsapp-bot","category":"POST_TOOL_POLLING","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:32:42.831Z"
2025-07-23T13:32:46.142473785Z [INFO] [POST_TOOL_POLLING] Polling post-tool - Intento 4/5 jsonPayload={"attempt":4,"category":"POST_TOOL_POLLING","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","runId":"run_mNPyXijSSN8nKp18pzP23mTa","shortUserId":"573003913251","status":"completed","timestamp":"2025-07-23T13:32:46.141Z"} labels={"app":"whatsapp-bot","category":"POST_TOOL_POLLING","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:32:46.141Z"
2025-07-23T13:32:46.142515721Z [INFO] [POST_TOOL_POLLING_COMPLETE] Polling post-tool completado jsonPayload={"attempts":3,"category":"POST_TOOL_POLLING_COMPLETE","environment":"cloud-run","finalStatus":"completed","flow":{"stage":"0_unknown"},"level":"INFO","runId":"run_mNPyXijSSN8nKp18pzP23mTa","shortUserId":"573003913251","timestamp":"2025-07-23T13:32:46.141Z"} labels={"app":"whatsapp-bot","category":"POST_TOOL_POLLING_COMPLETE","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:32:46.141Z"
2025-07-23T13:32:46.438291219Z [INFO] [FUNCTION_CALLING_RESPONSE] Respuesta final recibida después de function calling jsonPayload={"category":"FUNCTION_CALLING_RESPONSE","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"SUCCESS","responseLength":118,"shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:32:46.422Z","toolCallsExecuted":1} labels={"app":"whatsapp-bot","category":"FUNCTION_CALLING_RESPONSE","flow_stage":"0_unknown","level":"SUCCESS"} timestamp="2025-07-23T13:32:46.422Z"
✅ [TOOL_SUCCESS] Respuesta recibida después de 1 tool calls
2025-07-23T13:32:46.438370436Z [INFO] [WHATSAPP_SEND] Enviando mensaje a 573003913251 jsonPayload={"category":"WHATSAPP_SEND","chatId":"573003913251@s.whatsapp.net","environment":"cloud-run","flow":{"stage":"8_send"},"level":"INFO","messageLength":118,"preview":"No tengo mensajes disponibles de los últimos días. Si necesitas algún detalle específico, estoy aquí...","timestamp":"2025-07-23T13:32:46.423Z"} labels={"app":"whatsapp-bot","category":"WHATSAPP_SEND","flow_stage":"8_send","level":"INFO"} timestamp="2025-07-23T13:32:46.423Z"
2025-07-23T13:32:46.739Z ✅ [573003913251] Mensaje enviado
2025-07-23T13:32:46.742273366Z [INFO] [QUEUE_ITEM_SUCCESS] Mensaje procesado exitosamente jsonPayload={"category":"QUEUE_ITEM_SUCCESS","environment":"cloud-run","flow":{"sequence":3,"stage":"0_unknown"},"level":"SUCCESS","messageId":"msg_1753277546789_b0bwx7w20","processedCount":1,"remainingInQueue":0,"timestamp":"2025-07-23T13:32:46.739Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_ITEM_SUCCESS","flow_stage":"0_unknown","level":"SUCCESS","message_id":"msg_1753277546789_b0bwx7w20","user_id":"573003913251"} timestamp="2025-07-23T13:32:46.739Z"
2025-07-23T13:32:46.742316772Z [INFO] [LOCK_ALREADY_RELEASED] Lock ya liberado para usuario jsonPayload={"activeLocks":0,"category":"LOCK_ALREADY_RELEASED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"TRACE","timestamp":"2025-07-23T13:32:46.739Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"LOCK_ALREADY_RELEASED","flow_stage":"0_unknown","level":"TRACE","user_id":"573003913251"} timestamp="2025-07-23T13:32:46.739Z"
2025-07-23T13:32:46.742349941Z [INFO] [QUEUE_PROCESSING_COMPLETE] Cola de usuario procesada completamente jsonPayload={"averageTimePerMessage":"19949ms","category":"QUEUE_PROCESSING_COMPLETE","environment":"cloud-run","errorCount":0,"flow":{"stage":"0_unknown"},"initialQueueLength":1,"level":"SUCCESS","processedCount":1,"processingDuration":"19949ms","remainingQueues":0,"timestamp":"2025-07-23T13:32:46.739Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_PROCESSING_COMPLETE","flow_stage":"0_unknown","level":"SUCCESS","user_id":"573003913251"} timestamp="2025-07-23T13:32:46.739Z"
2025-07-23T13:32:47.622613074Z [INFO] [WEBHOOK] Procesando 1 mensajes del webhook jsonPayload={"category":"WEBHOOK","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","messageCount":1,"timestamp":"2025-07-23T13:32:47.622Z"} labels={"app":"whatsapp-bot","category":"WEBHOOK","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:32:47.622Z"
📨 Webhook: 1 mensajes recibidos
2025-07-23T13:33:07.624440721Z [INFO] [PRESENCE_EVENT] Procesando 1 eventos de presencia jsonPayload={"category":"PRESENCE_EVENT","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","presenceCount":1,"timestamp":"2025-07-23T13:33:07.413Z"} labels={"app":"whatsapp-bot","category":"PRESENCE_EVENT","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:33:07.413Z"
2025-07-23T13:33:07.624520372Z [INFO] [PRESENCE_RECEIVED] Presencia para 573003913251: typing jsonPayload={"category":"PRESENCE_RECEIVED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","status":"typing","timestamp":"2025-07-23T13:33:07.414Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"PRESENCE_RECEIVED","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:33:07.414Z"
📨 Webhook: 1 mensajes recibidos
2025-07-23T13:33:10.365674675Z [INFO] [WEBHOOK] Procesando 1 mensajes del webhook jsonPayload={"category":"WEBHOOK","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","messageCount":1,"timestamp":"2025-07-23T13:33:10.360Z"} labels={"app":"whatsapp-bot","category":"WEBHOOK","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:33:10.360Z"
2025-07-23T13:33:10.365706542Z [INFO] [MESSAGE_RECEIVED] Mensaje recibido jsonPayload={"body":"Oki...","category":"MESSAGE_RECEIVED","chatId":"573003913251@s.whatsapp.net","environment":"cloud-run","flow":{"stage":"1_receive"},"from":"573003913251","level":"INFO","timestamp":1753277589,"type":"text","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"MESSAGE_RECEIVED","flow_stage":"1_receive","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:33:10.360Z"
📥 [BUFFER] 573003913251: "Oki..." → ⏳ 5s...
2025-07-23T13:33:10.365746661Z [INFO] [GLOBAL_BUFFER_ADD] Mensaje agregado al buffer global jsonPayload={"bufferSize":1,"category":"GLOBAL_BUFFER_ADD","delay":5000,"environment":"cloud-run","flow":{"stage":"0_unknown"},"isMedia":false,"level":"INFO","messageText":"Oki...","timestamp":"2025-07-23T13:33:10.360Z","userJid":"573003913251","userName":"573003913251"} labels={"app":"whatsapp-bot","category":"GLOBAL_BUFFER_ADD","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:33:10.360Z"
2025-07-23T13:33:15.362918646Z [INFO] [GLOBAL_BUFFER_PROCESS] Procesando buffer global después de 5 segundos jsonPayload={"category":"GLOBAL_BUFFER_PROCESS","combinedText":"Oki...","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","messageCount":1,"timestamp":"2025-07-23T13:33:15.362Z","userJid":"573003913251","userName":"573003913251"} labels={"app":"whatsapp-bot","category":"GLOBAL_BUFFER_PROCESS","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:33:15.362Z"
2025-07-23T13:33:17.078584238Z [INFO] [QUEUE_ITEM_ADDED] Mensaje agregado a cola de usuario jsonPayload={"category":"QUEUE_ITEM_ADDED","environment":"cloud-run","flow":{"sequence":1,"stage":"0_unknown"},"hasActiveLock":false,"level":"INFO","messageId":"msg_1753277597069_hx3cpg3z8","queueLength":1,"timestamp":"2025-07-23T13:33:17.069Z","totalQueues":1,"userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_ITEM_ADDED","flow_stage":"0_unknown","level":"INFO","message_id":"msg_1753277597069_hx3cpg3z8","user_id":"573003913251"} timestamp="2025-07-23T13:33:17.069Z"
2025-07-23T13:33:17.078628975Z [INFO] [QUEUE_PROCESSING_START] Procesando cola de usuario jsonPayload={"category":"QUEUE_PROCESSING_START","environment":"cloud-run","flow":{"stage":"0_unknown"},"hasActiveLock":false,"level":"INFO","queueLength":1,"timestamp":"2025-07-23T13:33:17.069Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_PROCESSING_START","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:33:17.069Z"
2025-07-23T13:33:17.078671219Z [INFO] [QUEUE_ITEM_PROCESSING] Procesando mensaje de cola jsonPayload={"category":"QUEUE_ITEM_PROCESSING","environment":"cloud-run","flow":{"sequence":2,"stage":"0_unknown"},"level":"TRACE","messageId":"msg_1753277597069_hx3cpg3z8","remainingInQueue":0,"timestamp":"2025-07-23T13:33:17.069Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_ITEM_PROCESSING","flow_stage":"0_unknown","level":"TRACE","message_id":"msg_1753277597069_hx3cpg3z8","user_id":"573003913251"} timestamp="2025-07-23T13:33:17.069Z"
2025-07-23T13:33:24.442749221Z [INFO] [OPENAI_REQUEST] starting_process jsonPayload={"category":"OPENAI_REQUEST","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","timestamp":"2025-07-23T13:33:24.437Z"} labels={"app":"whatsapp-bot","category":"OPENAI_REQUEST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:33:24.437Z"
2025-07-23T13:33:24.442797645Z [INFO] [THREAD_REUSE] Thread reutilizado para 573003913251 jsonPayload={"category":"THREAD_REUSE","chatId":"573003913251@s.whatsapp.net","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:33:24.438Z","userName":"573003913251"} labels={"app":"whatsapp-bot","category":"THREAD_REUSE","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:33:24.438Z"
2025-07-23T13:33:24.442807758Z [INFO] [HISTORY_INJECTION_COMPLETED] Inyección de historial completada jsonPayload={"category":"HISTORY_INJECTION_COMPLETED","contextLength":0,"environment":"cloud-run","flow":{"stage":"0_unknown"},"historyLines":0,"labelsCount":0,"level":"SUCCESS","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:33:24.438Z","tokensUsed":0,"userId":"573003913251"} labels={"app":"whatsapp-bot","category":"HISTORY_INJECTION_COMPLETED","flow_stage":"0_unknown","level":"SUCCESS","user_id":"573003913251"} timestamp="2025-07-23T13:33:24.438Z"
2025-07-23T13:33:24.442837127Z [INFO] [HISTORY_SKIP] Skip fetch historial: Thread existe jsonPayload={"category":"HISTORY_SKIP","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","reason":"thread_already_exists","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:33:24.438Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"HISTORY_SKIP","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:33:24.438Z"
2025-07-23T13:33:24.442873663Z [INFO] [HISTORY_INJECTION_SKIP] Saltando inyección - thread existente sin necesidad de contexto jsonPayload={"category":"HISTORY_INJECTION_SKIP","environment":"cloud-run","flow":{"stage":"0_unknown"},"hasContextAnalysis":false,"isNewThread":false,"level":"INFO","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:33:24.438Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"HISTORY_INJECTION_SKIP","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:33:24.438Z"
2025-07-23T13:33:24.995003199Z [INFO] [CONTEXT_CACHE_HIT] Contexto temporal desde cache jsonPayload={"cacheAge":686,"category":"CONTEXT_CACHE_HIT","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","timestamp":"2025-07-23T13:33:24.991Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"CONTEXT_CACHE_HIT","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-23T13:33:24.991Z"
2025-07-23T13:33:24.995049662Z [INFO] [CONTEXT_DEBUG] Contexto enviado a OpenAI jsonPayload={"category":"CONTEXT_DEBUG","contextPreview":"Fecha: 23/07/2025 | Hora: 8:21 AM (Colombia)\nCliente: Sr Alex | Contacto WhatsApp: Sr Alex | Status: Colega Jefe, cotización\n---\nMensaje del cliente:\n","environment":"cloud-run","flow":{"stage":"0_unknown"},"isVoiceMessage":false,"level":"INFO","messagePreview":"Oki","shortUserId":"573003913251","timestamp":"2025-07-23T13:33:24.991Z","totalLength":153} labels={"app":"whatsapp-bot","category":"CONTEXT_DEBUG","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:33:24.991Z"
2025-07-23T13:33:25.358762888Z [INFO] [OPENAI_REQUEST] message_added_with_context jsonPayload={"category":"OPENAI_REQUEST","contextLength":150,"environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","originalLength":3,"shortUserId":"573003913251","timestamp":"2025-07-23T13:33:25.358Z","totalLength":153} labels={"app":"whatsapp-bot","category":"OPENAI_REQUEST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:33:25.358Z"
2025-07-23T13:33:25.358793165Z [INFO] [OPENAI_REQUEST] creating_run jsonPayload={"category":"OPENAI_REQUEST","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","timestamp":"2025-07-23T13:33:25.358Z"} labels={"app":"whatsapp-bot","category":"OPENAI_REQUEST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:33:25.358Z"
2025-07-23T13:33:27.942953664Z [INFO] [OPENAI_REQUEST] run_started jsonPayload={"category":"OPENAI_REQUEST","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","timestamp":"2025-07-23T13:33:27.939Z"} labels={"app":"whatsapp-bot","category":"OPENAI_REQUEST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:33:27.939Z"
2025-07-23T13:33:34.541864196Z [INFO] [OPENAI_RUN_COMPLETED] Run completado para 573003913251 jsonPayload={"category":"OPENAI_RUN_COMPLETED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"SUCCESS","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:33:34.538Z"} labels={"app":"whatsapp-bot","category":"OPENAI_RUN_COMPLETED","flow_stage":"0_unknown","level":"SUCCESS"} timestamp="2025-07-23T13:33:34.538Z"
2025-07-23T13:33:34.541919473Z [INFO] [TOKEN_USAGE] Tokens utilizados jsonPayload={"category":"TOKEN_USAGE","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:33:34.538Z","totalTokens":2934} labels={"app":"whatsapp-bot","category":"TOKEN_USAGE","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:33:34.538Z"
2025-07-23T13:33:34.541966301Z [INFO] [OPENAI_USAGE] Run completado con métricas jsonPayload={"category":"OPENAI_USAGE","completionTokens":25,"contextTokens":0,"durationMs":10101,"environment":"cloud-run","flow":{"stage":"6_ai_request"},"level":"INFO","promptTokens":2909,"runId":"run_S9ExS23EA7HazVdQuioplAk9","shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:33:34.538Z","tokensPerSecond":290,"totalTokens":2934} labels={"app":"whatsapp-bot","category":"OPENAI_USAGE","flow_stage":"6_ai_request","level":"INFO"} timestamp="2025-07-23T13:33:34.538Z"
2025-07-23T13:33:34.542002469Z [INFO] [OPENAI_LATENCY] Latencia del procesamiento jsonPayload={"category":"OPENAI_LATENCY","durationSeconds":"10.10","environment":"cloud-run","flow":{"stage":"6_ai_request"},"isHighLatency":false,"level":"INFO","shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:33:34.538Z","totalDurationMs":10101} labels={"app":"whatsapp-bot","category":"OPENAI_LATENCY","flow_stage":"6_ai_request","level":"INFO"} timestamp="2025-07-23T13:33:34.538Z"
2025-07-23T13:33:34.683381662Z [INFO] [OPENAI_RESPONSE] response_received jsonPayload={"category":"OPENAI_RESPONSE","environment":"cloud-run","flow":{"stage":"7_ai_response"},"level":"INFO","responseLength":85,"shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:33:34.679Z"} labels={"app":"whatsapp-bot","category":"OPENAI_RESPONSE","flow_stage":"7_ai_response","level":"INFO"} timestamp="2025-07-23T13:33:34.679Z"
2025-07-23T13:33:34.683440723Z [INFO] [PERFORMANCE_METRICS] Procesamiento completado exitosamente jsonPayload={"category":"PERFORMANCE_METRICS","contextTokens":0,"environment":"cloud-run","flow":{"stage":"9_complete"},"isEfficient":false,"level":"INFO","memory":{"heapTotalMB":33,"heapUsedMB":29,"rssMB":88},"responseLength":85,"shortUserId":"573003913251","threadId":"thread_exUYZMLgOdJNSpeszyS0wcyS","timestamp":"2025-07-23T13:33:34.680Z","tokensPerSecond":286,"totalDurationMs":10242,"totalTokens":2934} labels={"app":"whatsapp-bot","category":"PERFORMANCE_METRICS","flow_stage":"9_complete","level":"INFO"} timestamp="2025-07-23T13:33:34.680Z"
2025-07-23T13:33:34.683488274Z [INFO] [WHATSAPP_SEND] Enviando mensaje a 573003913251 jsonPayload={"category":"WHATSAPP_SEND","chatId":"573003913251@s.whatsapp.net","environment":"cloud-run","flow":{"stage":"8_send"},"level":"INFO","messageLength":85,"preview":"¡Perfecto! Si necesitas algo más, no dudes en decírmelo. Estoy aquí para ayudarte. 😊...","timestamp":"2025-07-23T13:33:34.680Z"} labels={"app":"whatsapp-bot","category":"WHATSAPP_SEND","flow_stage":"8_send","level":"INFO"} timestamp="2025-07-23T13:33:34.680Z"
2025-07-23T13:33:35.009Z ✅ [573003913251] Mensaje enviado
2025-07-23T13:33:35.010965061Z [INFO] [QUEUE_ITEM_SUCCESS] Mensaje procesado exitosamente jsonPayload={"category":"QUEUE_ITEM_SUCCESS","environment":"cloud-run","flow":{"sequence":3,"stage":"0_unknown"},"level":"SUCCESS","messageId":"msg_1753277597069_hx3cpg3z8","processedCount":1,"remainingInQueue":0,"timestamp":"2025-07-23T13:33:35.009Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_ITEM_SUCCESS","flow_stage":"0_unknown","level":"SUCCESS","message_id":"msg_1753277597069_hx3cpg3z8","user_id":"573003913251"} timestamp="2025-07-23T13:33:35.009Z"
2025-07-23T13:33:35.011000734Z [INFO] [LOCK_ALREADY_RELEASED] Lock ya liberado para usuario jsonPayload={"activeLocks":0,"category":"LOCK_ALREADY_RELEASED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"TRACE","timestamp":"2025-07-23T13:33:35.009Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"LOCK_ALREADY_RELEASED","flow_stage":"0_unknown","level":"TRACE","user_id":"573003913251"} timestamp="2025-07-23T13:33:35.009Z"
2025-07-23T13:33:35.011045673Z [INFO] [QUEUE_PROCESSING_COMPLETE] Cola de usuario procesada completamente jsonPayload={"averageTimePerMessage":"17940ms","category":"QUEUE_PROCESSING_COMPLETE","environment":"cloud-run","errorCount":0,"flow":{"stage":"0_unknown"},"initialQueueLength":1,"level":"SUCCESS","processedCount":1,"processingDuration":"17940ms","remainingQueues":0,"timestamp":"2025-07-23T13:33:35.009Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_PROCESSING_COMPLETE","flow_stage":"0_unknown","level":"SUCCESS","user_id":"573003913251"} timestamp="2025-07-23T13:33:35.009Z"
📨 Webhook: 1 mensajes recibidos
2025-07-23T13:33:35.908639426Z [INFO] [WEBHOOK] Procesando 1 mensajes del webhook jsonPayload={"category":"WEBHOOK","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","messageCount":1,"timestamp":"2025-07-23T13:33:35.906Z"} labels={"app":"whatsapp-bot","category":"WEBHOOK","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-23T13:33:35.906Z"
