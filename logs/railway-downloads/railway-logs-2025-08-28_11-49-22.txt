Starting Container

> tealquilamos-bot@1.0.0 start
> node dist/main.js

üöÄ Starting TeAlquilamos Bot...
2025-08-28T16:49:13Z [APP_STAR:unknown] sys: Iniciando TeAlquilamos Bot
‚úÖ Configuration loaded successfully
2025-08-28T16:49:13Z [CONFIG_L:unknown] sys: Configuraci√≥n cargada exitosamente
üåç Server will start on 0.0.0.0:8080
üîß DI ‚úì 5 services, 1 function
üîå hotel-plugin registering 8 functions...
‚úÖ informar_movimiento_manana registered
‚úÖ generate_booking_confirmation_pdf registered
‚úÖ generate_payment_receipt_pdf registered
üîå hotel-plugin ‚úì 8 functions registered successfully
2025-08-28T16:49:13Z [PLUGIN_R:unknown] sys: hotel-plugin ‚úì 8 functions
2025-08-28T16:49:13Z [DI_COMPL:unknown] sys: DI ‚úì 2 services, 1 function (CRM jobs de...
‚úÖ check_availability registered
‚úÖ check_booking_details registered
‚úÖ create_new_booking registered
‚úÖ edit_booking registered
‚úÖ cancel_booking registered
Cache unificado inyectado en DB service - MemoryStore eliminado
2025-08-28T16:49:13Z [WEBHOOK_:unknown] sys: WebhookRouter inicializado
2025-08-28T16:49:13Z [DATABASE:database] sys: üóÑÔ∏è Conectado a la base de datos Postgre...
2025-08-28T16:49:13Z [DATABASE:unknown] sys: Conexi√≥n exitosa a PostgreSQL
2025-08-28T16:49:13Z [SYNC_DEP:unknown] sys: Sync deprecado - Cache unificado mantien...
2025-08-28T16:49:13Z [CONTEXT_:unknown] sys: Cache limpiado post-reinicio para contex...
üîß Cleanup tasks configured
2025-08-28T16:49:13Z [SERVER_S:unknown] sys: Servidor HTTP iniciado
=== Bot TeAlquilamos Iniciado ===
üöÄ Servidor: 0.0.0.0:8080
üîó Webhook: configurando...
‚úÖ Sistema listo

üöÄ CoreBot started successfully on 0.0.0.0:8080
üìä Functions registered: 8
2025-08-28T16:49:13Z [BOT_READ:unknown] sys: Bot completamente inicializado
2025-08-28T16:49:47Z [WEBHOOK_:unknown] sys: Webhook enrutado
2025-08-28T16:49:47Z [WEBHOOK_:unknown] sys: Procesando webhook [MAIN]
2025-08-28T16:49:47Z [WEBHOOK:webhook] pres:1
2025-08-28T16:49:47Z [BUFFER_E:unknown] 57300...251: Evento de presencia detectado [MAIN]
2025-08-28T16:49:47Z [BUFFER_T:unknown] 57300...251: Timeout configurado por processor
‚úçÔ∏è Usuario est√° escribiendo...
2025-08-28T16:49:48Z [WEBHOOK_:unknown] sys: Webhook enrutado
2025-08-28T16:49:48Z [WEBHOOK_:unknown] sys: Procesando webhook [MAIN]
2025-08-28T16:49:48Z [WEBHOOK:webhook] msg:1
2025-08-28T16:49:48Z [NEW_USER:unknown] sys: Usuario nuevo detectado - enriquecimient...
2025-08-28T16:49:48Z [USERNAME:unknown] sys: Actualizando userName desde from_name
2025-08-28T16:49:48Z [RECONCIL:unknown] sys: Cliente creado por reconciliaci√≥n
WEBHOOK_CACHE_SYNC: Updated clientCache for 573003913251, preserving threadId: null
2025-08-28T16:49:48Z [CLIENT_U:unknown] sys: Cliente actualizado desde webhook [MAIN]
2025-08-28T16:49:48Z [DELAYED_:unknown] 57300...251: Update programado para 2min
2025-08-28T16:49:48Z [SYNC_ENR:unknown] sys: Enriquecimiento s√≠ncrono para usuario nu...
2025-08-28T16:49:49Z [USER_ENR:database] sys: Labels actualizados autom√°ticamente: 573...
2025-08-28T16:49:49Z [DB_QUERY:database] 57300...251: type:enrich time:769ms res:labels=2 cache:updated
2025-08-28T16:49:49Z [SYNC_ENR:unknown] sys: Usuario enriquecido s√≠ncronamente [MAIN]
2025-08-28T16:49:49Z [MSG_RX:webhook] 57300...251: text "Hola ejecuta la func..."
üó£Ô∏è Sr Alex: üí¨ "Hola ejecuta la funci√≥n de generar PDF de confirmaci√≥n para ..." ‚Üí ü§ñ
2025-08-28T16:49:49Z [BUFFER_C:unknown] 57300...251: Buffer creado para mensaje
2025-08-28T16:49:49Z [BUFFER_S:buffer] 57300...251: Mensaje agregado, estado actual buffer
2025-08-28T16:49:49Z [BUFFER_S:unknown] 57300...251: Buffer esperando agrupaci√≥n
2025-08-28T16:49:54Z [BUFFER:buffer] 57300...251: 1msg, 79ch
2025-08-28T16:49:54Z [MESSAGE_:webhook] 57300...251: Iniciando procesamiento de buffer
2025-08-28T16:49:54Z [CACHE_HIT:cache] 57300...251
2025-08-28T16:49:54Z [CONTEXT_:unknown] 57300...251: Contexto completo enviado a OpenAI
2025-08-28T16:49:54Z [OPENAI_M:unknown] 57300...251: Mensaje preparado para OpenAI
CACHE_GET: key=573003913251, found=true, size=1
Cache HIT for thread: 573003913251
CACHE_DEBUG: threadId=null, tokenCount=0, cachedAt=Thu Aug 28 2025 16:49:54 GMT+0000 (Coordinated Universal Time)
Cache HIT but no threadId - checking BD as fallback: 573003913251
2025-08-28T16:49:54Z [DB_QUERY:database] 57300...251: type:thread_fetch time:10ms res:thread:... cache:no_change
BD HIT (cache miss) for thread: 573003913251, syncing cache
[THREAD_SOURCE:cache] 573003913251: bd:0 cache:0 thread: src:bd_fallback
CACHE_SET: stored for 573003913251, size: 1
CACHE_SET_DEBUG: threadId=, tokenCount=0
2025-08-28T16:49:54Z [OPENAI_R:unknown] 57300...251: Iniciando run de OpenAI
2025-08-28T16:49:54Z [ASSISTAN:unknown] 57300...251: Assistant seleccionado para procesamient...
2025-08-28T16:49:54Z [ASSISTAN:unknown] 57300...251: Assistant ID efectivo para procesamiento
2025-08-28T16:49:54Z [OPENAI_C:unknown] 57300...251: Estado de concurrencia OpenAI
2025-08-28T16:49:54Z [AI_START:openai] 57300...251 | null
2025-08-28T16:49:55Z [THR_NEW:unknown] th_threa...FEj
2025-08-28T16:49:56Z [OPENAI_P:unknown] 57300...251: Prompt completo compactado enviado a Ope...
[OPENAI_RAW_CONTENT] 573003913251: "Cliente: NOHAYREGISTRO\nTags: NOHAYREGISTRO\nHora actual: 28 de ago de 2025, 11:49 a. m.\n\nMensaje del cliente:\nHola ejecuta..." (193ch total)
2025-08-28T16:49:56Z [OPENAI_M:openai] 57300...251: Mensaje enviado al thread de OpenAI
2025-08-28T16:49:56Z [MODEL_DE:unknown] sys: Usando configuraci√≥n por defecto del Ass...
2025-08-28T16:49:57Z [OPENAI_P:unknown] sys: Esperando respuesta - status: queued
2025-08-28T16:50:03Z [OPENAI_P:unknown] sys: Esperando respuesta - status: in_progres...
2025-08-28T16:50:09Z [OPENAI_P:unknown] sys: Esperando respuesta - status: requires_a...
2025-08-28T16:50:09Z [RUN_REQU:unknown] sys: Run requiere action para function callin...
[4:50:09 PM] ‚ÑπÔ∏è Processing 1 function calls for Sr Alex
2025-08-28T16:50:09Z [FUNC:functions] unknown()
[4:50:09 PM] ‚öôÔ∏è generate_booking_confirmation_pdf()
2025-08-28T16:50:09Z [OPENAI_F:unknown] sys: Llamando funci√≥n desde OpenAI
2025-08-28T16:50:09Z [FUNCTION:unknown] sys: Ejecutando funci√≥n generate_booking_conf...
2025-08-28T16:50:09Z [FUNCTION:unknown] 57300...251: Contexto pasado a funci√≥n
üîß Executing function: generate_booking_confirmation_pdf
2025-08-28T16:50:09Z [USER_CON:unknown] sys: üîç UserContext recibido en funci√≥n
2025-08-28T16:50:09Z [GENERATE:unknown] sys: üöÄ Iniciando generaci√≥n PDF para reserva...
2025-08-28T16:50:09Z [GENERATE:unknown] sys: üîç Consultando datos reales de la reserv...
2025-08-28T16:50:09Z [FETCH_BO:unknown] sys: üîç Consultando reserva directamente: 747...
2025-08-28T16:50:09Z [BEDS24_A:unknown] sys: GET https://api.beds24.com/v2/bookings?b...
2025-08-28T16:50:10Z [BEDS24:beds24] 0 rooms found
2025-08-28T16:50:10Z [BEDS24_C:beds24] sys: B√∫squeda de reservas exitosa
2025-08-28T16:50:10Z [FETCH_BO:unknown] sys: API Response structure: {"success":true,...
2025-08-28T16:50:10Z [FETCH_BO:unknown] sys: Booking espec√≠fico encontrado: {"id":747...
2025-08-28T16:50:11Z [PROCESS_:unknown] sys: Datos procesados: {"id":74793397,"name":...
2025-08-28T16:50:11Z [FETCH_BO:unknown] sys: ‚úÖ Reserva encontrada exitosamente
2025-08-28T16:50:11Z [GENERATE:unknown] sys: ‚ö†Ô∏è Canal no clasificado, permitiendo: Un...
2025-08-28T16:50:11Z [TRAN:unknown] sys: üí∞ PAYMENTS PROCESADOS: 1 pagos
2025-08-28T16:50:11Z [GENERATE:unknown] sys: üöÄ Iniciando generaci√≥n PDF para reserva...
2025-08-28T16:50:11Z [GENERATE:unknown] sys: üìã Datos procesados - Tipo: CONFIRMACI√ìN...
2025-08-28T16:50:11Z [PDF_LIFE:unknown] sys: üõ°Ô∏è Handlers de Graceful Shutdown regist...
2025-08-28T16:50:11Z [PDF_LIFE:unknown] sys: üöÄ PDFGeneratorService inicializado con ...
2025-08-28T16:50:11Z [PDF_GENE:unknown] sys: Generando PDF para reserva: 74793397
2025-08-28T16:50:11Z [PDF_GENE:unknown] sys: Error generando PDF: Error cargando temp...
2025-08-28T16:50:11Z [GENERATE:unknown] sys: ‚ùå Fall√≥ generaci√≥n PDF: Error cargando t...
2025-08-28T16:50:11Z [GENERATE:unknown] sys: ‚úÖ PDF generado exitosamente
‚úÖ Function generate_booking_confirmation_pdf completed in 1372ms
2025-08-28T16:50:11Z [PLUGIN_R:unknown] sys: Respuesta completa de funci√≥n enviada a ...
2025-08-28T16:50:11Z [FUNCTION:functions] sys: Funci√≥n generate_booking_confirmation_pd...
2025-08-28T16:50:11Z [OPENAI_T:unknown] sys: Enviando tool outputs exactos a OpenAI
2025-08-28T16:50:12Z [TOOL_OUT:unknown] sys: Tool outputs enviados a OpenAI
2025-08-28T16:50:12Z [SYS_METRIC:system] sys: mem:28/512MB cpu:0% conn:0 uptime:0h1m activeUsers:0
2025-08-28T16:50:12Z [CACHE_METRIC:cache] sys: hits:100% misses:0% size:0MB users:0 evicts:0
2025-08-28T16:50:12Z [BUFFER_METRIC:buffer] sys: active:0 merged:0 abandoned:0 voice:0 text:0
2025-08-28T16:50:12Z [USAGE_STATS:system] sys: msgs:0/hr chunks:0 avgLen:0ch funcs:0 errs:0
2025-08-28T16:50:12Z [OPENAI_P:unknown] sys: Esperando respuesta - status: queued
2025-08-28T16:50:13Z [BUFFER_METRIC:buffer] sys: active:1 merged:0 abandoned:0 voice:0 text:0
2025-08-28T16:50:18Z [OPENAI_P:unknown] sys: Esperando respuesta - status: in_progres...
2025-08-28T16:50:25Z [OPENAI_P:unknown] sys: Esperando respuesta - status: in_progres...
2025-08-28T16:50:29Z [OPENAI_P:unknown] sys: Esperando respuesta - status: completed
2025-08-28T16:50:29Z [FUNCTION:unknown] sys: Respuesta recibida despu√©s de function c...
2025-08-28T16:50:30Z [AI_DONE:openai] 57300...251 | th_threa...FEj | 36s | 
2025-08-28T16:50:30Z [OPENAI_R:openai] 57300...251: Respuesta completa de OpenAI
2025-08-28T16:50:30Z [HIGH_LAT:performance] 57300...251: Latencia alta detectada en procesamiento
2025-08-28T16:50:30Z [OPENAI_R:unknown] 57300...251: Run de OpenAI completado
2025-08-28T16:50:30Z [DEBUG_FU:unknown] 57300...251: FunctionCalls: true
2025-08-28T16:50:30Z [DEBUG_FU:unknown] 57300...251: Detalles de functionCalls
2025-08-28T16:50:30Z [ATTACHME:unknown] 57300...251: Buscando attachments en functionCalls
2025-08-28T16:50:30Z [ATTACHME:unknown] 57300...251: Analizando funcCall individual
2025-08-28T16:50:30Z [FUNCTION:unknown] 57300...251: Estructura completa del resultado
New thread created for 573003913251: thread_9dLk8nHboVO0CPWqUwP1PFEj, resetting tokenCount
2025-08-28T16:50:30Z [RECONCIL:unknown] 57300...251: Registro actualizado por reconciliaci√≥n
2025-08-28T16:50:30Z [THREAD_S:unknown] 57300...251: ‚úÖ Thread guardado con l√≥gica simplificad...
2025-08-28T16:50:30Z [THREAD_METRIC:database] 57300...251: id:th_threa...FEj msgs:0 tokens:0 reused:false age:0m
2025-08-28T16:50:30Z [TOKEN_CO:unknown] sys: üìä Token count actualizado: 573003913251...
BD: Reset token count for new thread 573003913251: thread_9dLk8nHboVO0CPWqUwP1PFEj
2025-08-28T16:50:30Z [TOKEN_CO:unknown] sys: üìä Token count actualizado: 573003913251...
2025-08-28T16:50:30Z [TOKEN_RE:unknown] 57300...251: Reset tokens a 0: Nuevo thread sin relac...
2025-08-28T16:50:30Z [TOKEN_CO:unknown] 57300...251: Token count actualizado en memoria
2025-08-28T16:50:30Z [QUOTE_DE:unknown] 57300...251: Decisi√≥n de citado calculada
2025-08-28T16:50:30Z [TIMING_H:unknown] sys: Iniciando timing por chunks
2025-08-28T16:50:30Z [WHAPI_CH:whapi] 57300...net: Enviando chunk 1/1
2025-08-28T16:50:30Z [HUMAN_DE:unknown] sys: text:233ch=2000ms
2025-08-28T16:50:30Z [PRESENCE:unknown] sys: ‚úçÔ∏èch1/1:2000ms
2025-08-28T16:50:33Z [WHAPI_CH:unknown] 57300...251: Resultado env√≠o chunk
2025-08-28T16:50:33Z [WHAPI_RE:unknown] sys: Respuesta completa de WHAPI
2025-08-28T16:50:33Z [WHAPI_ID:unknown] sys: IDs colectados para chunk
2025-08-28T16:50:33Z [TIMING_H:unknown] sys: Timing humano completado
ü§ñ OpenAI ‚Üí Sr Alex (35.7s)
2025-08-28T16:50:33Z [TYPING_F:whapi] 57300...251: Flag de typing reseteado post-procesamie...
2025-08-28T16:50:33Z [SENT:webhook] 57300...251 | 233ch | 36s
2025-08-28T16:50:33Z [FLAG_RES:unknown] 57300...251: duringRunMsgId reseteado post-procesamie...
2025-08-28T16:50:34Z [WEBHOOK_:unknown] sys: Webhook enrutado
2025-08-28T16:50:34Z [WEBHOOK_:unknown] sys: Procesando webhook [MAIN]
2025-08-28T16:50:34Z [WEBHOOK:webhook] msg:1
2025-08-28T16:50:34Z [RECONCIL:unknown] sys: Cliente actualizado por reconciliaci√≥n
WEBHOOK_CACHE_SYNC: Updated clientCache for 573003913251, preserving threadId: thread_9dLk8nHboVO0CPWqUwP1PFEj
2025-08-28T16:50:34Z [CLIENT_U:unknown] sys: Cliente actualizado desde webhook [MAIN]
2025-08-28T16:50:35Z [WEBHOOK_:unknown] sys: Webhook enrutado
2025-08-28T16:50:35Z [WEBHOOK_:unknown] sys: Procesando webhook [MAIN]
2025-08-28T16:50:35Z [WEBHOOK:webhook] stat:1
2025-08-28T16:50:35Z [WEBHOOK_:unknown] sys: üì• stat:1 [MAIN]
2025-08-28T16:51:12Z [SYS_METRIC:system] sys: mem:28/512MB cpu:0% conn:0 uptime:0h2m activeUsers:1
2025-08-28T16:51:12Z [CACHE_METRIC:cache] sys: hits:100% misses:0% size:0MB users:1 evicts:0
2025-08-28T16:51:12Z [BUFFER_METRIC:buffer] sys: active:0 merged:0 abandoned:0 voice:0 text:0
2025-08-28T16:51:12Z [USAGE_STATS:system] sys: msgs:1/hr chunks:0 avgLen:188ch funcs:0 errs:0
2025-08-28T16:51:12Z [LATENCY_METRIC:system] null: openai:35688ms beds24:0ms whapi:0ms db:0ms total:35688ms
2025-08-28T16:51:13Z [BUFFER_METRIC:buffer] sys: active:0 merged:0 abandoned:0 voice:0 text:0
2025-08-28T16:51:48Z [DB_QUERY:database] 57300...251: type:thread_fetch time:12ms res:thread:thread_9... cache:no_change
2025-08-28T16:51:48Z [TOKENS_S:unknown] 57300...251: Tokens acumulados
2025-08-28T16:51:48Z [TOKEN_CO:unknown] 57300...251: Token count inv√°lido - solo actualiza la...
2025-08-28T16:51:48Z [RECONCIL:unknown] 57300...251: Thread activity actualizado por reconcil...
2025-08-28T16:51:48Z [THREAD_A:unknown] 57300...251: Thread activity + tokens actualizados: 5...
2025-08-28T16:51:48Z [DELAYED_:unknown] 57300...251: lastActivity + tokens actualizados
2025-08-28T16:52:12Z [SYS_METRIC:system] sys: mem:28/512MB cpu:0% conn:0 uptime:0h3m activeUsers:1
2025-08-28T16:52:12Z [CACHE_METRIC:cache] sys: hits:100% misses:0% size:0MB users:1 evicts:0
2025-08-28T16:52:12Z [BUFFER_METRIC:buffer] sys: active:0 merged:0 abandoned:0 voice:0 text:0
2025-08-28T16:52:12Z [USAGE_STATS:system] sys: msgs:1/hr chunks:0 avgLen:188ch funcs:0 errs:0
2025-08-28T16:52:12Z [LATENCY_METRIC:system] null: openai:35688ms beds24:0ms whapi:0ms db:0ms total:35688ms
2025-08-28T16:52:13Z [BUFFER_METRIC:buffer] sys: active:0 merged:0 abandoned:0 voice:0 text:0
2025-08-28T16:53:12Z [SYS_METRIC:system] sys: mem:29/512MB cpu:0% conn:0 uptime:0h4m activeUsers:1
2025-08-28T16:53:12Z [CACHE_METRIC:cache] sys: hits:100% misses:0% size:0MB users:1 evicts:0
2025-08-28T16:53:12Z [BUFFER_METRIC:buffer] sys: active:0 merged:0 abandoned:0 voice:0 text:0
2025-08-28T16:53:12Z [USAGE_STATS:system] sys: msgs:1/hr chunks:0 avgLen:188ch funcs:0 errs:0
2025-08-28T16:53:12Z [LATENCY_METRIC:system] null: openai:35688ms beds24:0ms whapi:0ms db:0ms total:35688ms
2025-08-28T16:53:13Z [BUFFER_METRIC:buffer] sys: active:0 merged:0 abandoned:0 voice:0 text:0
2025-08-28T16:54:12Z [SYS_METRIC:system] sys: mem:29/512MB cpu:0% conn:0 uptime:0h5m activeUsers:1
2025-08-28T16:54:12Z [CACHE_METRIC:cache] sys: hits:100% misses:0% size:0MB users:1 evicts:0
2025-08-28T16:54:12Z [BUFFER_METRIC:buffer] sys: active:0 merged:0 abandoned:0 voice:0 text:0
2025-08-28T16:54:12Z [USAGE_STATS:system] sys: msgs:1/hr chunks:0 avgLen:188ch funcs:0 errs:0
2025-08-28T16:54:12Z [LATENCY_METRIC:system] null: openai:35688ms beds24:0ms whapi:0ms db:0ms total:35688ms
2025-08-28T16:54:13Z [BUFFER_METRIC:buffer] sys: active:0 merged:0 abandoned:0 voice:0 text:0
