Starting Container

> tealquilamos-bot@1.0.0 start
> node dist/main.js

üöÄ Starting TeAlquilamos Bot...
2025-08-29T00:41:09Z [APP_STAR:unknown] sys: Iniciando TeAlquilamos Bot
‚úÖ Configuration loaded successfully
2025-08-29T00:41:09Z [CONFIG_L:unknown] sys: Configuraci√≥n cargada exitosamente
üåç Server will start on 0.0.0.0:8080
üîß DI ‚úì 5 services, 1 function
üîå hotel-plugin registering 8 functions...
‚úÖ check_availability registered
‚úÖ check_booking_details registered
‚úÖ create_new_booking registered
‚úÖ edit_booking registered
‚úÖ cancel_booking registered
‚úÖ informar_movimiento_manana registered
‚úÖ generate_booking_confirmation_pdf registered
‚úÖ generate_payment_receipt_pdf registered
üîå hotel-plugin ‚úì 8 functions registered successfully
2025-08-29T00:41:09Z [PLUGIN_R:unknown] sys: hotel-plugin ‚úì 8 functions
2025-08-29T00:41:09Z [DI_COMPL:unknown] sys: DI ‚úì 2 services, 1 function (CRM jobs de...
Cache unificado inyectado en DB service - MemoryStore eliminado
2025-08-29T00:41:09Z [WEBHOOK_:unknown] sys: WebhookRouter inicializado
2025-08-29T00:41:09Z [DATABASE:database] sys: üóÑÔ∏è Conectado a la base de datos Postgre...
2025-08-29T00:41:09Z [DATABASE:unknown] sys: Conexi√≥n exitosa a PostgreSQL
2025-08-29T00:41:09Z [SYNC_DEP:unknown] sys: Sync deprecado - Cache unificado mantien...
2025-08-29T00:41:09Z [CONTEXT_:unknown] sys: Cache limpiado post-reinicio para contex...
üîß Cleanup tasks configured
2025-08-29T00:41:09Z [SERVER_S:unknown] sys: Servidor HTTP iniciado
=== Bot TeAlquilamos Iniciado ===
üöÄ Servidor: 0.0.0.0:8080
üîó Webhook: configurando...
‚úÖ Sistema listo

üöÄ CoreBot started successfully on 0.0.0.0:8080
üìä Functions registered: 8
2025-08-29T00:41:09Z [BOT_READ:unknown] sys: Bot completamente inicializado
2025-08-29T00:41:51Z [WEBHOOK_:unknown] sys: Webhook enrutado
2025-08-29T00:41:51Z [WEBHOOK_:unknown] sys: Procesando webhook [MAIN]
2025-08-29T00:41:51Z [WEBHOOK:webhook] pres:1
2025-08-29T00:41:51Z [BUFFER_E:unknown] 57300...251: Evento de presencia detectado [MAIN]
2025-08-29T00:41:51Z [BUFFER_T:unknown] 57300...251: Timeout configurado por processor
‚úçÔ∏è Usuario est√° escribiendo...
2025-08-29T00:41:52Z [WEBHOOK_:unknown] sys: Webhook enrutado
2025-08-29T00:41:52Z [WEBHOOK_:unknown] sys: Procesando webhook [MAIN]
2025-08-29T00:41:52Z [WEBHOOK:webhook] msg:1
2025-08-29T00:41:52Z [NEW_USER:unknown] sys: Usuario nuevo detectado - enriquecimient...
2025-08-29T00:41:52Z [USERNAME:unknown] sys: Actualizando userName desde from_name
2025-08-29T00:41:52Z [RECONCIL:unknown] sys: Cliente creado por reconciliaci√≥n
WEBHOOK_CACHE_SYNC: Updated clientCache for 573003913251, preserving threadId: null
2025-08-29T00:41:52Z [CLIENT_U:unknown] sys: Cliente actualizado desde webhook [MAIN]
2025-08-29T00:41:52Z [DELAYED_:unknown] 57300...251: Update programado para 2min
2025-08-29T00:41:52Z [SYNC_ENR:unknown] sys: Enriquecimiento s√≠ncrono para usuario nu...
2025-08-29T00:41:53Z [USER_ENR:database] sys: Labels actualizados autom√°ticamente: 573...
2025-08-29T00:41:53Z [DB_QUERY:database] 57300...251: type:enrich time:745ms res:labels=2 cache:updated
2025-08-29T00:41:53Z [SYNC_ENR:unknown] sys: Usuario enriquecido s√≠ncronamente [MAIN]
2025-08-29T00:41:53Z [MSG_RX:webhook] 57300...251: text "Hola ejecuta la func..."
üó£Ô∏è Sr Alex: üí¨ "Hola ejecuta la funci√≥n de generar PDF de confirmaci√≥n para ..." ‚Üí ü§ñ
2025-08-29T00:41:53Z [BUFFER_C:unknown] 57300...251: Buffer creado para mensaje
2025-08-29T00:41:53Z [BUFFER_S:buffer] 57300...251: Mensaje agregado, estado actual buffer
2025-08-29T00:41:53Z [BUFFER_S:unknown] 57300...251: Buffer esperando agrupaci√≥n
2025-08-29T00:41:58Z [BUFFER:buffer] 57300...251: 1msg, 79ch
2025-08-29T00:41:58Z [MESSAGE_:webhook] 57300...251: Iniciando procesamiento de buffer
2025-08-29T00:41:58Z [CACHE_HIT:cache] 57300...251
2025-08-29T00:41:58Z [CONTEXT_:unknown] 57300...251: Contexto completo enviado a OpenAI
2025-08-29T00:41:58Z [OPENAI_M:unknown] 57300...251: Mensaje preparado para OpenAI
CACHE_GET: key=573003913251, found=true, size=1
Cache HIT for thread: 573003913251
CACHE_DEBUG: threadId=null, tokenCount=0, cachedAt=Fri Aug 29 2025 00:41:58 GMT+0000 (Coordinated Universal Time)
Cache HIT but no threadId - checking BD as fallback: 573003913251
2025-08-29T00:41:58Z [DB_QUERY:database] 57300...251: type:thread_fetch time:6ms res:thread:... cache:no_change
BD HIT (cache miss) for thread: 573003913251, syncing cache
[THREAD_SOURCE:cache] 573003913251: bd:0 cache:0 thread: src:bd_fallback
CACHE_SET: stored for 573003913251, size: 1
CACHE_SET_DEBUG: threadId=, tokenCount=0
2025-08-29T00:41:58Z [OPENAI_R:unknown] 57300...251: Iniciando run de OpenAI
2025-08-29T00:41:58Z [ASSISTAN:unknown] 57300...251: Assistant seleccionado para procesamient...
2025-08-29T00:41:58Z [ASSISTAN:unknown] 57300...251: Assistant ID efectivo para procesamiento
2025-08-29T00:41:58Z [OPENAI_C:unknown] 57300...251: Estado de concurrencia OpenAI
2025-08-29T00:41:58Z [AI_START:openai] 57300...251 | null
2025-08-29T00:41:58Z [THR_NEW:unknown] th_threa...ax3
2025-08-29T00:41:59Z [OPENAI_P:unknown] 57300...251: Prompt completo compactado enviado a Ope...
[OPENAI_RAW_CONTENT] 573003913251: "Cliente: NOHAYREGISTRO\nTags: NOHAYREGISTRO\nHora actual: 28 de ago de 2025, 7:41 p. m.\n\nMensaje del cliente:\nHola ejecuta..." (192ch total)
2025-08-29T00:41:59Z [OPENAI_M:openai] 57300...251: Mensaje enviado al thread de OpenAI
2025-08-29T00:41:59Z [MODEL_DE:unknown] sys: Usando configuraci√≥n por defecto del Ass...
2025-08-29T00:42:01Z [OPENAI_P:unknown] sys: Esperando respuesta - status: queued
2025-08-29T00:42:07Z [OPENAI_P:unknown] sys: Esperando respuesta - status: in_progres...
2025-08-29T00:42:09Z [SYS_METRIC:system] sys: mem:28/512MB cpu:0% conn:0 uptime:0h1m activeUsers:0
2025-08-29T00:42:09Z [CACHE_METRIC:cache] sys: hits:100% misses:0% size:0MB users:0 evicts:0
2025-08-29T00:42:09Z [BUFFER_METRIC:buffer] sys: active:0 merged:0 abandoned:0 voice:0 text:0
2025-08-29T00:42:09Z [USAGE_STATS:system] sys: msgs:0/hr chunks:0 avgLen:0ch funcs:0 errs:0
2025-08-29T00:42:09Z [BUFFER_METRIC:buffer] sys: active:1 merged:0 abandoned:0 voice:0 text:0
2025-08-29T00:42:11Z [OPENAI_P:unknown] sys: Esperando respuesta - status: requires_a...
2025-08-29T00:42:11Z [RUN_REQU:unknown] sys: Run requiere action para function callin...
[12:42:11 AM] ‚ÑπÔ∏è Processing 1 function calls for Sr Alex
2025-08-29T00:42:11Z [FUNC:functions] unknown()
[12:42:11 AM] ‚öôÔ∏è generate_booking_confirmation_pdf()
2025-08-29T00:42:11Z [OPENAI_F:unknown] sys: Llamando funci√≥n desde OpenAI
2025-08-29T00:42:11Z [FUNCTION:unknown] sys: Ejecutando funci√≥n generate_booking_conf...
2025-08-29T00:42:11Z [FUNCTION:unknown] 57300...251: Contexto pasado a funci√≥n
üîß Executing function: generate_booking_confirmation_pdf
2025-08-29T00:42:11Z [USER_CON:unknown] sys: üîç UserContext recibido en funci√≥n
2025-08-29T00:42:11Z [GENERATE:unknown] sys: üöÄ Iniciando generaci√≥n PDF para reserva...
2025-08-29T00:42:11Z [GENERATE:unknown] sys: üîç Consultando datos reales de la reserv...
2025-08-29T00:42:11Z [FETCH_BO:unknown] sys: üîç Consultando reserva directamente: 747...
2025-08-29T00:42:11Z [BEDS24_A:unknown] sys: GET https://api.beds24.com/v2/bookings?b...
2025-08-29T00:42:12Z [BEDS24:beds24] 0 rooms found
2025-08-29T00:42:12Z [BEDS24_C:beds24] sys: B√∫squeda de reservas exitosa
2025-08-29T00:42:12Z [FETCH_BO:unknown] sys: API Response structure: {"success":true,...
2025-08-29T00:42:12Z [FETCH_BO:unknown] sys: Booking espec√≠fico encontrado: {"id":747...
2025-08-29T00:42:12Z [PROCESS_:unknown] sys: Datos procesados: {"id":74793397,"name":...
2025-08-29T00:42:12Z [FETCH_BO:unknown] sys: ‚úÖ Reserva encontrada exitosamente
2025-08-29T00:42:12Z [GENERATE:unknown] sys: ‚ö†Ô∏è Canal no clasificado, permitiendo: Un...
2025-08-29T00:42:12Z [TRAN:unknown] sys: üí∞ PAYMENTS PROCESADOS: 1 pagos
2025-08-29T00:42:12Z [GENERATE:unknown] sys: üöÄ Iniciando generaci√≥n PDF para reserva...
2025-08-29T00:42:12Z [GENERATE:unknown] sys: üìã Datos procesados - Tipo: CONFIRMACI√ìN...
2025-08-29T00:42:12Z [PDF_GENE:unknown] sys: üìÅ Base directory: dist/ (built: true)
2025-08-29T00:42:12Z [PDF_LIFE:unknown] sys: üõ°Ô∏è Handlers de Graceful Shutdown regist...
2025-08-29T00:42:12Z [PDF_LIFE:unknown] sys: üöÄ PDFGeneratorService inicializado con ...
2025-08-29T00:42:12Z [PDF_GENE:unknown] sys: Generando PDF para reserva: 74793397
2025-08-29T00:42:12Z [TEMPLATE:unknown] sys: Verificando template path en Railway
2025-08-29T00:42:12Z [TEMPLATE:unknown] sys: Template cargado exitosamente (17469 cha...
2025-08-29T00:42:12Z [PDF_GENE:unknown] sys: Configuraci√≥n cargada desde: /app/dist/p...
2025-08-29T00:42:12Z [PDF_:unknown] sys: üîç CONTEXT PAYMENTITEMS: 1 items
2025-08-29T00:42:12Z [PDF_GENE:unknown] sys: Inicializando navegador Puppeteer...
2025-08-29T00:42:12Z [PDF_GENE:unknown] sys: üöÄ Railway detectado - usando Puppeteer ...
2025-08-29T00:42:14Z [PDF_GENE:unknown] sys: üéØ SPARTICUZ: Chromium path: /tmp/chromi...
2025-08-29T00:42:14Z [PDF_GENE:unknown] sys: üéØ SPARTICUZ: Extra args: 22 args
2025-08-29T00:42:14Z [PDF_GENE:unknown] sys: üöÄ Lanzando Chromium con opciones: {"hea...
2025-08-29T00:42:14Z [PDF_GENE:unknown] sys: üîç DEBUGGING: Iniciando puppeteer.launch...

Fontconfig error: No writable cache directories
	/var/cache/fontconfig
	/home/nodejs/.cache/fontconfig
	/home/nodejs/.fontconfig

Fontconfig error: No writable cache directories
	/var/cache/fontconfig
	/home/nodejs/.cache/fontconfig
	/home/nodejs/.fontconfig

Fontconfig error: No writable cache directories
	/var/cache/fontconfig
	/home/nodejs/.cache/fontconfig
	/home/nodejs/.fontconfig

Fontconfig error: No writable cache directories
	/var/cache/fontconfig
	/home/nodejs/.cache/fontconfig
	/home/nodejs/.fontconfig

Fontconfig error: No writable cache directories
	/var/cache/fontconfig
	/home/nodejs/.cache/fontconfig
	/home/nodejs/.fontconfig

Fontconfig error: No writable cache directories
	/var/cache/fontconfig
	/home/nodejs/.cache/fontconfig
	/home/nodejs/.fontconfig

Fontconfig error: No writable cache directories
	/var/cache/fontconfig
	/home/nodejs/.cache/fontconfig
	/home/nodejs/.fontconfig

Fontconfig error: No writable cache directories
	/var/cache/fontconfig
	/home/nodejs/.cache/fontconfig
	/home/nodejs/.fontconfig

Fontconfig error: No writable cache directories
	/var/cache/fontconfig
	/home/nodejs/.cache/fontconfig
	/home/nodejs/.fontconfig

Fontconfig error: No writable cache directories
	/var/cache/fontconfig
	/home/nodejs/.cache/fontconfig
	/home/nodejs/.fontconfig

DevTools listening on ws://127.0.0.1:40147/devtools/browser/6e884e16-889e-447a-8e82-aba676284dd6
2025-08-29T00:42:14Z [PDF_GENE:unknown] sys: ‚úÖ Puppeteer bundled browser launched suc...
2025-08-29T00:42:14Z [PDF_GENE:unknown] sys: üöÄ Navegador Puppeteer inicializado y re...
2025-08-29T00:42:14Z [PDF_CONC:unknown] sys: Estado del navegador singleton
2025-08-29T00:42:18Z [PDF_GENE:unknown] sys: ‚è∞ Railway: Tiempo extra de espera aplica...
2025-08-29T00:42:18Z [PDF_GENE:unknown] sys: ‚úÖ PDF generado con 1 p√°gina (l√≠mite: 3) ...
2025-08-29T00:42:18Z [PDF_GENE:unknown] sys: PDF generado con m√∫ltiples p√°ginas permi...
2025-08-29T00:42:18Z [PDF_GENE:unknown] sys: PDF generado exitosamente: 417012 bytes
2025-08-29T00:42:18Z [GENERATE:unknown] sys: ‚úÖ PDF generado exitosamente - üêå Lento
2025-08-29T00:42:18Z [GENERATE:unknown] sys: ‚úÖ PDF generado exitosamente
2025-08-29T00:42:18Z [RESULT_D:unknown] sys: Result object completo del PDF service
2025-08-29T00:42:18Z [ATTACHME:unknown] sys: Preparando attachment para response
2025-08-29T00:42:18Z [DIRECT_S:unknown] sys: Verificando condiciones para env√≠o direc...
2025-08-29T00:42:18Z [DIRECT_S:unknown] sys: Env√≠o directo NO ejecutado - condiciones...
‚úÖ Function generate_booking_confirmation_pdf completed in 7066ms
2025-08-29T00:42:18Z [TOOL_OUT:unknown] sys: Result antes de stringify para OpenAI
2025-08-29T00:42:18Z [TOOL_OUT:unknown] sys: String JSON para OpenAI generado
2025-08-29T00:42:18Z [PLUGIN_R:unknown] sys: Respuesta completa de funci√≥n enviada a ...
2025-08-29T00:42:18Z [FUNCTION:functions] sys: Funci√≥n generate_booking_confirmation_pd...
2025-08-29T00:42:18Z [OPENAI_T:unknown] sys: Enviando tool outputs exactos a OpenAI
2025-08-29T00:42:19Z [TOOL_OUT:unknown] sys: Tool outputs enviados a OpenAI
2025-08-29T00:42:19Z [OPENAI_P:unknown] sys: Esperando respuesta - status: queued
2025-08-29T00:42:25Z [OPENAI_P:unknown] sys: Esperando respuesta - status: in_progres...
2025-08-29T00:42:29Z [OPENAI_P:unknown] sys: Esperando respuesta - status: completed
2025-08-29T00:42:29Z [FUNCTION:unknown] sys: Respuesta recibida despu√©s de function c...
2025-08-29T00:42:30Z [AI_DONE:openai] 57300...251 | th_threa...ax3 | 32s | 
2025-08-29T00:42:30Z [OPENAI_R:openai] 57300...251: Respuesta completa de OpenAI
2025-08-29T00:42:30Z [HIGH_LAT:performance] 57300...251: Latencia alta detectada en procesamiento
2025-08-29T00:42:30Z [OPENAI_R:unknown] 57300...251: Run de OpenAI completado
2025-08-29T00:42:30Z [DEBUG_FU:unknown] 57300...251: FunctionCalls: true
2025-08-29T00:42:30Z [DEBUG_FU:unknown] 57300...251: Detalles de functionCalls
2025-08-29T00:42:30Z [ATTACHME:unknown] 57300...251: Buscando attachments en functionCalls
2025-08-29T00:42:30Z [ATTACHME:unknown] 57300...251: Analizando funcCall individual
2025-08-29T00:42:30Z [FUNCTION:unknown] 57300...251: Estructura completa del resultado
New thread created for 573003913251: thread_J0CX95K2YqQEvTmCignqUax3, resetting tokenCount
2025-08-29T00:42:30Z [RECONCIL:unknown] 57300...251: Registro actualizado por reconciliaci√≥n
2025-08-29T00:42:30Z [THREAD_S:unknown] 57300...251: ‚úÖ Thread guardado con l√≥gica simplificad...
2025-08-29T00:42:30Z [THREAD_METRIC:database] 57300...251: id:th_threa...ax3 msgs:0 tokens:0 reused:false age:0m
2025-08-29T00:42:30Z [TOKEN_CO:unknown] sys: üìä Token count actualizado: 573003913251...
BD: Reset token count for new thread 573003913251: thread_J0CX95K2YqQEvTmCignqUax3
2025-08-29T00:42:30Z [TOKEN_CO:unknown] sys: üìä Token count actualizado: 573003913251...
2025-08-29T00:42:30Z [TOKEN_RE:unknown] 57300...251: Reset tokens a 0: Nuevo thread sin relac...
2025-08-29T00:42:30Z [TOKEN_CO:unknown] 57300...251: Token count actualizado en memoria
2025-08-29T00:42:30Z [QUOTE_DE:unknown] 57300...251: Decisi√≥n de citado calculada
2025-08-29T00:42:30Z [TIMING_H:unknown] sys: Iniciando timing por chunks
2025-08-29T00:42:30Z [WHAPI_CH:whapi] 57300...net: Enviando chunk 1/1
2025-08-29T00:42:30Z [HUMAN_DE:unknown] sys: text:235ch=2000ms
2025-08-29T00:42:31Z [PRESENCE:unknown] sys: ‚úçÔ∏èch1/1:2000ms
2025-08-29T00:42:34Z [WHAPI_CH:unknown] 57300...251: Resultado env√≠o chunk
2025-08-29T00:42:34Z [WHAPI_RE:unknown] sys: Respuesta completa de WHAPI
2025-08-29T00:42:34Z [WHAPI_ID:unknown] sys: IDs colectados para chunk
2025-08-29T00:42:34Z [TIMING_H:unknown] sys: Timing humano completado
ü§ñ OpenAI ‚Üí Sr Alex (32.3s)
2025-08-29T00:42:34Z [TYPING_F:whapi] 57300...251: Flag de typing reseteado post-procesamie...
2025-08-29T00:42:34Z [SENT:webhook] 57300...251 | 235ch | 32s
2025-08-29T00:42:34Z [FLAG_RES:unknown] 57300...251: duringRunMsgId reseteado post-procesamie...
2025-08-29T00:42:34Z [WEBHOOK_:unknown] sys: Webhook enrutado
2025-08-29T00:42:34Z [WEBHOOK_:unknown] sys: Procesando webhook [MAIN]
2025-08-29T00:42:34Z [WEBHOOK:webhook] msg:1
2025-08-29T00:42:34Z [RECONCIL:unknown] sys: Cliente actualizado por reconciliaci√≥n
WEBHOOK_CACHE_SYNC: Updated clientCache for 573003913251, preserving threadId: thread_J0CX95K2YqQEvTmCignqUax3
2025-08-29T00:42:34Z [CLIENT_U:unknown] sys: Cliente actualizado desde webhook [MAIN]
2025-08-29T00:42:35Z [WEBHOOK_:unknown] sys: Webhook enrutado
2025-08-29T00:42:35Z [WEBHOOK_:unknown] sys: Procesando webhook [MAIN]
2025-08-29T00:42:35Z [WEBHOOK:webhook] stat:1
2025-08-29T00:42:35Z [WEBHOOK_:unknown] sys: üì• stat:1 [MAIN]
2025-08-29T00:43:09Z [SYS_METRIC:system] sys: mem:28/512MB cpu:0% conn:0 uptime:0h2m activeUsers:1
2025-08-29T00:43:09Z [CACHE_METRIC:cache] sys: hits:100% misses:0% size:0MB users:1 evicts:0
2025-08-29T00:43:09Z [BUFFER_METRIC:buffer] sys: active:0 merged:0 abandoned:0 voice:0 text:0
2025-08-29T00:43:09Z [USAGE_STATS:system] sys: msgs:1/hr chunks:0 avgLen:187ch funcs:0 errs:0
2025-08-29T00:43:09Z [LATENCY_METRIC:system] null: openai:32290ms beds24:0ms whapi:0ms db:0ms total:32290ms
2025-08-29T00:43:09Z [BUFFER_METRIC:buffer] sys: active:0 merged:0 abandoned:0 voice:0 text:0
2025-08-29T00:43:52Z [DB_QUERY:database] 57300...251: type:thread_fetch time:12ms res:thread:thread_J... cache:no_change
2025-08-29T00:43:52Z [TOKENS_S:unknown] 57300...251: Tokens acumulados
2025-08-29T00:43:52Z [TOKEN_CO:unknown] 57300...251: Token count inv√°lido - solo actualiza la...
2025-08-29T00:43:52Z [RECONCIL:unknown] 57300...251: Thread activity actualizado por reconcil...
2025-08-29T00:43:52Z [THREAD_A:unknown] 57300...251: Thread activity + tokens actualizados: 5...
2025-08-29T00:43:52Z [DELAYED_:unknown] 57300...251: lastActivity + tokens actualizados
^C