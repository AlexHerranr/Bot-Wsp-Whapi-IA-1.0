Starting Container

> tealquilamos-bot@1.0.0 start
> node dist/app-unified.js

üìÅ Logs de esta sesi√≥n: logs/bot-session-2025-07-26T17-26-26.log
üîÑ Manteniendo m√°ximo 5 sesiones
[2025-07-26T17:26:26.696Z] [SUCCESS] LOGGER_INIT [unknown.ts]: Sistema de logging por sesi√≥n inicializado | {"sessionId":"session-2025-07-26T17-26-26","logFile":"logs/bot-session-2025-07-26T17-26-26.log","maxSessions":5,"maxBufferSizeLocal":50,"maxBufferSizeRailway":400,"bufferInterval":100}
2025-07-26T22:26:26.797831533Z [INFO] [THREAD_PERSIST] Directorio creado: tmp/backups jsonPayload={"category":"THREAD_PERSIST","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","timestamp":"2025-07-26T22:26:26.748Z"} labels={"app":"whatsapp-bot","category":"THREAD_PERSIST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:26:26.748Z"
2025-07-26T22:26:26.797853026Z [INFO] [THREAD_PERSIST] No se encontr√≥ archivo de threads, iniciando vac√≠o jsonPayload={"category":"THREAD_PERSIST","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","timestamp":"2025-07-26T22:26:26.748Z"} labels={"app":"whatsapp-bot","category":"THREAD_PERSIST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:26:26.748Z"
2025-07-26T22:26:26.797874469Z [INFO] [THREAD_PERSIST] Auto-guardado optimizado configurado cada 5 minutos jsonPayload={"category":"THREAD_PERSIST","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","timestamp":"2025-07-26T22:26:26.749Z"} labels={"app":"whatsapp-bot","category":"THREAD_PERSIST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:26:26.749Z"
2025-07-26T22:26:26.797895159Z [INFO] [GUEST_MEMORY] Sistema de cache de labels inicializado (TTL: 300s, limpieza: 10min) jsonPayload={"category":"GUEST_MEMORY","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","timestamp":"2025-07-26T22:26:26.790Z"} labels={"app":"whatsapp-bot","category":"GUEST_MEMORY","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:26:26.790Z"

üöÄ TeAlquilamos Bot - Iniciando...
üìÖ Timestamp: 2025-07-26T22:26:26.793Z
üîß Node.js: v18.20.8
üíæ Memoria inicial: 26MB
üåç Entorno: production
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
üîç Detectando entorno...
   RAILWAY_ENVIRONMENT: production
   RAILWAY_PROJECT_ID: 84017f88-1aab-4519-afd2-4e55a45cee90
   K_SERVICE: not set
   NODE_ENV: production
‚úÖ Detectado: Railway
üîß Puerto detectado: 8080 (process.env.PORT: 8080)
üîß Forzando NODE_ENV=production para Railway
üîß Configuraci√≥n del Entorno:
   üìç Entorno: cloud-run
   üåê Puerto: 8080
   ÔøΩÔøΩ Webhook: https://bot-wsp-whapi-ia-10-production.up.railway.app/hook
   üìä Log Level: production
   üîç Logs Detallados: S√≠
   ‚è±Ô∏è  Buffer de Mensajes: Activo (10s)
   ‚òÅÔ∏è  Modo: Cloud Run
   üöÄ Producci√≥n: Activo
   üîë Secretos: Cargados
   üìú Inyecci√≥n Historial: Inactiva (3 meses, 200 msgs)
   ‚è±Ô∏è Cache TTL: 3600 segundos (1h)
2025-07-26T22:26:26.798238963Z [INFO] [THREAD_PERSIST] Cleanup inicial ejecutado con 3 meses jsonPayload={"category":"THREAD_PERSIST","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","timestamp":"2025-07-26T22:26:26.797Z"} labels={"app":"whatsapp-bot","category":"THREAD_PERSIST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:26:26.797Z"
2025-07-26T22:26:26.798263872Z [INFO] [THREAD_PERSIST] Cleanup peri√≥dico configurado cada 5 minutos jsonPayload={"category":"THREAD_PERSIST","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","timestamp":"2025-07-26T22:26:26.797Z"} labels={"app":"whatsapp-bot","category":"THREAD_PERSIST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:26:26.797Z"
2025-07-26T22:26:26.807204896Z [INFO] [SERVER_START] Servidor HTTP iniciado jsonPayload={"category":"SERVER_START","environment":"cloud-run","flow":{"stage":"0_unknown"},"host":"0.0.0.0","level":"INFO","port":8080,"timestamp":"2025-07-26T22:26:26.803Z","webhookUrl":"https://bot-wsp-whapi-ia-10-production.up.railway.app/hook"} labels={"app":"whatsapp-bot","category":"SERVER_START","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:26:26.803Z"

=== Bot TeAlquilamos Iniciado ===
üöÄ Servidor: 0.0.0.0:8080
üîó Webhook: https://bot-wsp-whapi-ia-10-production.up.railway.app/hook
‚úÖ Sistema listo

2025-07-26T22:26:26.807311860Z [INFO] [BOT_INIT] Cleanup autom√°tico de threads y cache configurado jsonPayload={"category":"BOT_INIT","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","timestamp":"2025-07-26T22:26:26.804Z"} labels={"app":"whatsapp-bot","category":"BOT_INIT","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:26:26.804Z"
2025-07-26T22:26:26.807343069Z [INFO] [CACHE_INIT] Estad√≠sticas de cache al inicio jsonPayload={"category":"CACHE_INIT","contextCache":{"size":0,"ttlMinutes":1},"environment":"cloud-run","flow":{"stage":"0_unknown"},"historyCache":{"size":0,"ttlMinutes":60},"injectionCache":{"size":0,"ttlMinutes":5},"level":"INFO","timestamp":"2025-07-26T22:26:26.804Z"} labels={"app":"whatsapp-bot","category":"CACHE_INIT","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:26:26.804Z"
2025-07-26T22:26:31.816957140Z [INFO] [ORPHANED_RUNS_RECOVERY_START] Iniciando recuperaci√≥n de runs hu√©rfanos jsonPayload={"category":"ORPHANED_RUNS_RECOVERY_START","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","timestamp":"2025-07-26T22:26:31.806Z"} labels={"app":"whatsapp-bot","category":"ORPHANED_RUNS_RECOVERY_START","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:26:31.806Z"
2025-07-26T22:26:31.816985689Z [INFO] [ORPHANED_RUNS_RECOVERY_START] Iniciando recuperaci√≥n de runs hu√©rfanos jsonPayload={"category":"ORPHANED_RUNS_RECOVERY_START","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","timestamp":"2025-07-26T22:26:31.807Z"} labels={"app":"whatsapp-bot","category":"ORPHANED_RUNS_RECOVERY_START","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:26:31.807Z"
2025-07-26T22:26:31.817021668Z [INFO] [ORPHANED_RUNS_RECOVERY_COMPLETE] Recuperaci√≥n de runs hu√©rfanos completada jsonPayload={"category":"ORPHANED_RUNS_RECOVERY_COMPLETE","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"SUCCESS","runsCancelled":0,"runsChecked":0,"timestamp":"2025-07-26T22:26:31.807Z"} labels={"app":"whatsapp-bot","category":"ORPHANED_RUNS_RECOVERY_COMPLETE","flow_stage":"0_unknown","level":"SUCCESS"} timestamp="2025-07-26T22:26:31.807Z"
2025-07-26T22:26:31.817050404Z [INFO] [ORPHANED_RUNS_RECOVERY_COMPLETE] Recuperaci√≥n de runs hu√©rfanos completada jsonPayload={"category":"ORPHANED_RUNS_RECOVERY_COMPLETE","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"SUCCESS","timestamp":"2025-07-26T22:26:31.808Z"} labels={"app":"whatsapp-bot","category":"ORPHANED_RUNS_RECOVERY_COMPLETE","flow_stage":"0_unknown","level":"SUCCESS"} timestamp="2025-07-26T22:26:31.808Z"
2025-07-26T22:26:39.941643457Z [INFO] [PRESENCE_EVENT] Procesando 1 eventos de presencia jsonPayload={"category":"PRESENCE_EVENT","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","presenceCount":1,"timestamp":"2025-07-26T22:26:39.940Z"} labels={"app":"whatsapp-bot","category":"PRESENCE_EVENT","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:26:39.940Z"
2025-07-26T22:26:39.941676040Z [INFO] [PRESENCE_RECEIVED] Presencia para 573003913251: recording jsonPayload={"category":"PRESENCE_RECEIVED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","status":"recording","timestamp":"2025-07-26T22:26:39.940Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"PRESENCE_RECEIVED","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-26T22:26:39.940Z"
2025-07-26T22:26:39.941704561Z [INFO] [BUFFER_TIMER_SET] Timer inteligente configurado jsonPayload={"bufferSize":0,"category":"BUFFER_TIMER_SET","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","timerMs":10000,"timestamp":"2025-07-26T22:26:39.941Z","triggerType":"recording","userJid":"573003913251","userName":"573003913251","wasReconfigured":true} labels={"app":"whatsapp-bot","category":"BUFFER_TIMER_SET","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:26:39.941Z"
üéôÔ∏è 573003913251 est√° grabando...
2025-07-26T22:26:45.352954616Z [INFO] [PRESENCE_EVENT] Procesando 1 eventos de presencia jsonPayload={"category":"PRESENCE_EVENT","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","presenceCount":1,"timestamp":"2025-07-26T22:26:45.343Z"} labels={"app":"whatsapp-bot","category":"PRESENCE_EVENT","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:26:45.343Z"
2025-07-26T22:26:45.352997360Z [INFO] [PRESENCE_RECEIVED] Presencia para 573003913251: online jsonPayload={"category":"PRESENCE_RECEIVED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","status":"online","timestamp":"2025-07-26T22:26:45.343Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"PRESENCE_RECEIVED","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-26T22:26:45.343Z"
üé§ Sr Alex: [Nota de voz recibida]
2025-07-26T22:26:48.719215360Z [INFO] [AUDIO_TRANSCRIBED] Audio transcrito exitosamente jsonPayload={"category":"AUDIO_TRANSCRIBED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"SUCCESS","preview":"Hola, ¬øc√≥mo va todo por all√°? ¬øQu√© se dice luego?","timestamp":"2025-07-26T22:26:48.691Z","transcriptionLength":49,"userId":"573003913251"} labels={"app":"whatsapp-bot","category":"AUDIO_TRANSCRIBED","flow_stage":"0_unknown","level":"SUCCESS","user_id":"573003913251"} timestamp="2025-07-26T22:26:48.691Z"
üë§ Sr Alex: "Hola, ¬øc√≥mo va todo por all√°? ¬øQu√© se dice luego?"
2025-07-26T22:26:48.719256485Z [INFO] [BUFFER_TIMER_RESPECTED] Timer existente respetado (delay actual es suficiente) jsonPayload={"bufferSize":1,"category":"BUFFER_TIMER_RESPECTED","currentDelay":10000,"environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","requestedDelay":8000,"timestamp":"2025-07-26T22:26:48.692Z","triggerType":"voice","userJid":"573003913251","userName":"Sr Alex"} labels={"app":"whatsapp-bot","category":"BUFFER_TIMER_RESPECTED","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:26:48.692Z"
2025-07-26T22:26:48.719283862Z [INFO] [GLOBAL_BUFFER_ADD] Mensaje agregado al buffer global jsonPayload={"bufferSize":1,"category":"GLOBAL_BUFFER_ADD","delay":5000,"environment":"cloud-run","flow":{"stage":"0_unknown"},"isMedia":true,"level":"INFO","messageText":"üé§ Hola, ¬øc√≥mo va todo por all√°? ¬øQu√© se dice lueg...","timestamp":"2025-07-26T22:26:48.693Z","userJid":"573003913251","userName":"Sr Alex"} labels={"app":"whatsapp-bot","category":"GLOBAL_BUFFER_ADD","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:26:48.693Z"
‚è∞ üéôÔ∏è Sr Alex dej√≥ de grabar.
2025-07-26T22:26:49.943439899Z [INFO] [GLOBAL_BUFFER_PROCESS] Procesando buffer global despu√©s de 5 segundos jsonPayload={"category":"GLOBAL_BUFFER_PROCESS","combinedText":"üé§ Hola, ¬øc√≥mo va todo por all√°? ¬øQu√© se dice luego?...","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","messageCount":1,"timestamp":"2025-07-26T22:26:49.942Z","userJid":"573003913251","userName":"Sr Alex"} labels={"app":"whatsapp-bot","category":"GLOBAL_BUFFER_PROCESS","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:26:49.942Z"
2025-07-26T22:26:49.946783310Z [INFO] [QUEUE_ITEM_ADDED] Mensaje agregado a cola de usuario jsonPayload={"category":"QUEUE_ITEM_ADDED","environment":"cloud-run","flow":{"sequence":1,"stage":"0_unknown"},"hasActiveLock":false,"level":"INFO","messageId":"msg_1753568809943_74s0hy05y","queueLength":1,"timestamp":"2025-07-26T22:26:49.943Z","totalQueues":1,"userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_ITEM_ADDED","flow_stage":"0_unknown","level":"INFO","message_id":"msg_1753568809943_74s0hy05y","user_id":"573003913251"} timestamp="2025-07-26T22:26:49.943Z"
2025-07-26T22:26:49.946810741Z [INFO] [QUEUE_PROCESSING_START] Procesando cola de usuario jsonPayload={"category":"QUEUE_PROCESSING_START","environment":"cloud-run","flow":{"stage":"0_unknown"},"hasActiveLock":false,"level":"INFO","queueLength":1,"timestamp":"2025-07-26T22:26:49.944Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_PROCESSING_START","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-26T22:26:49.944Z"
2025-07-26T22:26:49.946857682Z [INFO] [QUEUE_ITEM_PROCESSING] Procesando mensaje de cola jsonPayload={"category":"QUEUE_ITEM_PROCESSING","environment":"cloud-run","flow":{"sequence":2,"stage":"0_unknown"},"level":"TRACE","messageId":"msg_1753568809943_74s0hy05y","remainingInQueue":0,"timestamp":"2025-07-26T22:26:49.944Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_ITEM_PROCESSING","flow_stage":"0_unknown","level":"TRACE","message_id":"msg_1753568809943_74s0hy05y","user_id":"573003913251"} timestamp="2025-07-26T22:26:49.944Z"
2025-07-26T22:26:50.398305817Z [INFO] [RECORDING_INDICATOR_SENT] Recording indicator enviado para procesamiento de audio jsonPayload={"category":"RECORDING_INDICATOR_SENT","chatId":"573003913251@s.whatsapp.net","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","timestamp":"2025-07-26T22:26:50.397Z"} labels={"app":"whatsapp-bot","category":"RECORDING_INDICATOR_SENT","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:26:50.397Z"
2025-07-26T22:26:50.603864941Z [INFO] [THREAD_PERSIST] Thread creado para 573003913251 jsonPayload={"category":"THREAD_PERSIST","chatId":"573003913251@s.whatsapp.net","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","operation":"created","threadId":"thread_uJrmjwIRjMkCSI95PpLU05k8","timestamp":"2025-07-26T22:26:50.598Z","userId":"573003913251","userName":"Sr Alex"} labels={"app":"whatsapp-bot","category":"THREAD_PERSIST","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-26T22:26:50.598Z"

üì® Nueva conversaci√≥n con Sr Alex
2025-07-26T22:26:50.603915625Z [INFO] [THREAD_CREATED] Thread creado jsonPayload={"category":"THREAD_CREATED","chatId":"573003913251@s.whatsapp.net","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","threadId":"thread_uJrmjwIRjMkCSI95PpLU05k8","timestamp":"2025-07-26T22:26:50.598Z","userName":"Sr Alex"} labels={"app":"whatsapp-bot","category":"THREAD_CREATED","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:26:50.598Z"
2025-07-26T22:26:50.603937977Z [INFO] [OPENAI_PROCESSING_START] Procesando mensaje de Sr Alex jsonPayload={"category":"OPENAI_PROCESSING_START","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","timestamp":"2025-07-26T22:26:50.598Z","userName":"Sr Alex"} labels={"app":"whatsapp-bot","category":"OPENAI_PROCESSING_START","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:26:50.598Z"
2025-07-26T22:26:50.603962215Z [INFO] [PRESENCE_SUBSCRIBE_ATTEMPT] Intentando suscribirse a presencia de 573003913251 jsonPayload={"category":"PRESENCE_SUBSCRIBE_ATTEMPT","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","timestamp":"2025-07-26T22:26:50.599Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"PRESENCE_SUBSCRIBE_ATTEMPT","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-26T22:26:50.599Z"
2025-07-26T22:26:51.031041126Z [INFO] [PRESENCE_ALREADY_SUBSCRIBED_API] Usuario 573003913251 ya suscrito (409) jsonPayload={"category":"PRESENCE_ALREADY_SUBSCRIBED_API","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","status":409,"timestamp":"2025-07-26T22:26:51.025Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"PRESENCE_ALREADY_SUBSCRIBED_API","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-26T22:26:51.025Z"
2025-07-26T22:26:51.354333275Z [INFO] [WHAPI_LABELS] Obteniendo info del chat para 573003913251 jsonPayload={"category":"WHAPI_LABELS","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","timestamp":"2025-07-26T22:26:51.352Z"} labels={"app":"whatsapp-bot","category":"WHAPI_LABELS","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:26:51.352Z"
2025-07-26T22:26:51.750568478Z [INFO] [WHAPI_LABELS] Info del chat obtenida. Etiquetas: 2 jsonPayload={"category":"WHAPI_LABELS","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"SUCCESS","timestamp":"2025-07-26T22:26:51.737Z"} labels={"app":"whatsapp-bot","category":"WHAPI_LABELS","flow_stage":"0_unknown","level":"SUCCESS"} timestamp="2025-07-26T22:26:51.737Z"
2025-07-26T22:26:51.750595526Z [INFO] [GUEST_MEMORY] Sincronizado con Whapi: 2 etiquetas para 573003913251 jsonPayload={"category":"GUEST_MEMORY","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","timestamp":"2025-07-26T22:26:51.738Z"} labels={"app":"whatsapp-bot","category":"GUEST_MEMORY","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:26:51.738Z"
2025-07-26T22:26:51.750624076Z [INFO] [SYNC_NEEDED] Sync needed for 573003913251 jsonPayload={"category":"SYNC_NEEDED","environment":"cloud-run","flow":{"stage":"0_unknown"},"force":false,"isNewThread":true,"isThreadOld":false,"level":"INFO","reason":"new_thread","requestId":null,"timestamp":"2025-07-26T22:26:51.738Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"SYNC_NEEDED","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-26T22:26:51.738Z"
2025-07-26T22:26:51.750644355Z [INFO] [GUEST_MEMORY] Nuevo perfil creado para 573003913251 con 2 etiquetas jsonPayload={"category":"GUEST_MEMORY","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","timestamp":"2025-07-26T22:26:51.738Z"} labels={"app":"whatsapp-bot","category":"GUEST_MEMORY","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:26:51.738Z"
2025-07-26T22:26:51.750664542Z [INFO] [WHAPI_LABELS] Obteniendo info del chat para 573003913251 jsonPayload={"category":"WHAPI_LABELS","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","timestamp":"2025-07-26T22:26:51.739Z"} labels={"app":"whatsapp-bot","category":"WHAPI_LABELS","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:26:51.739Z"
2025-07-26T22:26:52.122946772Z [INFO] [WHAPI_LABELS] Info del chat obtenida. Etiquetas: 2 jsonPayload={"category":"WHAPI_LABELS","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"SUCCESS","timestamp":"2025-07-26T22:26:52.119Z"} labels={"app":"whatsapp-bot","category":"WHAPI_LABELS","flow_stage":"0_unknown","level":"SUCCESS"} timestamp="2025-07-26T22:26:52.119Z"
2025-07-26T22:26:52.123000881Z [INFO] [CONTEXT_FRESH_RESTART] Generando contexto fresco despu√©s del reinicio jsonPayload={"cacheAge":"none","category":"CONTEXT_FRESH_RESTART","environment":"cloud-run","flow":{"stage":"0_unknown"},"hadCachedContext":false,"level":"INFO","timestamp":"2025-07-26T22:26:52.120Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"CONTEXT_FRESH_RESTART","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-26T22:26:52.120Z"
2025-07-26T22:26:52.123031632Z [INFO] [CACHE_HIT] Chat info desde cache jsonPayload={"cacheAge":0,"category":"CACHE_HIT","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","timestamp":"2025-07-26T22:26:52.120Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"CACHE_HIT","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-26T22:26:52.120Z"
2025-07-26T22:26:52.144407552Z [INFO] [CONTEXT_INJECTION] Contexto temporal generado jsonPayload={"category":"CONTEXT_INJECTION","clientName":"Sr Alex","contactName":"Sr Alex","contextLength":150,"environment":"cloud-run","flow":{"stage":"0_unknown"},"hasChatInfo":true,"hasProfile":true,"isFirstMessageAfterRestart":true,"labelsCount":2,"level":"INFO","timestamp":"2025-07-26T22:26:52.143Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"CONTEXT_INJECTION","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-26T22:26:52.143Z"
2025-07-26T22:26:52.144471338Z [INFO] [CONTEXT_DEBUG] Contexto enviado a OpenAI jsonPayload={"category":"CONTEXT_DEBUG","contextPreview":"Fecha: 26/07/2025 | Hora: 5:26 PM (Colombia)\nCliente: Sr Alex | Contacto WhatsApp: Sr Alex | Status: Colega Jefe, cotizaci√≥n\n---\nMensaje del cliente:\n","contextReason":"cambio_labels","contextTokensSaved":0,"environment":"cloud-run","flow":{"stage":"0_unknown"},"isVoiceMessage":true,"level":"INFO","messagePreview":"üé§ Hola, ¬øc√≥mo va todo por all√°? ¬øQu√© se dice luego?","needsTemporalContext":true,"shortUserId":"573003913251","timestamp":"2025-07-26T22:26:52.143Z","totalLength":202} labels={"app":"whatsapp-bot","category":"CONTEXT_DEBUG","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:26:52.143Z"
2025-07-26T22:26:52.461390839Z [INFO] [CACHE_HIT] Chat info desde cache jsonPayload={"cacheAge":1,"category":"CACHE_HIT","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","timestamp":"2025-07-26T22:26:52.423Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"CACHE_HIT","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-26T22:26:52.423Z"
2025-07-26T22:26:52.461522886Z [INFO] [THREAD_PERSIST] Metadatos actualizados para 573003913251 jsonPayload={"category":"THREAD_PERSIST","environment":"cloud-run","flow":{"stage":"0_unknown"},"labels":["Colega Jefe","cotizaci√≥n"],"level":"SUCCESS","timestamp":"2025-07-26T22:26:52.423Z","updates":["labels"],"userName":"Sr Alex"} labels={"app":"whatsapp-bot","category":"THREAD_PERSIST","flow_stage":"0_unknown","level":"SUCCESS"} timestamp="2025-07-26T22:26:52.423Z"
2025-07-26T22:26:52.461573470Z [INFO] [THREAD_METADATA_UPDATED] Metadatos del thread actualizados jsonPayload={"category":"THREAD_METADATA_UPDATED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","reason":"cambio_labels","shortUserId":"573003913251","timestamp":"2025-07-26T22:26:52.424Z","updates":["labels"]} labels={"app":"whatsapp-bot","category":"THREAD_METADATA_UPDATED","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:26:52.424Z"
2025-07-26T22:26:56.060458887Z [INFO] [OPENAI_POLLING] Esperando... jsonPayload={"attempts":1,"category":"OPENAI_POLLING","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","runId":"run_77iW5ZMysVQ1RlOXI22PigaB","shortUserId":"573003913251","status":"queued","timestamp":"2025-07-26T22:26:56.056Z"} labels={"app":"whatsapp-bot","category":"OPENAI_POLLING","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:26:56.056Z"
2025-07-26T22:26:58.631750531Z [INFO] [TOKEN_USAGE] Tokens utilizados jsonPayload={"category":"TOKEN_USAGE","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","threadId":"thread_uJrmjwIRjMkCSI95PpLU05k8","timestamp":"2025-07-26T22:26:58.628Z","totalTokens":3481} labels={"app":"whatsapp-bot","category":"TOKEN_USAGE","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:26:58.628Z"
2025-07-26T22:26:59.334813866Z [INFO] [OPENAI_RESPONSE_RAW] Respuesta exacta recibida de OpenAI jsonPayload={"category":"OPENAI_RESPONSE_RAW","environment":"cloud-run","flow":{"stage":"0_unknown"},"hasDoubleAsterisks":false,"level":"INFO","responseLength":81,"responsePreview":"Hola Sr. Alex, ¬°todo bien por ac√°! üòä ¬øC√≥mo est√°s t√∫? ¬øEn qu√© puedo ayudarte hoy?","responseText":"Hola Sr. Alex, ¬°todo bien por ac√°! üòä ¬øC√≥mo est√°s t√∫? ¬øEn qu√© puedo ayudarte hoy?","shortUserId":"573003913251","threadId":"thread_uJrmjwIRjMkCSI95PpLU05k8","timestamp":"2025-07-26T22:26:59.331Z"} labels={"app":"whatsapp-bot","category":"OPENAI_RESPONSE_RAW","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:26:59.331Z"
2025-07-26T22:26:59.334850161Z [INFO] [PERFORMANCE_METRICS] Procesamiento completado exitosamente jsonPayload={"category":"PERFORMANCE_METRICS","contextTokens":0,"environment":"cloud-run","flow":{"stage":"9_complete"},"isEfficient":false,"level":"INFO","memory":{"heapTotalMB":30,"heapUsedMB":28,"rssMB":89},"responseLength":81,"shortUserId":"573003913251","threadId":"thread_uJrmjwIRjMkCSI95PpLU05k8","timestamp":"2025-07-26T22:26:59.331Z","tokensPerSecond":390,"totalDurationMs":8934,"totalTokens":3481} labels={"app":"whatsapp-bot","category":"PERFORMANCE_METRICS","flow_stage":"9_complete","level":"INFO"} timestamp="2025-07-26T22:26:59.331Z"
ü§ñ OpenAI ‚Üí Sr Alex (0.0s)
üé§ Generando voz para 573003913251: "Hola Sr. Alex, ¬°todo bien por ac√°! üòä ¬øC√≥mo est√°s ..."
2025-07-26T22:27:02.440052438Z [INFO] [VOICE_RESPONSE_SENT] Respuesta de voz enviada exitosamente jsonPayload={"category":"VOICE_RESPONSE_SENT","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"SUCCESS","messageLength":81,"timestamp":"2025-07-26T22:27:02.434Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"VOICE_RESPONSE_SENT","flow_stage":"0_unknown","level":"SUCCESS","user_id":"573003913251"} timestamp="2025-07-26T22:27:02.434Z"
2025-07-26T22:27:02.440098487Z [INFO] [QUEUE_ITEM_SUCCESS] Mensaje procesado exitosamente jsonPayload={"category":"QUEUE_ITEM_SUCCESS","environment":"cloud-run","flow":{"sequence":3,"stage":"0_unknown"},"level":"SUCCESS","messageId":"msg_1753568809943_74s0hy05y","processedCount":1,"remainingInQueue":0,"timestamp":"2025-07-26T22:27:02.434Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_ITEM_SUCCESS","flow_stage":"0_unknown","level":"SUCCESS","message_id":"msg_1753568809943_74s0hy05y","user_id":"573003913251"} timestamp="2025-07-26T22:27:02.434Z"
2025-07-26T22:27:02.440133503Z [INFO] [LOCK_ALREADY_RELEASED] Lock ya liberado para usuario jsonPayload={"activeLocks":0,"category":"LOCK_ALREADY_RELEASED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"TRACE","timestamp":"2025-07-26T22:27:02.435Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"LOCK_ALREADY_RELEASED","flow_stage":"0_unknown","level":"TRACE","user_id":"573003913251"} timestamp="2025-07-26T22:27:02.435Z"
2025-07-26T22:27:02.440173722Z [INFO] [QUEUE_PROCESSING_COMPLETE] Cola de usuario procesada completamente jsonPayload={"averageTimePerMessage":"12491ms","category":"QUEUE_PROCESSING_COMPLETE","environment":"cloud-run","errorCount":0,"flow":{"stage":"0_unknown"},"initialQueueLength":1,"level":"SUCCESS","processedCount":1,"processingDuration":"12491ms","remainingQueues":0,"timestamp":"2025-07-26T22:27:02.435Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_PROCESSING_COMPLETE","flow_stage":"0_unknown","level":"SUCCESS","user_id":"573003913251"} timestamp="2025-07-26T22:27:02.435Z"
2025-07-26T22:27:22.438415377Z [INFO] [PRESENCE_EVENT] Procesando 1 eventos de presencia jsonPayload={"category":"PRESENCE_EVENT","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","presenceCount":1,"timestamp":"2025-07-26T22:27:19.117Z"} labels={"app":"whatsapp-bot","category":"PRESENCE_EVENT","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:27:19.117Z"
2025-07-26T22:27:22.438438113Z [INFO] [PRESENCE_RECEIVED] Presencia para 573003913251: recording jsonPayload={"category":"PRESENCE_RECEIVED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","status":"recording","timestamp":"2025-07-26T22:27:19.117Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"PRESENCE_RECEIVED","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-26T22:27:19.117Z"
2025-07-26T22:27:22.438465061Z [INFO] [BUFFER_TIMER_SET] Timer inteligente configurado jsonPayload={"bufferSize":0,"category":"BUFFER_TIMER_SET","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","timerMs":10000,"timestamp":"2025-07-26T22:27:19.117Z","triggerType":"recording","userJid":"573003913251","userName":"573003913251","wasReconfigured":true} labels={"app":"whatsapp-bot","category":"BUFFER_TIMER_SET","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:27:19.117Z"
üéôÔ∏è 573003913251 est√° grabando...
2025-07-26T22:27:23.844229860Z [INFO] [PRESENCE_EVENT] Procesando 1 eventos de presencia jsonPayload={"category":"PRESENCE_EVENT","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","presenceCount":1,"timestamp":"2025-07-26T22:27:23.836Z"} labels={"app":"whatsapp-bot","category":"PRESENCE_EVENT","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:27:23.836Z"
2025-07-26T22:27:23.844272248Z [INFO] [PRESENCE_RECEIVED] Presencia para 573003913251: online jsonPayload={"category":"PRESENCE_RECEIVED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","status":"online","timestamp":"2025-07-26T22:27:23.836Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"PRESENCE_RECEIVED","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-26T22:27:23.836Z"
üé§ Sr Alex: [Nota de voz recibida]
2025-07-26T22:27:26.900506333Z [INFO] [AUDIO_TRANSCRIBED] Audio transcrito exitosamente jsonPayload={"category":"AUDIO_TRANSCRIBED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"SUCCESS","preview":"Estaba consultando si ten√≠an apartamentos disponibles.","timestamp":"2025-07-26T22:27:26.893Z","transcriptionLength":54,"userId":"573003913251"} labels={"app":"whatsapp-bot","category":"AUDIO_TRANSCRIBED","flow_stage":"0_unknown","level":"SUCCESS","user_id":"573003913251"} timestamp="2025-07-26T22:27:26.893Z"
üë§ Sr Alex: "Estaba consultando si ten√≠an apartamentos disponibles."
2025-07-26T22:27:26.900549064Z [INFO] [BUFFER_TIMER_RESPECTED] Timer existente respetado (delay actual es suficiente) jsonPayload={"bufferSize":1,"category":"BUFFER_TIMER_RESPECTED","currentDelay":10000,"environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","requestedDelay":8000,"timestamp":"2025-07-26T22:27:26.893Z","triggerType":"voice","userJid":"573003913251","userName":"Sr Alex"} labels={"app":"whatsapp-bot","category":"BUFFER_TIMER_RESPECTED","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:27:26.893Z"
2025-07-26T22:27:26.900577837Z [INFO] [GLOBAL_BUFFER_ADD] Mensaje agregado al buffer global jsonPayload={"bufferSize":1,"category":"GLOBAL_BUFFER_ADD","delay":5000,"environment":"cloud-run","flow":{"stage":"0_unknown"},"isMedia":true,"level":"INFO","messageText":"üé§ Estaba consultando si ten√≠an apartamentos dispo...","timestamp":"2025-07-26T22:27:26.893Z","userJid":"573003913251","userName":"Sr Alex"} labels={"app":"whatsapp-bot","category":"GLOBAL_BUFFER_ADD","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:27:26.893Z"
‚è∞ üéôÔ∏è Sr Alex dej√≥ de grabar.
2025-07-26T22:27:29.121931565Z [INFO] [GLOBAL_BUFFER_PROCESS] Procesando buffer global despu√©s de 5 segundos jsonPayload={"category":"GLOBAL_BUFFER_PROCESS","combinedText":"üé§ Estaba consultando si ten√≠an apartamentos disponibles....","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","messageCount":1,"timestamp":"2025-07-26T22:27:29.117Z","userJid":"573003913251","userName":"Sr Alex"} labels={"app":"whatsapp-bot","category":"GLOBAL_BUFFER_PROCESS","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:27:29.117Z"
2025-07-26T22:27:29.715658775Z [INFO] [QUEUE_ITEM_ADDED] Mensaje agregado a cola de usuario jsonPayload={"category":"QUEUE_ITEM_ADDED","environment":"cloud-run","flow":{"sequence":1,"stage":"0_unknown"},"hasActiveLock":false,"level":"INFO","messageId":"msg_1753568849710_sh1dwg257","queueLength":1,"timestamp":"2025-07-26T22:27:29.710Z","totalQueues":1,"userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_ITEM_ADDED","flow_stage":"0_unknown","level":"INFO","message_id":"msg_1753568849710_sh1dwg257","user_id":"573003913251"} timestamp="2025-07-26T22:27:29.710Z"
2025-07-26T22:27:29.715690517Z [INFO] [QUEUE_PROCESSING_START] Procesando cola de usuario jsonPayload={"category":"QUEUE_PROCESSING_START","environment":"cloud-run","flow":{"stage":"0_unknown"},"hasActiveLock":false,"level":"INFO","queueLength":1,"timestamp":"2025-07-26T22:27:29.710Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_PROCESSING_START","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-26T22:27:29.710Z"
2025-07-26T22:27:29.715721191Z [INFO] [QUEUE_ITEM_PROCESSING] Procesando mensaje de cola jsonPayload={"category":"QUEUE_ITEM_PROCESSING","environment":"cloud-run","flow":{"sequence":2,"stage":"0_unknown"},"level":"TRACE","messageId":"msg_1753568849710_sh1dwg257","remainingInQueue":0,"timestamp":"2025-07-26T22:27:29.710Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_ITEM_PROCESSING","flow_stage":"0_unknown","level":"TRACE","message_id":"msg_1753568849710_sh1dwg257","user_id":"573003913251"} timestamp="2025-07-26T22:27:29.710Z"
2025-07-26T22:27:30.268169658Z [INFO] [RECORDING_INDICATOR_SENT] Recording indicator enviado para procesamiento de audio jsonPayload={"category":"RECORDING_INDICATOR_SENT","chatId":"573003913251@s.whatsapp.net","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","timestamp":"2025-07-26T22:27:30.265Z"} labels={"app":"whatsapp-bot","category":"RECORDING_INDICATOR_SENT","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:27:30.265Z"
2025-07-26T22:27:30.268203951Z [INFO] [THREAD_REUSE] Thread reutilizado para 573003913251 jsonPayload={"category":"THREAD_REUSE","chatId":"573003913251@s.whatsapp.net","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","threadId":"thread_uJrmjwIRjMkCSI95PpLU05k8","timestamp":"2025-07-26T22:27:30.266Z","userName":"Sr Alex"} labels={"app":"whatsapp-bot","category":"THREAD_REUSE","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:27:30.266Z"
2025-07-26T22:27:30.268232503Z [INFO] [HISTORY_SKIP] Skip fetch historial: Thread existe jsonPayload={"category":"HISTORY_SKIP","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","reason":"thread_already_exists","threadId":"thread_uJrmjwIRjMkCSI95PpLU05k8","timestamp":"2025-07-26T22:27:30.266Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"HISTORY_SKIP","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-26T22:27:30.266Z"
2025-07-26T22:27:30.268259166Z [INFO] [OPENAI_PROCESSING_START] Procesando mensaje de Sr Alex jsonPayload={"category":"OPENAI_PROCESSING_START","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","timestamp":"2025-07-26T22:27:30.266Z","userName":"Sr Alex"} labels={"app":"whatsapp-bot","category":"OPENAI_PROCESSING_START","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:27:30.266Z"
2025-07-26T22:27:30.586016480Z [INFO] [CACHE_HIT] Chat info desde cache jsonPayload={"cacheAge":39,"category":"CACHE_HIT","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","timestamp":"2025-07-26T22:27:30.584Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"CACHE_HIT","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-26T22:27:30.583Z"
2025-07-26T22:27:30.586074365Z [INFO] [CONTEXT_DEBUG] Contexto enviado a OpenAI jsonPayload={"category":"CONTEXT_DEBUG","contextPreview":"NO_CONTEXT","contextReason":"no_cambios","contextTokensSaved":-151,"environment":"cloud-run","flow":{"stage":"0_unknown"},"isVoiceMessage":true,"level":"INFO","messagePreview":"üé§ Estaba consultando si ten√≠an apartamentos disponibles.","needsTemporalContext":false,"shortUserId":"573003913251","timestamp":"2025-07-26T22:27:30.584Z","totalLength":57} labels={"app":"whatsapp-bot","category":"CONTEXT_DEBUG","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:27:30.584Z"
2025-07-26T22:27:33.217934057Z [INFO] [OPENAI_POLLING] Esperando... jsonPayload={"attempts":1,"category":"OPENAI_POLLING","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","runId":"run_p1ALxAFcLQwImOm3cLDl81C5","shortUserId":"573003913251","status":"in_progress","timestamp":"2025-07-26T22:27:33.216Z"} labels={"app":"whatsapp-bot","category":"OPENAI_POLLING","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:27:33.216Z"
2025-07-26T22:27:34.482021768Z [INFO] [TOKEN_USAGE] Tokens utilizados jsonPayload={"category":"TOKEN_USAGE","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","threadId":"thread_uJrmjwIRjMkCSI95PpLU05k8","timestamp":"2025-07-26T22:27:34.479Z","totalTokens":3525} labels={"app":"whatsapp-bot","category":"TOKEN_USAGE","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:27:34.479Z"
2025-07-26T22:27:34.609410889Z [INFO] [OPENAI_RESPONSE_RAW] Respuesta exacta recibida de OpenAI jsonPayload={"category":"OPENAI_RESPONSE_RAW","environment":"cloud-run","flow":{"stage":"0_unknown"},"hasDoubleAsterisks":false,"level":"INFO","responseLength":113,"responsePreview":"Claro, ¬øpara qu√© fechas necesitas la disponibilidad? Y tambi√©n me ayudar√≠a saber cu√°ntas personas se hospedar√≠an.","responseText":"Claro, ¬øpara qu√© fechas necesitas la disponibilidad? Y tambi√©n me ayudar√≠a saber cu√°ntas personas se hospedar√≠an.","shortUserId":"573003913251","threadId":"thread_uJrmjwIRjMkCSI95PpLU05k8","timestamp":"2025-07-26T22:27:34.605Z"} labels={"app":"whatsapp-bot","category":"OPENAI_RESPONSE_RAW","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:27:34.605Z"
2025-07-26T22:27:34.609464357Z [INFO] [PERFORMANCE_METRICS] Procesamiento completado exitosamente jsonPayload={"category":"PERFORMANCE_METRICS","contextTokens":0,"environment":"cloud-run","flow":{"stage":"9_complete"},"isEfficient":false,"level":"INFO","memory":{"heapTotalMB":30,"heapUsedMB":28,"rssMB":90},"responseLength":113,"shortUserId":"573003913251","threadId":"thread_uJrmjwIRjMkCSI95PpLU05k8","timestamp":"2025-07-26T22:27:34.605Z","tokensPerSecond":812,"totalDurationMs":4339,"totalTokens":3525} labels={"app":"whatsapp-bot","category":"PERFORMANCE_METRICS","flow_stage":"9_complete","level":"INFO"} timestamp="2025-07-26T22:27:34.605Z"
ü§ñ OpenAI ‚Üí Sr Alex (0.0s)
üé§ Generando voz para 573003913251: "Claro, ¬øpara qu√© fechas necesitas la disponibilida..."
2025-07-26T22:27:38.448174598Z [INFO] [VOICE_RESPONSE_SENT] Respuesta de voz enviada exitosamente jsonPayload={"category":"VOICE_RESPONSE_SENT","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"SUCCESS","messageLength":113,"timestamp":"2025-07-26T22:27:38.444Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"VOICE_RESPONSE_SENT","flow_stage":"0_unknown","level":"SUCCESS","user_id":"573003913251"} timestamp="2025-07-26T22:27:38.444Z"
2025-07-26T22:27:38.448221827Z [INFO] [QUEUE_ITEM_SUCCESS] Mensaje procesado exitosamente jsonPayload={"category":"QUEUE_ITEM_SUCCESS","environment":"cloud-run","flow":{"sequence":3,"stage":"0_unknown"},"level":"SUCCESS","messageId":"msg_1753568849710_sh1dwg257","processedCount":1,"remainingInQueue":0,"timestamp":"2025-07-26T22:27:38.444Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_ITEM_SUCCESS","flow_stage":"0_unknown","level":"SUCCESS","message_id":"msg_1753568849710_sh1dwg257","user_id":"573003913251"} timestamp="2025-07-26T22:27:38.444Z"
2025-07-26T22:27:38.448248010Z [INFO] [LOCK_ALREADY_RELEASED] Lock ya liberado para usuario jsonPayload={"activeLocks":0,"category":"LOCK_ALREADY_RELEASED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"TRACE","timestamp":"2025-07-26T22:27:38.445Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"LOCK_ALREADY_RELEASED","flow_stage":"0_unknown","level":"TRACE","user_id":"573003913251"} timestamp="2025-07-26T22:27:38.445Z"
2025-07-26T22:27:38.448277167Z [INFO] [QUEUE_PROCESSING_COMPLETE] Cola de usuario procesada completamente jsonPayload={"averageTimePerMessage":"8735ms","category":"QUEUE_PROCESSING_COMPLETE","environment":"cloud-run","errorCount":0,"flow":{"stage":"0_unknown"},"initialQueueLength":1,"level":"SUCCESS","processedCount":1,"processingDuration":"8735ms","remainingQueues":0,"timestamp":"2025-07-26T22:27:38.445Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_PROCESSING_COMPLETE","flow_stage":"0_unknown","level":"SUCCESS","user_id":"573003913251"} timestamp="2025-07-26T22:27:38.445Z"
2025-07-26T22:27:58.442146693Z [INFO] [PRESENCE_EVENT] Procesando 1 eventos de presencia jsonPayload={"category":"PRESENCE_EVENT","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","presenceCount":1,"timestamp":"2025-07-26T22:27:48.908Z"} labels={"app":"whatsapp-bot","category":"PRESENCE_EVENT","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:27:48.908Z"
2025-07-26T22:27:58.442187988Z [INFO] [PRESENCE_RECEIVED] Presencia para 573003913251: recording jsonPayload={"category":"PRESENCE_RECEIVED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","status":"recording","timestamp":"2025-07-26T22:27:48.908Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"PRESENCE_RECEIVED","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-26T22:27:48.908Z"
2025-07-26T22:27:58.442225045Z [INFO] [BUFFER_TIMER_SET] Timer inteligente configurado jsonPayload={"bufferSize":0,"category":"BUFFER_TIMER_SET","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","timerMs":10000,"timestamp":"2025-07-26T22:27:48.908Z","triggerType":"recording","userJid":"573003913251","userName":"573003913251","wasReconfigured":true} labels={"app":"whatsapp-bot","category":"BUFFER_TIMER_SET","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:27:48.908Z"
üéôÔ∏è 573003913251 est√° grabando...
2025-07-26T22:27:59.200999298Z [INFO] [PRESENCE_EVENT] Procesando 1 eventos de presencia jsonPayload={"category":"PRESENCE_EVENT","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","presenceCount":1,"timestamp":"2025-07-26T22:27:59.199Z"} labels={"app":"whatsapp-bot","category":"PRESENCE_EVENT","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:27:59.199Z"
2025-07-26T22:27:59.201022243Z [INFO] [PRESENCE_RECEIVED] Presencia para 573003913251: recording jsonPayload={"category":"PRESENCE_RECEIVED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","status":"recording","timestamp":"2025-07-26T22:27:59.200Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"PRESENCE_RECEIVED","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-26T22:27:59.200Z"
2025-07-26T22:27:59.201049073Z [INFO] [BUFFER_TIMER_SET] Timer inteligente configurado jsonPayload={"bufferSize":0,"category":"BUFFER_TIMER_SET","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","timerMs":10000,"timestamp":"2025-07-26T22:27:59.200Z","triggerType":"recording","userJid":"573003913251","userName":"573003913251","wasReconfigured":true} labels={"app":"whatsapp-bot","category":"BUFFER_TIMER_SET","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:27:59.200Z"
üéôÔ∏è 573003913251 est√° grabando...
2025-07-26T22:28:01.260238992Z [INFO] [PRESENCE_EVENT] Procesando 1 eventos de presencia jsonPayload={"category":"PRESENCE_EVENT","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","presenceCount":1,"timestamp":"2025-07-26T22:28:01.255Z"} labels={"app":"whatsapp-bot","category":"PRESENCE_EVENT","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:28:01.255Z"
2025-07-26T22:28:01.260292878Z [INFO] [PRESENCE_RECEIVED] Presencia para 573003913251: online jsonPayload={"category":"PRESENCE_RECEIVED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","status":"online","timestamp":"2025-07-26T22:28:01.255Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"PRESENCE_RECEIVED","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-26T22:28:01.255Z"
üé§ Sr Alex: [Nota de voz recibida]
2025-07-26T22:28:05.393904631Z [INFO] [AUDIO_TRANSCRIBED] Audio transcrito exitosamente jsonPayload={"category":"AUDIO_TRANSCRIBED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"SUCCESS","preview":"Mi amor, por ah√≠ como para el 20 del pr√≥ximo mes por cuatro noches. Somos tres personas y un ni√±o.","timestamp":"2025-07-26T22:28:05.392Z","transcriptionLength":98,"userId":"573003913251"} labels={"app":"whatsapp-bot","category":"AUDIO_TRANSCRIBED","flow_stage":"0_unknown","level":"SUCCESS","user_id":"573003913251"} timestamp="2025-07-26T22:28:05.392Z"
üë§ Sr Alex: "Mi amor, por ah√≠ como para el 20 del pr√≥ximo mes por cuatro ..."
2025-07-26T22:28:05.393959234Z [INFO] [BUFFER_TIMER_RESPECTED] Timer existente respetado (delay actual es suficiente) jsonPayload={"bufferSize":1,"category":"BUFFER_TIMER_RESPECTED","currentDelay":10000,"environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","requestedDelay":8000,"timestamp":"2025-07-26T22:28:05.392Z","triggerType":"voice","userJid":"573003913251","userName":"Sr Alex"} labels={"app":"whatsapp-bot","category":"BUFFER_TIMER_RESPECTED","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:28:05.392Z"
2025-07-26T22:28:05.393993135Z [INFO] [GLOBAL_BUFFER_ADD] Mensaje agregado al buffer global jsonPayload={"bufferSize":1,"category":"GLOBAL_BUFFER_ADD","delay":5000,"environment":"cloud-run","flow":{"stage":"0_unknown"},"isMedia":true,"level":"INFO","messageText":"üé§ Mi amor, por ah√≠ como para el 20 del pr√≥ximo me...","timestamp":"2025-07-26T22:28:05.392Z","userJid":"573003913251","userName":"Sr Alex"} labels={"app":"whatsapp-bot","category":"GLOBAL_BUFFER_ADD","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:28:05.392Z"
‚è∞ üéôÔ∏è Sr Alex dej√≥ de grabar.
2025-07-26T22:28:09.207161094Z [INFO] [GLOBAL_BUFFER_PROCESS] Procesando buffer global despu√©s de 5 segundos jsonPayload={"category":"GLOBAL_BUFFER_PROCESS","combinedText":"üé§ Mi amor, por ah√≠ como para el 20 del pr√≥ximo mes por cuatro noches. Somos tres personas y un ni√±o...","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","messageCount":1,"timestamp":"2025-07-26T22:28:09.201Z","userJid":"573003913251","userName":"Sr Alex"} labels={"app":"whatsapp-bot","category":"GLOBAL_BUFFER_PROCESS","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:28:09.201Z"
2025-07-26T22:28:10.000410203Z [INFO] [QUEUE_ITEM_ADDED] Mensaje agregado a cola de usuario jsonPayload={"category":"QUEUE_ITEM_ADDED","environment":"cloud-run","flow":{"sequence":1,"stage":"0_unknown"},"hasActiveLock":false,"level":"INFO","messageId":"msg_1753568889998_h6ihsf3mq","queueLength":1,"timestamp":"2025-07-26T22:28:09.998Z","totalQueues":1,"userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_ITEM_ADDED","flow_stage":"0_unknown","level":"INFO","message_id":"msg_1753568889998_h6ihsf3mq","user_id":"573003913251"} timestamp="2025-07-26T22:28:09.998Z"
2025-07-26T22:28:10.000447301Z [INFO] [QUEUE_PROCESSING_START] Procesando cola de usuario jsonPayload={"category":"QUEUE_PROCESSING_START","environment":"cloud-run","flow":{"stage":"0_unknown"},"hasActiveLock":false,"level":"INFO","queueLength":1,"timestamp":"2025-07-26T22:28:09.998Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_PROCESSING_START","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-26T22:28:09.998Z"
2025-07-26T22:28:10.000481446Z [INFO] [QUEUE_ITEM_PROCESSING] Procesando mensaje de cola jsonPayload={"category":"QUEUE_ITEM_PROCESSING","environment":"cloud-run","flow":{"sequence":2,"stage":"0_unknown"},"level":"TRACE","messageId":"msg_1753568889998_h6ihsf3mq","remainingInQueue":0,"timestamp":"2025-07-26T22:28:09.998Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_ITEM_PROCESSING","flow_stage":"0_unknown","level":"TRACE","message_id":"msg_1753568889998_h6ihsf3mq","user_id":"573003913251"} timestamp="2025-07-26T22:28:09.998Z"
2025-07-26T22:28:10.880505663Z [INFO] [RECORDING_INDICATOR_SENT] Recording indicator enviado para procesamiento de audio jsonPayload={"category":"RECORDING_INDICATOR_SENT","chatId":"573003913251@s.whatsapp.net","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","timestamp":"2025-07-26T22:28:10.877Z"} labels={"app":"whatsapp-bot","category":"RECORDING_INDICATOR_SENT","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:28:10.877Z"
2025-07-26T22:28:10.880550428Z [INFO] [THREAD_REUSE] Thread reutilizado para 573003913251 jsonPayload={"category":"THREAD_REUSE","chatId":"573003913251@s.whatsapp.net","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","threadId":"thread_uJrmjwIRjMkCSI95PpLU05k8","timestamp":"2025-07-26T22:28:10.878Z","userName":"Sr Alex"} labels={"app":"whatsapp-bot","category":"THREAD_REUSE","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:28:10.878Z"
2025-07-26T22:28:10.880589064Z [INFO] [HISTORY_SKIP] Skip fetch historial: Thread existe jsonPayload={"category":"HISTORY_SKIP","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","reason":"thread_already_exists","threadId":"thread_uJrmjwIRjMkCSI95PpLU05k8","timestamp":"2025-07-26T22:28:10.878Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"HISTORY_SKIP","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-26T22:28:10.878Z"
2025-07-26T22:28:10.880614642Z [INFO] [OPENAI_PROCESSING_START] Procesando mensaje de Sr Alex jsonPayload={"category":"OPENAI_PROCESSING_START","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","shortUserId":"573003913251","timestamp":"2025-07-26T22:28:10.878Z","userName":"Sr Alex"} labels={"app":"whatsapp-bot","category":"OPENAI_PROCESSING_START","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:28:10.878Z"
2025-07-26T22:28:11.307295364Z [INFO] [CACHE_HIT] Chat info desde cache jsonPayload={"cacheAge":80,"category":"CACHE_HIT","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","timestamp":"2025-07-26T22:28:11.290Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"CACHE_HIT","flow_stage":"0_unknown","level":"INFO","user_id":"573003913251"} timestamp="2025-07-26T22:28:11.290Z"
2025-07-26T22:28:11.307331004Z [INFO] [CONTEXT_DEBUG] Contexto enviado a OpenAI jsonPayload={"category":"CONTEXT_DEBUG","contextPreview":"NO_CONTEXT","contextReason":"no_cambios","contextTokensSaved":-151,"environment":"cloud-run","flow":{"stage":"0_unknown"},"isVoiceMessage":true,"level":"INFO","messagePreview":"üé§ Mi amor, por ah√≠ como para el 20 del pr√≥ximo mes por cuatro noches. Somos tres personas y un ni√±o","needsTemporalContext":false,"shortUserId":"573003913251","timestamp":"2025-07-26T22:28:11.290Z","totalLength":101} labels={"app":"whatsapp-bot","category":"CONTEXT_DEBUG","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:28:11.290Z"
2025-07-26T22:28:16.144144675Z [INFO] [OPENAI_POLLING] Esperando... jsonPayload={"attempts":1,"category":"OPENAI_POLLING","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","runId":"run_ZfiYKPRoTHaDR4rUf1bZLuRO","shortUserId":"573003913251","status":"queued","timestamp":"2025-07-26T22:28:16.142Z"} labels={"app":"whatsapp-bot","category":"OPENAI_POLLING","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:28:16.142Z"
2025-07-26T22:28:20.641624630Z [INFO] [FUNCTION_CALLING_START] function_calling_required jsonPayload={"category":"FUNCTION_CALLING_START","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","runId":"run_ZfiYKPRoTHaDR4rUf1bZLuRO","shortUserId":"573003913251","threadId":"thread_uJrmjwIRjMkCSI95PpLU05k8","timestamp":"2025-07-26T22:28:20.632Z","toolCallsCount":1} labels={"app":"whatsapp-bot","category":"FUNCTION_CALLING_START","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:28:20.632Z"
2025-07-26T22:28:20.641664356Z [INFO] [FUNCTION_EXECUTING] function_executing jsonPayload={"args":{"endDate":"2025-08-24","startDate":"2025-08-20"},"category":"FUNCTION_EXECUTING","environment":"cloud-run","flow":{"stage":"0_unknown"},"functionName":"check_availability","level":"INFO","shortUserId":"573003913251","timestamp":"2025-07-26T22:28:20.632Z","toolCallId":"call_3D0Y3yJ55vOTG2WyTbwmsxht"} labels={"app":"whatsapp-bot","category":"FUNCTION_EXECUTING","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:28:20.632Z"
‚öôÔ∏è check_availability(08/20-08/24, 4 noches)
2025-07-26T22:28:20.641712286Z [INFO] [BEDS24_REQUEST] Procesando consulta de disponibilidad jsonPayload={"category":"BEDS24_REQUEST","dateAdjusted":false,"endDate":"2025-08-24","environment":"cloud-run","flow":{"stage":"4_beds_request"},"hasSpecificProperty":false,"hasSpecificRoom":false,"level":"INFO","maxTransfers":3,"nights":4,"originalEndDate":"2025-08-24","originalStartDate":"2025-08-20","propertyId":null,"requestType":"availability_check","roomId":null,"startDate":"2025-08-20","timestamp":"2025-07-26T22:28:20.641Z"} labels={"app":"whatsapp-bot","category":"BEDS24_REQUEST","flow_stage":"4_beds_request","level":"INFO"} timestamp="2025-07-26T22:28:20.641Z"
2025-07-26T22:28:20.641743947Z [INFO] [AVAILABILITY_HANDLER] Procesando consulta de disponibilidad jsonPayload={"category":"AVAILABILITY_HANDLER","dateAdjusted":false,"endDate":"2025-08-24","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","propertyId":null,"roomId":null,"startDate":"2025-08-20","timestamp":"2025-07-26T22:28:20.641Z"} labels={"app":"whatsapp-bot","category":"AVAILABILITY_HANDLER","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:28:20.641Z"
2025-07-26T22:28:20.645334209Z [INFO] [BEDS24_CACHE_MISS] Cache de disponibilidad no encontrado o expirado jsonPayload={"cacheKey":"availability_2025-08-20_2025-08-24_any_any","category":"BEDS24_CACHE_MISS","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","timestamp":"2025-07-26T22:28:20.641Z"} labels={"app":"whatsapp-bot","category":"BEDS24_CACHE_MISS","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:28:20.641Z"
2025-07-26T22:28:20.645376384Z [INFO] [BEDS24_PROCESSING] Calculando noches de estad√≠a jsonPayload={"category":"BEDS24_PROCESSING","dateCalculation":"stay_nights_only","endDate":"2025-08-24","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","nightsRange":["2025-08-20","2025-08-21","2025-08-22","2025-08-23"],"startDate":"2025-08-20","timestamp":"2025-07-26T22:28:20.642Z","totalNights":4} labels={"app":"whatsapp-bot","category":"BEDS24_PROCESSING","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:28:20.642Z"
2025-07-26T22:28:21.147235189Z [INFO] [BEDS24_API_CALL] Consulta optimizada a Beds24 (solo calendar) jsonPayload={"category":"BEDS24_API_CALL","dateRange":"2025-08-20 - 2025-08-24","endpoint":"inventory/rooms/calendar","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","method":"GET","nightsCalculated":4,"optimization":"single-endpoint","parameters":{"endDate":"2025-08-24","includeMaxStay":true,"includeMinStay":true,"includeMultiplier":true,"includeNumAvail":true,"includeOverride":true,"includePrices":true,"startDate":"2025-08-20"},"success":true,"timestamp":"2025-07-26T22:28:21.145Z","totalProperties":7} labels={"app":"whatsapp-bot","category":"BEDS24_API_CALL","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:28:21.145Z"
2025-07-26T22:28:21.147279879Z [INFO] [BEDS24_RESPONSE_DETAIL] Respuesta cruda de Beds24 API jsonPayload={"category":"BEDS24_RESPONSE_DETAIL","environment":"cloud-run","firstRoom":{"calendarEntries":3,"name":"Apartamento 2005-A","propertyId":173207,"roomId":378110,"sampleEntry":{"from":"2025-08-20","maxStay":365,"minStay":3,"multiplier":1,"numAvail":0,"override":"none","price1":205000,"to":"2025-08-21"}},"flow":{"stage":"0_unknown"},"level":"INFO","responseSize":2563,"responseStructure":["roomId","propertyId","name","calendar"],"success":true,"timestamp":"2025-07-26T22:28:21.145Z","totalRooms":7} labels={"app":"whatsapp-bot","category":"BEDS24_RESPONSE_DETAIL","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:28:21.145Z"
2025-07-26T22:28:21.147310862Z [INFO] [BEDS24_DATA_MAPPING] Procesando datos de Beds24 jsonPayload={"beds24DataCount":7,"category":"BEDS24_DATA_MAPPING","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","originalEndDate":"2025-08-24","originalStartDate":"2025-08-20","timestamp":"2025-07-26T22:28:21.145Z"} labels={"app":"whatsapp-bot","category":"BEDS24_DATA_MAPPING","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:28:21.145Z"
2025-07-26T22:28:21.147343457Z [INFO] [BEDS24_CLASSIFICATION] Propiedades clasificadas jsonPayload={"category":"BEDS24_CLASSIFICATION","completeOptions":2,"environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","nightsAnalyzed":4,"partialOptions":5,"timestamp":"2025-07-26T22:28:21.146Z","willGenerateSplits":true} labels={"app":"whatsapp-bot","category":"BEDS24_CLASSIFICATION","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:28:21.146Z"
2025-07-26T22:28:21.150143593Z [INFO] [BEDS24_RESPONSE_SUMMARY] Encontradas 2 opciones completas y 0 opciones con traslado jsonPayload={"category":"BEDS24_RESPONSE_SUMMARY","completeOptionsDetail":[{"pricePerNight":210000,"propertyName":"Apartamento 1317","totalPrice":840000},{"pricePerNight":210000,"propertyName":"Apartamento 715","totalPrice":840000}],"dateRange":"2025-08-20 al 2025-08-24","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","splitOptionsDetail":[],"timestamp":"2025-07-26T22:28:21.147Z","totalNights":4} labels={"app":"whatsapp-bot","category":"BEDS24_RESPONSE_SUMMARY","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:28:21.147Z"
2025-07-26T22:28:21.159092062Z [INFO] [BEDS24_DEBUG_OUTPUT] Respuesta formateada para OpenAI jsonPayload={"category":"BEDS24_DEBUG_OUTPUT","environment":"cloud-run","estimatedTokens":54,"flow":{"stage":"0_unknown"},"hasCompleteOptions":true,"hasSplitOptions":false,"level":"INFO","responseLength":214,"responsePreview":"üìÖ Disponibilidad: 20/08/2025 al 24/08/2025 (4 noches)\n\n‚úÖ APARTAMENTOS DISPONIBLES (2 Aptos Disponibles):\nüè† Apartamento 1317 - $840,000 total ($210,000/noche)\nüè† Apartamento 715 - $840,000 total ($21","timestamp":"2025-07-26T22:28:21.154Z"} labels={"app":"whatsapp-bot","category":"BEDS24_DEBUG_OUTPUT","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:28:21.154Z"
2025-07-26T22:28:21.159158285Z [INFO] [BEDS24_RESPONSE_DETAIL] Respuesta completa de Beds24 enviada a OpenAI jsonPayload={"category":"BEDS24_RESPONSE_DETAIL","completeOptionsCount":2,"environment":"cloud-run","estimatedTokens":54,"flow":{"stage":"0_unknown"},"fullResponse":"üìÖ Disponibilidad: 20/08/2025 al 24/08/2025 (4 noches)\n\n‚úÖ APARTAMENTOS DISPONIBLES (2 Aptos Disponibles):\nüè† Apartamento 1317 - $840,000 total ($210,000/noche)\nüè† Apartamento 715 - $840,000 total ($210,000/noche)\n\n","hasCompleteOptions":true,"hasSplitOptions":false,"level":"INFO","responseLength":214,"responsePreview":"üìÖ Disponibilidad: 20/08/2025 al 24/08/2025 (4 noches)\n\n‚úÖ APARTAMENTOS DISPONIBLES (2 Aptos Disponibles):\nüè† Apartamento 1317 - $840,000 total ($210,000/noche)\nüè† Apartamento 715 - $840,000 total ($21...","splitOptionsCount":0,"timestamp":"2025-07-26T22:28:21.154Z","totalNights":4} labels={"app":"whatsapp-bot","category":"BEDS24_RESPONSE_DETAIL","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:28:21.154Z"
2025-07-26T22:28:21.159188824Z [INFO] [AVAILABILITY_HANDLER] Consulta completada exitosamente jsonPayload={"apiResponseSize":617,"category":"AVAILABILITY_HANDLER","completeOptions":2,"dateAdjusted":false,"dateRange":"2025-08-20 a 2025-08-24","environment":"cloud-run","flow":{"stage":"0_unknown"},"isEfficient":true,"level":"SUCCESS","processingMs":514,"responseSize":617,"splitOptions":0,"timestamp":"2025-07-26T22:28:21.154Z"} labels={"app":"whatsapp-bot","category":"AVAILABILITY_HANDLER","flow_stage":"0_unknown","level":"SUCCESS"} timestamp="2025-07-26T22:28:21.154Z"
2025-07-26T22:28:21.159216507Z [INFO] [FUNCTION_HANDLER] function_success jsonPayload={"category":"FUNCTION_HANDLER","environment":"cloud-run","flow":{"stage":"0_unknown"},"functionName":"check_availability","level":"INFO","resultLength":214,"shortUserId":"573003913251","status":"success","timestamp":"2025-07-26T22:28:21.154Z","toolCallId":"call_3D0Y3yJ55vOTG2WyTbwmsxht"} labels={"app":"whatsapp-bot","category":"FUNCTION_HANDLER","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:28:21.154Z"
2025-07-26T22:28:22.701032583Z [INFO] [TOOL_OUTPUTS_SUBMITTED] Tool outputs enviados a OpenAI jsonPayload={"category":"TOOL_OUTPUTS_SUBMITTED","environment":"cloud-run","flow":{"stage":"6_ai_request"},"level":"INFO","outputs":[{"id":"call_3D0Y3yJ55vOTG2WyTbwmsxht","outputLength":214,"outputPreview":"üìÖ Disponibilidad: 20/08/2025 al 24/08/2025 (4 noches)\n\n‚úÖ APARTAMENTOS DISPONIBLES (2 Aptos Disponib..."}],"runId":"run_ZfiYKPRoTHaDR4rUf1bZLuRO","shortUserId":"573003913251","threadId":"thread_uJrmjwIRjMkCSI95PpLU05k8","timestamp":"2025-07-26T22:28:22.691Z","totalOutputs":1} labels={"app":"whatsapp-bot","category":"TOOL_OUTPUTS_SUBMITTED","flow_stage":"6_ai_request","level":"INFO"} timestamp="2025-07-26T22:28:22.691Z"
2025-07-26T22:28:22.701066238Z [INFO] [POST_SUBMIT_STATUS] Status despu√©s de submit tool outputs jsonPayload={"category":"POST_SUBMIT_STATUS","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","runId":"run_ZfiYKPRoTHaDR4rUf1bZLuRO","runStatus":"requires_action","shortUserId":"573003913251","timestamp":"2025-07-26T22:28:22.691Z"} labels={"app":"whatsapp-bot","category":"POST_SUBMIT_STATUS","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:28:22.691Z"
2025-07-26T22:28:23.949578925Z [INFO] [POST_TOOL_POLLING] Polling post-tool - Intento 1/10 jsonPayload={"attempt":1,"category":"POST_TOOL_POLLING","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","runId":"run_ZfiYKPRoTHaDR4rUf1bZLuRO","shortUserId":"573003913251","status":"in_progress","timestamp":"2025-07-26T22:28:23.941Z"} labels={"app":"whatsapp-bot","category":"POST_TOOL_POLLING","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:28:23.941Z"
2025-07-26T22:28:24.787650565Z [INFO] [POST_TOOL_POLLING] Polling post-tool - Intento 2/10 jsonPayload={"attempt":2,"category":"POST_TOOL_POLLING","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","runId":"run_ZfiYKPRoTHaDR4rUf1bZLuRO","shortUserId":"573003913251","status":"in_progress","timestamp":"2025-07-26T22:28:24.756Z"} labels={"app":"whatsapp-bot","category":"POST_TOOL_POLLING","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:28:24.756Z"
2025-07-26T22:28:26.040390680Z [INFO] [POST_TOOL_POLLING] Polling post-tool - Intento 3/10 jsonPayload={"attempt":3,"category":"POST_TOOL_POLLING","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","runId":"run_ZfiYKPRoTHaDR4rUf1bZLuRO","shortUserId":"573003913251","status":"in_progress","timestamp":"2025-07-26T22:28:26.036Z"} labels={"app":"whatsapp-bot","category":"POST_TOOL_POLLING","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:28:26.036Z"
2025-07-26T22:28:27.880303585Z [INFO] [POST_TOOL_POLLING] Polling post-tool - Intento 4/10 jsonPayload={"attempt":4,"category":"POST_TOOL_POLLING","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","runId":"run_ZfiYKPRoTHaDR4rUf1bZLuRO","shortUserId":"573003913251","status":"completed","timestamp":"2025-07-26T22:28:27.876Z"} labels={"app":"whatsapp-bot","category":"POST_TOOL_POLLING","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:28:27.876Z"
2025-07-26T22:28:27.880335259Z [INFO] [POST_TOOL_POLLING_COMPLETE] Polling post-tool completado jsonPayload={"attempts":3,"category":"POST_TOOL_POLLING_COMPLETE","environment":"cloud-run","finalStatus":"completed","flow":{"stage":"0_unknown"},"level":"INFO","runId":"run_ZfiYKPRoTHaDR4rUf1bZLuRO","shortUserId":"573003913251","timestamp":"2025-07-26T22:28:27.876Z"} labels={"app":"whatsapp-bot","category":"POST_TOOL_POLLING_COMPLETE","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:28:27.876Z"
2025-07-26T22:28:28.056424972Z [INFO] [OPENAI_RESPONSE_RAW_FUNCTION] Respuesta exacta recibida de OpenAI despu√©s de function calling jsonPayload={"category":"OPENAI_RESPONSE_RAW_FUNCTION","environment":"cloud-run","flow":{"stage":"0_unknown"},"hasDoubleAsterisks":false,"level":"INFO","responseLength":544,"responsePreview":"Tenemos dos opciones de apartamentos disponibles para tus fechas del 20 al 24 de agosto, para cuatro noches:\n\n1. Apartamento 1317 - 1 Alcoba\n   - Total: $840.000 ($210.000 por noche)\n   - Fotos: \n    ...","responseText":"Tenemos dos opciones de apartamentos disponibles para tus fechas del 20 al 24 de agosto, para cuatro noches:\n\n1. Apartamento 1317 - 1 Alcoba\n   - Total: $840.000 ($210.000 por noche)\n   - Fotos: \n     https://wa.me/p/6754564561280380/573023371476\n\n2. Apartamento 715 - 1 Alcoba\n   - Total: $840.000 ($210.000 por noche)\n   - Fotos: \n     https://wa.me/p/8626205680752509/573023371476\n\nAmbos apartamentos tienen una vista espectacular al mar y est√°n equipados con aire acondicionado y WiFi gratuito. Si alguno te interesa, ¬°d√≠melo para proceder!","shortUserId":"573003913251","threadId":"thread_uJrmjwIRjMkCSI95PpLU05k8","timestamp":"2025-07-26T22:28:28.055Z"} labels={"app":"whatsapp-bot","category":"OPENAI_RESPONSE_RAW_FUNCTION","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:28:28.055Z"
2025-07-26T22:28:28.056456177Z [INFO] [FUNCTION_CALLING_RESPONSE] Respuesta final recibida despu√©s de function calling jsonPayload={"category":"FUNCTION_CALLING_RESPONSE","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"SUCCESS","responseLength":544,"shortUserId":"573003913251","threadId":"thread_uJrmjwIRjMkCSI95PpLU05k8","timestamp":"2025-07-26T22:28:28.055Z","toolCallsExecuted":1} labels={"app":"whatsapp-bot","category":"FUNCTION_CALLING_RESPONSE","flow_stage":"0_unknown","level":"SUCCESS"} timestamp="2025-07-26T22:28:28.055Z"
ü§ñ OpenAI ‚Üí Sr Alex (0.0s)
üé§ Generando voz para 573003913251: "Tenemos dos opciones de apartamentos disponibles p..."
2025-07-26T22:28:48.057048608Z [INFO] [VOICE_RESPONSE_SENT] Respuesta de voz enviada exitosamente jsonPayload={"category":"VOICE_RESPONSE_SENT","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"SUCCESS","messageLength":544,"timestamp":"2025-07-26T22:28:40.002Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"VOICE_RESPONSE_SENT","flow_stage":"0_unknown","level":"SUCCESS","user_id":"573003913251"} timestamp="2025-07-26T22:28:40.002Z"
2025-07-26T22:28:48.057090092Z [INFO] [QUEUE_ITEM_SUCCESS] Mensaje procesado exitosamente jsonPayload={"category":"QUEUE_ITEM_SUCCESS","environment":"cloud-run","flow":{"sequence":3,"stage":"0_unknown"},"level":"SUCCESS","messageId":"msg_1753568889998_h6ihsf3mq","processedCount":1,"remainingInQueue":0,"timestamp":"2025-07-26T22:28:40.002Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_ITEM_SUCCESS","flow_stage":"0_unknown","level":"SUCCESS","message_id":"msg_1753568889998_h6ihsf3mq","user_id":"573003913251"} timestamp="2025-07-26T22:28:40.002Z"
2025-07-26T22:28:48.057131583Z [INFO] [LOCK_ALREADY_RELEASED] Lock ya liberado para usuario jsonPayload={"activeLocks":0,"category":"LOCK_ALREADY_RELEASED","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"TRACE","timestamp":"2025-07-26T22:28:40.002Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"LOCK_ALREADY_RELEASED","flow_stage":"0_unknown","level":"TRACE","user_id":"573003913251"} timestamp="2025-07-26T22:28:40.002Z"
2025-07-26T22:28:48.057167221Z [INFO] [QUEUE_PROCESSING_COMPLETE] Cola de usuario procesada completamente jsonPayload={"averageTimePerMessage":"30004ms","category":"QUEUE_PROCESSING_COMPLETE","environment":"cloud-run","errorCount":0,"flow":{"stage":"0_unknown"},"initialQueueLength":1,"level":"SUCCESS","processedCount":1,"processingDuration":"30004ms","remainingQueues":0,"timestamp":"2025-07-26T22:28:40.002Z","userId":"573003913251"} labels={"app":"whatsapp-bot","category":"QUEUE_PROCESSING_COMPLETE","flow_stage":"0_unknown","level":"SUCCESS","user_id":"573003913251"} timestamp="2025-07-26T22:28:40.002Z"
2025-07-26T22:31:28.116948732Z [INFO] [THREAD_PERSIST] 1 threads guardados jsonPayload={"category":"THREAD_PERSIST","environment":"cloud-run","file":"tmp/threads.json","flow":{"stage":"0_unknown"},"level":"INFO","source":"save_operation","threadsCount":1,"timestamp":"2025-07-26T22:31:26.750Z"} labels={"app":"whatsapp-bot","category":"THREAD_PERSIST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:31:26.750Z"
2025-07-26T22:31:28.116975734Z [INFO] [THREAD_PERSIST] Auto-guardado ejecutado (hab√≠a cambios pendientes) jsonPayload={"category":"THREAD_PERSIST","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","timestamp":"2025-07-26T22:31:26.750Z"} labels={"app":"whatsapp-bot","category":"THREAD_PERSIST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:31:26.750Z"
Stopping Container
[2025-07-26T17:26:26.696Z] [SUCCESS] LOGGER_INIT [unknown.ts]: Sistema de logging por sesi√≥n inicializado | {"sessionId":"session-2025-07-26T17-26-26","logFile":"logs/bot-session-2025-07-26T17-26-26.log","maxSessions":5,"maxBufferSizeLocal":50,"maxBufferSizeRailway":400,"bufferInterval":100}
‚úÖ Logs guardados en: logs/bot-session-2025-07-26T17-26-26.log

üìÅ Sesiones disponibles (1/5):
   1. bot-session-2025-07-26T17-26-26.log (0.7KB - 26/7/2025, 10:33:36 p.¬†m.)
2025-07-26T22:33:38.163069463Z [INFO] [THREAD_PERSIST] Guardando threads antes de cerrar... jsonPayload={"category":"THREAD_PERSIST","environment":"cloud-run","flow":{"stage":"0_unknown"},"level":"INFO","timestamp":"2025-07-26T22:33:36.971Z"} labels={"app":"whatsapp-bot","category":"THREAD_PERSIST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:33:36.971Z"
2025-07-26T22:33:38.163110463Z [INFO] [THREAD_PERSIST] 1 threads guardados jsonPayload={"category":"THREAD_PERSIST","environment":"cloud-run","file":"tmp/threads.json","flow":{"stage":"0_unknown"},"level":"INFO","source":"save_operation","threadsCount":1,"timestamp":"2025-07-26T22:33:36.972Z"} labels={"app":"whatsapp-bot","category":"THREAD_PERSIST","flow_stage":"0_unknown","level":"INFO"} timestamp="2025-07-26T22:33:36.972Z"
‚úÖ Logs guardados en: logs/bot-session-2025-07-26T17-26-26.log

üìÅ Sesiones disponibles (1/5):
   1. bot-session-2025-07-26T17-26-26.log (0.9KB - 26/7/2025, 10:33:36 p.¬†m.)
npm notice
npm notice New major version of npm available! 10.8.2 -> 11.5.1
npm notice Changelog: https://github.com/npm/cli/releases/tag/v11.5.1
npm notice To update run: npm install -g npm@11.5.1
npm notice
