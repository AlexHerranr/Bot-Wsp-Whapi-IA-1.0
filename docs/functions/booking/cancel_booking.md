# üìã cancel_booking - Cancelar Reserva

## üéØ Descripci√≥n

Funci√≥n para cancelar una reserva existente en Beds24. Permite al bot procesar autom√°ticamente las solicitudes de cancelaci√≥n de los hu√©spedes, aplicando pol√≠ticas de cancelaci√≥n y procesando reembolsos seg√∫n corresponda.

---

## üì§ Par√°metros de Entrada

### **Esquema OpenAI:**
```json
{
  "name": "cancel_booking",
  "description": "Cancela una reserva existente en Beds24 aplicando pol√≠ticas de cancelaci√≥n",
  "parameters": {
    "type": "object",
    "properties": {
      "bookingId": {
        "type": "string",
        "description": "ID √∫nico de la reserva a cancelar"
      },
      "confirmationNumber": {
        "type": "string",
        "description": "N√∫mero de confirmaci√≥n de la reserva"
      },
      "guestEmail": {
        "type": "string",
        "format": "email",
        "description": "Email del hu√©sped (para verificaci√≥n)"
      },
      "reason": {
        "type": "string",
        "enum": [
          "guest_request",
          "property_issue",
          "force_majeure",
          "payment_failed",
          "duplicate_booking",
          "other"
        ],
        "description": "Raz√≥n de la cancelaci√≥n"
      },
      "reasonDetails": {
        "type": "string",
        "description": "Detalles adicionales sobre la raz√≥n de cancelaci√≥n"
      },
      "refundRequested": {
        "type": "boolean",
        "description": "Si el hu√©sped solicita reembolso (opcional, por defecto true)"
      },
      "notifyGuest": {
        "type": "boolean",
        "description": "Si notificar al hu√©sped por email (opcional, por defecto true)"
      }
    },
    "required": [
      "reason"
    ],
    "additionalProperties": false
  }
}
```

**Nota:** Se debe proporcionar al menos `bookingId` o `confirmationNumber` para identificar la reserva.

---

## üì• Respuesta Esperada

### **Respuesta Exitosa (Cancelaci√≥n Completa):**
```json
{
  "success": true,
  "data": {
    "bookingId": "BK123456",
    "confirmationNumber": "CNF789012",
    "status": "cancelled",
    "cancellationDate": "2025-07-12T10:30:00Z",
    "originalBooking": {
      "guestName": "Juan P√©rez",
      "propertyName": "Apartamento 1317",
      "checkIn": "2025-07-15",
      "checkOut": "2025-07-18",
      "totalPrice": 450000
    },
    "refund": {
      "eligible": true,
      "amount": 360000,
      "percentage": 80,
      "reason": "Cancelaci√≥n dentro del periodo permitido",
      "estimatedProcessingTime": "3-5 d√≠as h√°biles",
      "method": "original_payment_method"
    },
    "fees": {
      "cancellationFee": 90000,
      "processingFee": 0,
      "totalFees": 90000
    },
    "notifications": {
      "guestNotified": true,
      "emailSent": true,
      "smsNotification": false
    }
  },
  "message": "Reserva cancelada exitosamente con reembolso de $360.000"
}
```

### **Respuesta Exitosa (Sin Reembolso):**
```json
{
  "success": true,
  "data": {
    "bookingId": "BK123456",
    "status": "cancelled",
    "cancellationDate": "2025-07-12T10:30:00Z",
    "refund": {
      "eligible": false,
      "amount": 0,
      "reason": "Cancelaci√≥n fuera del periodo permitido",
      "policy": "No reembolso despu√©s de 48 horas antes del check-in"
    },
    "notifications": {
      "guestNotified": true,
      "emailSent": true
    }
  },
  "message": "Reserva cancelada. No hay reembolso disponible seg√∫n pol√≠tica de cancelaci√≥n"
}
```

### **Respuesta de Error:**
```json
{
  "success": false,
  "error": "La reserva no puede ser cancelada porque el check-in ya ocurri√≥",
  "code": "BOOKING_NOT_CANCELLABLE",
  "data": {
    "bookingStatus": "checked_in",
    "checkInDate": "2025-07-15T15:00:00Z",
    "policy": "No se permiten cancelaciones despu√©s del check-in"
  }
}
```

---

## üîß Proceso de Cancelaci√≥n

### **1. Validaciones Previas:**
- ‚úÖ Verificar que la reserva existe
- ‚úÖ Confirmar que la reserva puede ser cancelada
- ‚úÖ Validar identidad del hu√©sped (email)
- ‚úÖ Verificar estado actual de la reserva
- ‚úÖ Aplicar pol√≠ticas de cancelaci√≥n

### **2. Pol√≠ticas de Cancelaci√≥n:**

| Periodo | Reembolso | Tarifa | Condiciones |
|---------|-----------|--------|-------------|
| **> 7 d√≠as** | ‚úÖ **100%** | Sin tarifa | Reembolso completo |
| **3-7 d√≠as** | ‚úÖ **80%** | 20% tarifa | Tarifa moderada |
| **1-3 d√≠as** | ‚úÖ **50%** | 50% tarifa | Tarifa alta |
| **< 24 horas** | ‚ùå **0%** | 100% tarifa | Sin reembolso |
| **Despu√©s check-in** | ‚ùå **0%** | 100% tarifa | No cancelable |

### **3. Integraci√≥n con Beds24:**
- üîó **Endpoint**: `PUT /bookings/{id}/cancel`
- üìã **Datos requeridos**: ID de reserva, raz√≥n, pol√≠ticas
- üîê **Autenticaci√≥n**: Token de API de Beds24
- ‚è±Ô∏è **Timeout**: 30 segundos

### **4. Procesamiento:**
```typescript
// Pseudoc√≥digo del flujo
async function cancelBooking(args: any): Promise<FunctionResponse> {
  // 1. Buscar y validar reserva
  const booking = await findBooking(args);
  if (!booking) {
    throw new Error('Reserva no encontrada');
  }
  
  // 2. Verificar si puede ser cancelada
  const cancellationCheck = await validateCancellation(booking);
  if (!cancellationCheck.allowed) {
    throw new Error(cancellationCheck.reason);
  }
  
  // 3. Calcular reembolso seg√∫n pol√≠ticas
  const refundCalculation = await calculateRefund(booking, args.reason);
  
  // 4. Ejecutar cancelaci√≥n en Beds24
  const cancellation = await beds24API.cancelBooking(booking.id, {
    reason: args.reason,
    reasonDetails: args.reasonDetails,
    refundAmount: refundCalculation.amount
  });
  
  // 5. Procesar reembolso si aplica
  if (refundCalculation.eligible && args.refundRequested !== false) {
    await processRefund(booking, refundCalculation);
  }
  
  // 6. Notificar al hu√©sped
  if (args.notifyGuest !== false) {
    await notifyGuestCancellation(booking, cancellation, refundCalculation);
  }
  
  // 7. Retornar resultado
  return {
    success: true,
    data: {
      bookingId: booking.id,
      status: 'cancelled',
      cancellationDate: new Date().toISOString(),
      refund: refundCalculation,
      notifications: {
        guestNotified: args.notifyGuest !== false,
        emailSent: true
      }
    },
    message: generateCancellationMessage(refundCalculation)
  };
}
```

---

## üö® Casos de Error

### **Errores Comunes:**

| Error | C√≥digo | Causa | Soluci√≥n |
|-------|--------|-------|----------|
| `BOOKING_NOT_FOUND` | 404 | Reserva no existe | Verificar ID/confirmaci√≥n |
| `BOOKING_NOT_CANCELLABLE` | 400 | No se puede cancelar | Mostrar pol√≠tica |
| `ALREADY_CANCELLED` | 400 | Ya est√° cancelada | Mostrar estado actual |
| `CHECKED_IN_ALREADY` | 400 | Ya hizo check-in | Contactar soporte |
| `INVALID_GUEST_EMAIL` | 403 | Email no coincide | Verificar identidad |
| `REFUND_PROCESSING_ERROR` | 500 | Error en reembolso | Escalar a soporte |

### **Manejo de Errores:**
```typescript
try {
  const cancellation = await cancelBooking(args);
  return cancellation;
} catch (error) {
  if (error.code === 'BOOKING_NOT_CANCELLABLE') {
    const booking = await getBookingDetails(args);
    return {
      success: false,
      error: error.message,
      data: {
        bookingStatus: booking.status,
        checkInDate: booking.checkIn,
        policy: 'Consulta nuestra pol√≠tica de cancelaci√≥n para m√°s detalles'
      },
      suggestions: [
        'Contactar soporte para casos especiales',
        'Revisar t√©rminos y condiciones',
        'Considerar modificaci√≥n en lugar de cancelaci√≥n'
      ]
    };
  }
  
  // Error gen√©rico
  return {
    success: false,
    error: 'Error procesando la cancelaci√≥n. Por favor contacta soporte.'
  };
}
```

---

## üìä Integraci√≥n con OpenAI

### **Contexto para OpenAI (Cancelaci√≥n Exitosa con Reembolso):**
```
‚úÖ **Reserva Cancelada Exitosamente**

üìã **Detalles de la Cancelaci√≥n:**
‚Ä¢ Reserva: CNF789012
‚Ä¢ Hu√©sped: Juan P√©rez
‚Ä¢ Propiedad: Apartamento 1317
‚Ä¢ Fechas originales: 15/07/2025 - 18/07/2025

üí∞ **Informaci√≥n del Reembolso:**
‚Ä¢ Monto original: $450.000
‚Ä¢ Tarifa de cancelaci√≥n: $90.000 (20%)
‚Ä¢ Reembolso: $360.000
‚Ä¢ Tiempo estimado: 3-5 d√≠as h√°biles

üìß **Notificaciones:**
‚Ä¢ Email de confirmaci√≥n enviado
‚Ä¢ Recibir√°s detalles del reembolso por separado

¬øNecesitas ayuda con algo m√°s?
```

### **Contexto para OpenAI (Sin Reembolso):**
```
‚úÖ **Reserva Cancelada**

üìã **Detalles de la Cancelaci√≥n:**
‚Ä¢ Reserva: CNF789012
‚Ä¢ Estado: Cancelada exitosamente

‚ö†Ô∏è **Pol√≠tica de Reembolso:**
‚Ä¢ No hay reembolso disponible
‚Ä¢ Raz√≥n: Cancelaci√≥n fuera del periodo permitido
‚Ä¢ Pol√≠tica: No reembolso despu√©s de 48 horas antes del check-in

üìß **Confirmaci√≥n enviada por email**

Si tienes circunstancias especiales, puedes contactar nuestro equipo de soporte.
```

### **Contexto para OpenAI (Error):**
```
‚ùå **No se Puede Cancelar la Reserva**

üö® **Problema:** La reserva no puede ser cancelada porque el check-in ya ocurri√≥

üìã **Informaci√≥n:**
‚Ä¢ Estado actual: Check-in realizado
‚Ä¢ Fecha de entrada: 15/07/2025 3:00 PM
‚Ä¢ Pol√≠tica: No se permiten cancelaciones despu√©s del check-in

üí° **Opciones:**
‚Ä¢ Contactar soporte para casos especiales
‚Ä¢ Revisar opciones de modificaci√≥n
‚Ä¢ Consultar t√©rminos y condiciones

¬øTe gustar√≠a que te conecte con un agente para revisar tu caso?
```

---

## üß™ Testing

### **Casos de Prueba:**

1. **‚úÖ Cancelaci√≥n con Reembolso Completo**
   - M√°s de 7 d√≠as antes
   - Sin tarifas

2. **‚úÖ Cancelaci√≥n con Reembolso Parcial**
   - 3-7 d√≠as antes
   - Con tarifa del 20%

3. **‚úÖ Cancelaci√≥n Sin Reembolso**
   - Menos de 24 horas
   - Sin reembolso

4. **‚ùå Reserva Ya Cancelada**
   - Estado cancelled
   - Mostrar informaci√≥n

5. **‚ùå Check-in Realizado**
   - No cancelable
   - Sugerir contactar soporte

6. **‚ùå Email No Coincide**
   - Verificaci√≥n fallida
   - Solicitar datos correctos

### **Comando de Prueba:**
```bash
# Cuando se implemente
npm run function:test cancel_booking
```

---

## üîó Dependencias

### **APIs Externas:**
- üè® **Beds24 API**: Cancelaci√≥n de reservas
- üí≥ **Payment Gateway**: Procesamiento de reembolsos
- üìß **Email Service**: Notificaciones
- üì± **SMS Service**: Notificaciones m√≥viles (opcional)

### **Funciones Relacionadas:**
- `get_booking_details` - Obtener detalles de la reserva
- `calculate_refund` - Calcular montos de reembolso
- `process_refund` - Procesar reembolsos
- `send_notification` - Enviar notificaciones

---

## üöÄ Estado de Implementaci√≥n

| Componente | Estado | Notas |
|------------|--------|-------|
| **Documentaci√≥n** | ‚úÖ **Completa** | Este documento |
| **Esquema OpenAI** | ‚úÖ **Definido** | Par√°metros y validaciones |
| **Tipos TypeScript** | ‚úÖ **Definidos** | En function-types.ts |
| **Pol√≠ticas de Cancelaci√≥n** | ‚úÖ **Definidas** | Tabla de reembolsos |
| **Handler** | ‚ùå **Pendiente** | Por implementar |
| **Integraci√≥n Beds24** | ‚ùå **Pendiente** | API endpoints |
| **Procesamiento Reembolsos** | ‚ùå **Pendiente** | Gateway de pagos |
| **Tests** | ‚ùå **Pendiente** | Casos de prueba |

---

## üõ°Ô∏è Consideraciones de Seguridad

### **Validaci√≥n de Identidad:**
- ‚úÖ Verificar email del hu√©sped
- ‚úÖ Validar datos de la reserva
- ‚úÖ Registrar todas las cancelaciones
- ‚úÖ Auditor√≠a de cambios

### **Protecci√≥n contra Fraude:**
- üîí L√≠mites de cancelaciones por IP
- üîí Verificaci√≥n de patrones sospechosos
- üîí Alertas para cancelaciones masivas
- üîí Logs detallados de todas las operaciones

---

**üìÖ √öltima actualizaci√≥n:** Julio 2025  
**üîó Relacionado:** [create_booking](./create_booking.md) | [get_booking_details](./get_booking_details.md) 