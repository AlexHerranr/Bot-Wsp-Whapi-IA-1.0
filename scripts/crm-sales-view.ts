// scripts/crm-sales-view.ts
import { PrismaClient } from '@prisma/client';
import * as fs from 'fs';
import * as path from 'path';

const prisma = new PrismaClient();

interface CRMClientData {
    // Identificaci√≥n prioritaria
    phoneNumber: string;
    displayName: string;
    
    // Informaci√≥n de contacto
    chatId: string;
    isContact: boolean;
    
    // Actividad y engagement
    totalMessages: number;
    lastMessageRole: 'user' | 'assistant' | null;
    lastActivity: string;
    daysSinceLastActivity: number;
    
    // Etiquetas y clasificaci√≥n
    labels: string[];
    primaryLabel: string | null;
    
    // CRM Fields
    perfilStatus: string;      // Resumen del cliente
    proximaAccion: string;     // Qu√© hacer con este cliente
    prioridad: 'ALTA' | 'MEDIA' | 'BAJA';
    
    // Thread info (para referencia)
    openaiThreadId: string;
    
    // Preview del √∫ltimo mensaje
    lastMessage: string | null;
}

async function loadAllData() {
    // Cargar datos de todas las fuentes
    const threadsFile = path.join(process.cwd(), 'tmp', 'threads.json');
    const guestFile = path.join(process.cwd(), 'tmp', 'guest_profiles.json');
    
    const jsonThreads = new Map();
    const guestProfiles = new Map();
    
    // Cargar threads.json
    try {
        if (fs.existsSync(threadsFile)) {
            const data = fs.readFileSync(threadsFile, 'utf-8');
            const threadsArray = JSON.parse(data);
            for (const [phoneNumber, threadData] of threadsArray) {
                jsonThreads.set(phoneNumber, threadData);
            }
        }
    } catch (error) {
        console.error('‚ùå Error cargando threads.json:', error.message);
    }
    
    // Cargar guest_profiles.json
    try {
        if (fs.existsSync(guestFile)) {
            const data = fs.readFileSync(guestFile, 'utf-8');
            const profilesArray = JSON.parse(data);
            for (const [phoneNumber, profileData] of profilesArray) {
                guestProfiles.set(phoneNumber, profileData);
            }
        }
    } catch (error) {
        console.error('‚ùå Error cargando guest_profiles.json:', error.message);
    }
    
    return { jsonThreads, guestProfiles };
}

function calculateDaysSince(dateString: string): number {
    const date = new Date(dateString);
    const now = new Date();
    const diffTime = Math.abs(now.getTime() - date.getTime());
    return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
}

function generatePerfilStatus(client: any): string {
    const messages = client.totalMessages;
    const days = client.daysSinceLastActivity;
    const labels = client.labels;
    const name = client.displayName;
    
    // Generar perfil basado en datos disponibles
    let perfil = '';
    
    // Identificaci√≥n del cliente
    if (name !== 'Sin nombre') {
        perfil += `üë§ ${name}`;
    } else {
        perfil += 'üë§ Cliente nuevo';
    }
    
    // Estado de la conversaci√≥n
    if (messages === 0) {
        perfil += ' | üÜï Sin conversaci√≥n';
    } else if (messages === 1) {
        perfil += ' | üí¨ Primera interacci√≥n';
    } else {
        perfil += ` | üí¨ ${messages} mensajes`;
    }
    
    // Etiquetas/clasificaci√≥n
    if (labels.length > 0) {
        perfil += ` | üè∑Ô∏è ${labels.join(', ')}`;
    }
    
    // Estado temporal
    if (days === 0) {
        perfil += ' | ‚ö° Hoy';
    } else if (days === 1) {
        perfil += ' | üìÖ Ayer';
    } else if (days <= 7) {
        perfil += ` | üìÖ Hace ${days} d√≠as`;
    } else {
        perfil += ` | ‚è∞ Hace ${days} d√≠as (FR√çO)`;
    }
    
    return perfil;
}

function generateProximaAccion(client: any): string {
    const messages = client.totalMessages;
    const days = client.daysSinceLastActivity;
    const lastRole = client.lastMessageRole;
    const labels = client.labels;
    
    // L√≥gica de pr√≥xima acci√≥n basada en CRM
    if (messages === 0) {
        return 'üìû CONTACTAR - Iniciar conversaci√≥n';
    }
    
    if (lastRole === 'user' && days === 0) {
        return '‚ö° RESPONDER URGENTE - Cliente esperando';
    }
    
    if (lastRole === 'user' && days === 1) {
        return 'üî• RESPONDER HOY - Cliente escribi√≥ ayer';
    }
    
    if (lastRole === 'user' && days <= 3) {
        return 'üì± RESPONDER - Cliente esperando respuesta';
    }
    
    if (labels.includes('cotizaci√≥n') || labels.includes('Colega Jefe')) {
        if (days <= 7) {
            return 'üíº SEGUIMIENTO COMERCIAL - Cotizaci√≥n pendiente';
        } else {
            return 'üìû REACTIVAR - Seguir cotizaci√≥n';
        }
    }
    
    if (lastRole === 'assistant' && days <= 3) {
        return '‚è≥ ESPERAR RESPUESTA - Bot respondi√≥ reciente';
    }
    
    if (days <= 7) {
        return 'üëÄ MONITOREAR - Conversaci√≥n activa';
    }
    
    if (days <= 30) {
        return 'üîÑ REACTIVAR - Cliente fr√≠o, reactivar';
    }
    
    return 'üìä AN√ÅLISIS - Evaluar si continuar seguimiento';
}

function calculatePrioridad(client: any): 'ALTA' | 'MEDIA' | 'BAJA' {
    const messages = client.totalMessages;
    const days = client.daysSinceLastActivity;
    const lastRole = client.lastMessageRole;
    const labels = client.labels;
    
    // ALTA prioridad
    if (lastRole === 'user' && days <= 1) return 'ALTA';
    if (labels.includes('cotizaci√≥n') && days <= 3) return 'ALTA';
    if (labels.includes('Colega Jefe')) return 'ALTA';
    if (messages >= 3 && days <= 2) return 'ALTA';
    
    // MEDIA prioridad
    if (lastRole === 'user' && days <= 7) return 'MEDIA';
    if (messages >= 1 && days <= 7) return 'MEDIA';
    if (labels.length > 0 && days <= 14) return 'MEDIA';
    
    // BAJA prioridad
    return 'BAJA';
}

async function getCRMData(): Promise<CRMClientData[]> {
    try {
        await prisma.$connect();
        
        // Cargar datos de Prisma
        const prismaUsers = await prisma.user.findMany({
            include: {
                threads: {
                    include: {
                        messages: {
                            orderBy: { createdAt: 'desc' },
                            take: 1
                        }
                    }
                }
            },
            orderBy: { lastActivity: 'desc' }
        });
        
        // Cargar datos adicionales
        const { jsonThreads, guestProfiles } = await loadAllData();
        
        const crmData: CRMClientData[] = [];
        const processedPhones = new Set<string>();
        
        // Procesar datos de Prisma
        for (const user of prismaUsers) {
            for (const thread of user.threads) {
                const cleanPhone = user.phoneNumber.replace('@s.whatsapp.net', '');
                processedPhones.add(cleanPhone);
                
                const messageCount = await prisma.message.count({
                    where: { threadId: thread.id }
                });
                
                const lastMessage = thread.messages[0] || null;
                const jsonData = jsonThreads.get(cleanPhone);
                const guestData = guestProfiles.get(cleanPhone);
                
                // Determinar mejor nombre
                let displayName = 'Sin nombre';
                if (guestData?.name) displayName = guestData.name;
                if (jsonData?.userName && jsonData.userName !== cleanPhone + '@s.whatsapp.net') {
                    displayName = jsonData.userName;
                }
                if (user.name && user.name !== cleanPhone + '@s.whatsapp.net') {
                    displayName = user.name;
                }
                
                // Combinar labels
                const allLabels = [
                    ...(thread.labels as string[] || []),
                    ...(jsonData?.labels || []),
                    ...(guestData?.whapiLabels?.map((l: any) => l.name || l) || [])
                ];
                const uniqueLabels = [...new Set(allLabels)];
                
                const daysSinceLastActivity = calculateDaysSince(thread.lastActivity.toISOString());
                
                const clientData = {
                    phoneNumber: cleanPhone,
                    displayName,
                    chatId: thread.chatId || `${cleanPhone}@s.whatsapp.net`,
                    isContact: guestData?.isContact || false,
                    totalMessages: messageCount,
                    lastMessageRole: (lastMessage?.role as 'user' | 'assistant') || null,
                    lastActivity: thread.lastActivity.toISOString(),
                    daysSinceLastActivity,
                    labels: uniqueLabels,
                    primaryLabel: guestData?.label || uniqueLabels[0] || null,
                    openaiThreadId: thread.openaiId,
                    lastMessage: lastMessage?.content || null,
                    perfilStatus: '',
                    proximaAccion: '',
                    prioridad: 'BAJA' as 'ALTA' | 'MEDIA' | 'BAJA'
                };
                
                // Generar campos CRM
                clientData.perfilStatus = generatePerfilStatus(clientData);
                clientData.proximaAccion = generateProximaAccion(clientData);
                clientData.prioridad = calculatePrioridad(clientData);
                
                crmData.push(clientData);
            }
        }
        
        // Procesar datos que solo est√°n en JSON
        for (const [phoneNumber, jsonData] of jsonThreads.entries()) {
            if (!processedPhones.has(phoneNumber)) {
                const guestData = guestProfiles.get(phoneNumber);
                
                let displayName = 'Sin nombre';
                if (guestData?.name) displayName = guestData.name;
                if (jsonData.userName && jsonData.userName !== phoneNumber + '@s.whatsapp.net') {
                    displayName = jsonData.userName;
                }
                
                const daysSinceLastActivity = calculateDaysSince(jsonData.lastActivity);
                
                const clientData = {
                    phoneNumber,
                    displayName,
                    chatId: jsonData.chatId,
                    isContact: guestData?.isContact || false,
                    totalMessages: 0,
                    lastMessageRole: null,
                    lastActivity: jsonData.lastActivity,
                    daysSinceLastActivity,
                    labels: jsonData.labels || [],
                    primaryLabel: guestData?.label || jsonData.labels?.[0] || null,
                    openaiThreadId: jsonData.threadId,
                    lastMessage: null,
                    perfilStatus: '',
                    proximaAccion: '',
                    prioridad: 'BAJA' as 'ALTA' | 'MEDIA' | 'BAJA'
                };
                
                clientData.perfilStatus = generatePerfilStatus(clientData);
                clientData.proximaAccion = generateProximaAccion(clientData);
                clientData.prioridad = calculatePrioridad(clientData);
                
                crmData.push(clientData);
            }
        }
        
        // Ordenar por prioridad y luego por actividad reciente
        return crmData.sort((a, b) => {
            const prioridadOrder = { 'ALTA': 3, 'MEDIA': 2, 'BAJA': 1 };
            if (prioridadOrder[a.prioridad] !== prioridadOrder[b.prioridad]) {
                return prioridadOrder[b.prioridad] - prioridadOrder[a.prioridad];
            }
            return a.daysSinceLastActivity - b.daysSinceLastActivity;
        });
        
    } finally {
        await prisma.$disconnect();
    }
}

async function displayCRMView() {
    try {
        console.clear();
        console.log('üéØ CRM - GESTI√ìN DE CLIENTES Y VENTAS');
        console.log('====================================\n');
        
        const clients = await getCRMData();
        
        if (clients.length === 0) {
            console.log('‚ö†Ô∏è No hay clientes registrados.');
            return;
        }
        
        const prioridadCount = {
            ALTA: clients.filter(c => c.prioridad === 'ALTA').length,
            MEDIA: clients.filter(c => c.prioridad === 'MEDIA').length,
            BAJA: clients.filter(c => c.prioridad === 'BAJA').length
        };
        
        console.log(`üìä RESUMEN DE PRIORIDADES:`);
        console.log(`   üî• ALTA: ${prioridadCount.ALTA} clientes`);
        console.log(`   üü° MEDIA: ${prioridadCount.MEDIA} clientes`);
        console.log(`   üîµ BAJA: ${prioridadCount.BAJA} clientes`);
        console.log(`   üìà Total: ${clients.length} clientes\n`);
        
        // Tabla principal CRM
        const tableData = clients.map((client, index) => ({
            '#': (index + 1),
            'PRIORIDAD': {
                'ALTA': 'üî•',
                'MEDIA': 'üü°', 
                'BAJA': 'üîµ'
            }[client.prioridad],
            'TEL√âFONO': client.phoneNumber,
            'NOMBRE': client.displayName,
            'MENSAJES': client.totalMessages,
            '√öLTIMO_MENSAJE': client.lastMessageRole === 'user' ? 'üë§' : 
                             client.lastMessageRole === 'assistant' ? 'ü§ñ' : '‚ùå',
            'D√çAS': client.daysSinceLastActivity,
            'LABELS': client.labels.join(', ').substring(0, 20),
            'CONTACTO': client.isContact ? '‚úÖ' : '‚ùå'
        }));
        
        console.table(tableData);
        
        console.log('\nüìã PLAN DE ACCI√ìN POR CLIENTE:');
        console.log('==============================\n');
        
        clients.forEach((client, index) => {
            const prioIcon = {
                'ALTA': 'üî•',
                'MEDIA': 'üü°',
                'BAJA': 'üîµ'
            }[client.prioridad];
            
            console.log(`${index + 1}. ${prioIcon} ${client.prioridad} - üì± ${client.phoneNumber}`);
            console.log(`   üë§ ${client.displayName}`);
            console.log(`   üìä PERFIL/STATUS: ${client.perfilStatus}`);
            console.log(`   üéØ PR√ìXIMA ACCI√ìN: ${client.proximaAccion}`);
            
            if (client.lastMessage) {
                const roleIcon = client.lastMessageRole === 'user' ? 'üë§ Cliente' : 'ü§ñ Bot';
                const preview = client.lastMessage.length > 80 ? 
                    client.lastMessage.substring(0, 80) + '...' : 
                    client.lastMessage;
                console.log(`   üí≠ √öltimo mensaje (${roleIcon}): "${preview}"`);
            }
            
            console.log(`   üßµ Thread: ${client.openaiThreadId}`);
            console.log('   ' + '‚îÄ'.repeat(60));
        });
        
        console.log('\n‚úÖ Vista CRM generada exitosamente');
        console.log('üí° Ordenado por: PRIORIDAD ‚Üí ACTIVIDAD RECIENTE');
        console.log('üéØ Enf√≥cate en los clientes de prioridad ALTA primero');
        
    } catch (error) {
        console.error('‚ùå Error generando vista CRM:', error);
    }
}

// Exportar para uso en otros archivos
export { getCRMData, CRMClientData };

// Ejecutar si se llama directamente
if (require.main === module) {
    displayCRMView();
}