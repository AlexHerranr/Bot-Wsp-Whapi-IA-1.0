# ü§ñ Bot Logs Parser

> **Herramienta de an√°lisis r√°pido de logs para Google Cloud Run**

## üìã Tabla de Contenidos

1. [¬øQu√© es esto?](#qu√©-es-esto)
2. [Instalaci√≥n](#instalaci√≥n)
3. [Uso R√°pido](#uso-r√°pido)
4. [Gu√≠a Completa](#gu√≠a-completa)
5. [Ejemplos Pr√°cticos](#ejemplos-pr√°cticos)
6. [Troubleshooting](#troubleshooting)
7. [Archivos del Proyecto](#archivos-del-proyecto)

---

## ¬øQu√© es esto?

**Bot Logs Parser** es una herramienta que resuelve el problema m√°s frustrante de Google Cloud Console: **analizar logs detallados**.

### üö® El Problema
- **Logs colapsados**: Cada entrada requiere un clic para ver detalles
- **Sin contexto**: Imposible ver qu√© pas√≥ antes/despu√©s de un error
- **Copia limitada**: No puedes copiar f√°cilmente logs completos
- **Sin agrupaci√≥n**: Los logs est√°n mezclados, no agrupados por sesi√≥n

### ‚úÖ Nuestra Soluci√≥n
Replicamos la experiencia de **logs locales** donde TODO es visible inmediatamente:

```
=== NUEVA SESI√ìN DEL BOT ===
üöÄ [2025-07-10 12:09:55] INFO: üåê Servidor HTTP iniciado en 0.0.0.0:8080
üöÄ [2025-07-10 12:09:55] INFO: ü§ñ Bot completamente inicializado
üë§ [2025-07-10 12:09:57] INFO: 7/10 [12:09] üì± 573003913251: "Yo de nuevo" üí¨ ‚è± 10s...
‚ÑπÔ∏è [2025-07-10 12:10:05] INFO: üîç Buscando runs hu√©rfanos despu√©s del reinicio...
=== FIN DE SESI√ìN DEL BOT ===
```

### ‚ö° Impacto Real
- **ANTES**: 15 minutos navegando Cloud Console
- **DESPU√âS**: 10 segundos con `botlogs`

---

## üöÄ Instalaci√≥n

### Requisitos Previos
- ‚úÖ **Python 3.7+** instalado
- ‚úÖ **Google Cloud SDK** configurado
- ‚úÖ **Acceso al proyecto** `gen-lang-client-0318357688`

### Instalaci√≥n R√°pida

```bash
# 1. Instalar dependencias
pip install -r requirements.txt

# 2. Verificar configuraci√≥n
python parse_bot_logs.py --help

# 3. ¬°Listo para usar!
```

### Verificaci√≥n de Instalaci√≥n

```bash
# Verificar Python
python --version

# Verificar Google Cloud SDK
gcloud --version
gcloud config get-value project

# Deber√≠a mostrar: gen-lang-client-0318357688
```

---

## ‚ö° Uso R√°pido

### Windows
```cmd
# Usar el script batch (recomendado)
.\botlogs.bat                    # √öltimas 10 sesiones (nuevo default)

# Por n√∫mero de sesiones (RECOMENDADO)
.\botlogs.bat --sessions 5       # √öltimas 5 sesiones
.\botlogs.bat --sessions 15      # √öltimas 15 sesiones

# Por tiempo (modo cl√°sico)
.\botlogs.bat --hours 6          # √öltimas 6 horas

# Filtros espec√≠ficos
.\botlogs.bat --errors-only      # Solo errores
.\botlogs.bat --user 573003913251  # Usuario espec√≠fico
```

### Linux/Mac
```bash
# Usar el script bash
./botlogs                        # √öltimas 10 sesiones (nuevo default)

# Por n√∫mero de sesiones (RECOMENDADO)
./botlogs --sessions 5           # √öltimas 5 sesiones
./botlogs --sessions 15          # √öltimas 15 sesiones

# Por tiempo (modo cl√°sico)
./botlogs --hours 6              # √öltimas 6 horas

# Filtros espec√≠ficos
./botlogs --errors-only          # Solo errores
./botlogs --user 573003913251    # Usuario espec√≠fico
```

### Python Directo
```bash
# Uso b√°sico (√∫ltimas 10 sesiones)
python parse_bot_logs.py

# Por sesiones (RECOMENDADO)
python parse_bot_logs.py --sessions 5
python parse_bot_logs.py --sessions 15

# Por tiempo
python parse_bot_logs.py --hours 6

# Con filtros
python parse_bot_logs.py --errors-only
python parse_bot_logs.py --user 573003913251
```

---

## üìñ Gu√≠a Completa

### Comandos B√°sicos

| Comando | Descripci√≥n |
|---------|-------------|
| `botlogs` | **√öltimas 10 sesiones** (nuevo default) |
| `botlogs --sessions 5` | √öltimas 5 sesiones |
| `botlogs --sessions 15` | √öltimas 15 sesiones |
| `botlogs --hours 6` | √öltimas 6 horas (modo cl√°sico) |
| `botlogs --errors-only` | Solo sesiones con errores |
| `botlogs --user 573003913251` | Logs de usuario espec√≠fico |

### Opciones Avanzadas

```bash
# Buscar sesi√≥n espec√≠fica
python parse_bot_logs.py --session session-1234567890

# Filtrar por usuario con sesiones espec√≠ficas
python parse_bot_logs.py --user 573003913251 --sessions 5

# Configurar l√≠mite de archivos guardados
python parse_bot_logs.py --max-session-files 15

# No copiar al portapapeles ni guardar archivo
python parse_bot_logs.py --no-copy --no-save

# No guardar archivos individuales (solo consolidado)
python parse_bot_logs.py --no-individual-files

# Obtener m√°s logs (default: 5000)
python parse_bot_logs.py --limit 10000
```

### Caracter√≠sticas Principales

#### üéØ Detecci√≥n Autom√°tica de Sesiones
- **Inicio**: "Servidor HTTP iniciado", "Bot completamente inicializado"
- **Fin**: Errores cr√≠ticos, >5 minutos sin actividad

#### üåà Colores y Formato
- üöÄ **Verde**: Inicios de sesi√≥n exitosos
- ‚ö†Ô∏è **Amarillo**: Warnings y alertas
- üî¥ **Rojo**: Errores cr√≠ticos
- üë§ **Azul**: Mensajes de usuarios
- ‚ÑπÔ∏è **Gris**: Logs informativos

#### üìä An√°lisis por Sesi√≥n
- Total de mensajes procesados
- Usuarios √∫nicos que interactuaron
- Errores encontrados (con contexto)
- Duraci√≥n de la sesi√≥n

#### üïê Timestamps en Hora Colombia
Todos los timestamps se convierten autom√°ticamente de UTC a Colombia (UTC-5).

#### üÜï Funcionalidades Nuevas (v2.0)

##### üéØ B√∫squeda por Sesiones (RECOMENDADO)
- **Antes**: `--hours 6` (impreciso, puede incluir sesiones incompletas)
- **Ahora**: `--sessions 10` (exacto, siempre sesiones completas)
- **Ventaja**: Obtienes exactamente el n√∫mero de sesiones que necesitas

##### üß† Detecci√≥n Inteligente de Duplicados
- **Problema resuelto**: No crea archivos duplicados
- **C√≥mo funciona**: Detecta sesiones ya guardadas y solo procesa las nuevas
- **Resultado**: Eficiencia m√°xima, sin archivos redundantes

```bash
# Primera ejecuci√≥n: crea 10 archivos
botlogs

# Segunda ejecuci√≥n inmediata: 
# "üìã No hay sesiones nuevas para guardar (todas ya existen)"

# Horas despu√©s con nuevas sesiones:
# "üìù Detectadas 3 sesiones nuevas de 10 totales"
```

##### üìÅ Archivos Individuales por Sesi√≥n
- **Autom√°tico**: Cada sesi√≥n se guarda en `logsGoogleCloud/session_FECHA_HORA_ID.txt`
- **Organizado**: Igual que tus logs locales
- **Limpieza autom√°tica**: Solo mantiene las √∫ltimas 10 sesiones (configurable)

##### ‚öôÔ∏è Configuraci√≥n Flexible
```bash
# Cambiar n√∫mero de sesiones
botlogs --sessions 5          # Solo 5 sesiones

# Cambiar l√≠mite de archivos
botlogs --max-session-files 20  # Mantener 20 archivos

# Deshabilitar archivos individuales
botlogs --no-individual-files   # Solo archivo consolidado
```

#### üîß Extracci√≥n T√©cnica Avanzada (v2.1)

##### üéØ Problema Resuelto
Los logs de Cloud Run contienen la misma informaci√≥n t√©cnica que los logs locales, pero enterrada en diferentes formatos JSON. La versi√≥n anterior perd√≠a informaci√≥n cr√≠tica para debugging.

##### üõ†Ô∏è Informaci√≥n T√©cnica Extra√≠da
- **FUNCTION_CALLING_START**: Funciones y argumentos completos
- **FUNCTION_EXECUTING**: Nombre de funci√≥n y par√°metros
- **BEDS24_REQUEST**: Fechas y par√°metros de consulta
- **BEDS24_RESPONSE_DETAIL**: Respuesta completa (no preview)
- **OPENAI_REQUEST**: Estados detallados (adding_message, creating_run, run_started)
- **Thread IDs**: Identificadores completos (thread_xyz...)
- **Run IDs**: Identificadores completos (run_abc...)
- **Errores**: Contexto completo con stack traces

##### üîç Comandos de Debugging Avanzado
```bash
# An√°lisis de logs crudos para debugging
python parse_bot_logs.py --analyze-raw --hours 2

# Validar extracci√≥n t√©cnica
python parse_bot_logs.py --sessions 10 --validate-extraction

# An√°lisis normal con extracci√≥n t√©cnica mejorada
python parse_bot_logs.py --sessions 10
```

##### üèóÔ∏è Arquitectura de Extracci√≥n (5 Etapas)
1. **analyze_raw_logs()**: Debugging temporal de logs crudos
2. **extract_technical_logs()**: B√∫squeda en TODAS las ubicaciones JSON
3. **reconstruct_technical_event()**: Reconstrucci√≥n en formato local
4. **parse_cloud_log()**: Parser mejorado con nuevos extractores
5. **validate_extraction()**: Verificaci√≥n de extracci√≥n completa

##### üéØ Resultado Final
Los logs procesados se ven **EXACTAMENTE** como los logs locales, con toda la informaci√≥n t√©cnica pero sin la basura HTTP de Cloud Run.

---

## üéØ Ejemplos Pr√°cticos

### Caso 1: Usuario reporta "El bot no me respondi√≥"
```bash
# ANTES: 15 minutos buscando en Cloud Console
# AHORA: 5 segundos
botlogs --user 573003913251
```

### Caso 2: Error en producci√≥n
```bash
# ANTES: Navegar entre cientos de logs colapsados
# AHORA: Solo sesiones con errores
botlogs --errors-only
```

### Caso 3: An√°lisis post-mortem
```bash
# ANTES: Exportar a BigQuery, escribir queries SQL
# AHORA: √öltimas 20 sesiones completas
botlogs --sessions 20
```

### Caso 4: Debugging espec√≠fico
```bash
# √öltimas 5 sesiones con errores de un usuario
botlogs --user 573003913251 --sessions 5 --errors-only
```

### Caso 5: Monitoreo diario (NUEVO)
```bash
# Primera vez del d√≠a: obtiene todas las sesiones nuevas
botlogs

# Ejecutar cada hora: solo obtiene sesiones nuevas
# "üìù Detectadas 2 sesiones nuevas de 10 totales"
botlogs
```

---

## üîß Troubleshooting

### Error: "gcloud CLI no est√° instalado"
```bash
# Instalar Google Cloud SDK
# https://cloud.google.com/sdk/docs/install

# Verificar instalaci√≥n
gcloud --version

# Autenticar
gcloud auth login

# Configurar proyecto
gcloud config set project gen-lang-client-0318357688
```

### Error: "No se pudieron obtener logs"
```bash
# Verificar permisos
gcloud auth list

# Verificar proyecto
gcloud config get-value project

# Probar comando manual
gcloud logging read "resource.type=cloud_run_revision AND resource.labels.service_name=bot-wsp-whapi-ia" --limit=10
```

### Error: "Python no se encuentra"
```bash
# En Windows, reinstalar Python marcando "Add to PATH"
# Reiniciar terminal/PowerShell
# Usar 'py' en lugar de 'python' si es necesario
```

### Error: "pyperclip no funciona"
```bash
# En Linux, instalar dependencias adicionales
sudo apt-get install xclip  # o xsel

# En Windows/macOS, deber√≠a funcionar autom√°ticamente
```

---

## üìÅ Archivos del Proyecto

```
tools/bot-logs-parser/
‚îú‚îÄ‚îÄ parse_bot_logs.py      # üêç Script principal Python
‚îú‚îÄ‚îÄ botlogs.bat           # ü™ü Script Windows (uso f√°cil)
‚îú‚îÄ‚îÄ botlogs               # üêß Script Linux/Mac (uso f√°cil)
‚îú‚îÄ‚îÄ requirements.txt      # üì¶ Dependencias Python
‚îú‚îÄ‚îÄ README.md            # üìñ Este archivo
‚îú‚îÄ‚îÄ MANUAL_USO.md        # üìã Manual detallado de uso
‚îî‚îÄ‚îÄ SETUP_INSTRUCTIONS.md # ‚öôÔ∏è Instrucciones de instalaci√≥n
```

### Descripci√≥n de Archivos

- **`parse_bot_logs.py`**: Script principal con toda la l√≥gica
- **`botlogs.bat`**: Wrapper para Windows (uso simplificado)
- **`botlogs`**: Wrapper para Linux/Mac (uso simplificado)
- **`requirements.txt`**: Solo contiene `pyperclip==1.8.2`
- **`README.md`**: Documentaci√≥n principal (este archivo)
- **`MANUAL_USO.md`**: Manual detallado con ejemplos
- **`SETUP_INSTRUCTIONS.md`**: Gu√≠a paso a paso de instalaci√≥n

---

## üéØ Filosof√≠a del Proyecto

### Principios de Dise√±o
1. **Velocidad sobre todo**: Un comando, resultados inmediatos
2. **Contexto es clave**: Siempre mostrar qu√© pas√≥ antes y despu√©s
3. **Formato familiar**: Igual que los logs locales que ya conocemos
4. **Copia f√°cil**: Todo al portapapeles autom√°ticamente
5. **Sin fricci√≥n**: No login, no navegaci√≥n, no clicks

### M√©tricas de √âxito

| M√©trica | ANTES (Cloud Console) | DESPU√âS (Bot Logs Parser) |
|---------|----------------------|---------------------------|
| Tiempo para encontrar error | 5-15 minutos | <30 segundos |
| Contexto del error | Manual, incompleto | Autom√°tico, completo |
| Frustraci√≥n del desarrollador | 8/10 | 2/10 |
| Probabilidad de missing context | Alta | Casi nula |

---

## ü§ù Contribuir

### Agregar nuevos patrones de detecci√≥n
```python
# Editar parse_bot_logs.py, clase LogEntry
def is_session_start(self) -> bool:
    patterns = [
        r'Tu nuevo patr√≥n aqu√≠',
        # ... patrones existentes
    ]
```

### Agregar nuevos filtros
```python
# Editar funci√≥n filter_sessions() para criterios adicionales
```

---

## üìÑ Licencia

Este proyecto es parte del sistema Bot WhatsApp y est√° dise√±ado espec√≠ficamente para resolver problemas de debugging en Google Cloud Run.

---

## üÜò Soporte

**¬øPreguntas? ¬øSugerencias? ¬øEncontraste un bug?**

El objetivo es que debuggear en producci√≥n sea **TAN F√ÅCIL** como en desarrollo local. Si no es as√≠, necesitamos mejorarlo.

---

## üèÜ Conclusi√≥n

**Bot Logs Parser** transforma la experiencia de debugging de esto:

```
üò´ 15 minutos navegando en Cloud Console
üò´ Clicks infinitos expandiendo logs
üò´ Contexto perdido
üò´ Imposible copiar/compartir
```

A esto:

```
üòé botlogs
üòé Logs completos en 10 segundos
üòé Contexto autom√°tico
üòé Copia al portapapeles lista
```

¬°Debugging en producci√≥n ahora es **TAN F√ÅCIL** como en desarrollo local! üöÄ 