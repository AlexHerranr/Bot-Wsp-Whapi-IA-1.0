# Documentaci√≥n T√©cnica: Funci√≥n check-availability

## Resumen Ejecutivo

La funci√≥n `check-availability` es el n√∫cleo del sistema de consulta de disponibilidad hotelera, integrando validaciones temporales, llamadas API a Beds24, enriquecimiento de datos con PostgreSQL y formato de respuesta optimizado para OpenAI.

## Arquitectura del Sistema

```
Cliente ‚Üí OpenAI ‚Üí check_availability() ‚Üí [Beds24 API + PostgreSQL] ‚Üí Respuesta Formateada
                         ‚Üì
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ   Validaciones Previas  ‚îÇ
              ‚îÇ  - Fechas pasadas       ‚îÇ
              ‚îÇ  - Restricciones horario‚îÇ
              ‚îÇ  - N√∫mero de adultos    ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚Üì
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ    Beds24Client         ‚îÇ
              ‚îÇ  - API /offers          ‚îÇ
              ‚îÇ  - Reintentos con retry ‚îÇ
              ‚îÇ  - Filtrado disponibles ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚Üì
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ  Enriquecimiento BD     ‚îÇ
              ‚îÇ  - Nombres reales       ‚îÇ
              ‚îÇ  - Cargos adicionales   ‚îÇ
              ‚îÇ  - Lookup optimizado    ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## Flujo de Ejecuci√≥n Detallado

### 1. Validaciones de Entrada (L√≠neas 17-67)

#### 1.1 Validaci√≥n de Fechas Pasadas
```typescript
// Obtiene fecha actual de Colombia (GMT-5)
const todayColombia = new Date().toLocaleDateString('en-CA', { timeZone: 'America/Bogota' });
```
- **Prop√≥sito**: Evitar consultas API innecesarias para fechas pasadas
- **Zona Horaria**: America/Bogota (GMT-5) para consistencia local
- **Formato**: ISO 8601 (YYYY-MM-DD) para comparaciones precisas

#### 1.2 Restricci√≥n Horaria (L√≠neas 31-54)
```typescript
if (parseInt(colombiaHour) >= 19) { // 7:00 PM
    return `Ind√≠cale al hu√©sped que: Desafortunadamente...`;
}
```
- **Corte**: 7:00 PM hora de Colombia
- **Raz√≥n**: Limitaciones operacionales del sistema Beds24
- **Alternativa**: Sugiere contacto telef√≥nico directo

#### 1.3 Validaci√≥n de Capacidad
```typescript
if (numAdults < 1) return `Nota interna: N√∫mero de adultos inv√°lido`;
if (numAdults > 50) return `Nota interna: Grupo muy grande`;
```
- **Rango v√°lido**: 1-50 adultos
- **Grupos grandes**: Derivaci√≥n a coordinaci√≥n telef√≥nica

### 2. Integraci√≥n con Beds24 API (L√≠neas 69-79)

#### 2.1 Inicializaci√≥n del Cliente
```typescript
const beds24 = new Beds24Client();
const result = await beds24.searchAvailability({
    arrival: args.startDate,
    departure: args.endDate,
    numAdults: numAdults,
});
```

#### 2.2 Endpoint Utilizado
- **URL**: `/inventory/rooms/offers`
- **M√©todo**: GET
- **Par√°metros**:
  - `arrival`: Fecha de entrada (YYYY-MM-DD)
  - `departure`: Fecha de salida (YYYY-MM-DD)
  - `numAdults`: N√∫mero de adultos
  - `offerId`: 0 (valor fijo para consulta general)

### 3. Procesamiento en Beds24Client

#### 3.1 Manejo de Reintentos
```typescript
retryOptions: {
    maxRetries: 3,
    baseDelay: 1000,
    maxDelay: 5000,
    backoffFactor: 2
}
```
- **Estrategia**: Exponential backoff
- **Reintentos**: M√°ximo 3 intentos
- **Delays**: 1s ‚Üí 2s ‚Üí 4s

#### 3.2 Filtrado de Disponibles (beds24-client.ts:279-310)
```typescript
.filter((room: any) => {
    return room.offers && room.offers.length > 0;
})
.map((room: any) => {
    const offer = room.offers[0];
    const totalPrice = offer.price || 0;
    const pricePerNight = totalNights > 0 ? Math.round(totalPrice / totalNights) : 0;
```
- **Criterio**: Solo habitaciones con ofertas activas
- **C√°lculos**: Precio por noche = precio total / n√∫mero de noches

#### 3.3 Enriquecimiento con Datos Locales (beds24-client.ts:349-403)
```typescript
const apartmentDetailsMap = await this.apartmentDataService.getApartmentDetails(roomIds);
```
- **Optimizaci√≥n**: Consulta batch con Map lookup O(1)
- **Datos agregados**: 
  - Nombre real del apartamento
  - Descripci√≥n de cargos adicionales
  - Montos de cargos adicionales
- **Fallback**: Valores por defecto si falla la BD

### 4. Formato de Respuesta (beds24-client.ts:406-456)

#### 4.1 Estructura de la Respuesta
```
Tenemos X Apto(s) Disponible(s),
entrando el DD y saliendo DD de MMMM de YYYY,
para (X noche(s)) para X persona(s).

*Nombre Apartamento*
- $X.XXX/noche √ó X = $X.XXX
- Cargo adicional: $X.XXX
- Total: $X.XXX

Disponibilidad Validada a las HH:MM AM/PM
```

#### 4.2 Ordenamiento
- **Criterio**: Precio total ascendente
- **Prop√≥sito**: Mostrar opciones m√°s econ√≥micas primero

### 5. M√©tricas y Logging

#### 5.1 Performance Tracking (L√≠neas 81-102)
```typescript
const duration = Date.now() - startTime;
const apartmentCount = (result.match(/üè†/g) || []).length;
const hasFixedCharges = result.includes('$') && result.includes('Total:');

logFunctionPerformance(
    'system',
    'check_availability',
    duration,
    apiTime,  // ~70% del tiempo total
    dbTime,   // ~20% del tiempo total
    1,        // calls
    0         // errors
);
```

#### 5.2 M√©tricas Capturadas
- **Duraci√≥n total**: Tiempo de ejecuci√≥n completo
- **Tiempo API**: Estimado 70% del total
- **Tiempo BD**: Estimado 20% del total
- **Conteo apartamentos**: Extra√≠do del texto de respuesta
- **Validaci√≥n formato**: Verificaci√≥n de estructura de precios

#### 5.3 Log T√©cnico Compacto (L√≠nea 102)
```typescript
logInfo('HOTEL_AVAILABILITY', `${args.startDate}_${args.endDate}_${numAdults}adl | ${apartmentCount}apts | ${duration}ms | BD:${hasFixedCharges?'OK':'MISS'} | Ages:${hasAgeInfo?'OK':'MISS'} | ${result.length}chars`);
```

**Formato**: `fecha_inicio_fecha_fin_XadlXapts | XmsXaptsXms | BD:STATUS | Ages:STATUS | Xchars`

### 6. Manejo de Errores

#### 6.1 Errores de Red (L√≠neas 125-127)
```typescript
if (error.message && (error.message.includes('network') || 
    error.message.includes('timeout') || 
    error.message.includes('ECONNRESET'))) {
    return 'Error de conexi√≥n al verificar disponibilidad...';
}
```

#### 6.2 Logging de Errores
```typescript
logFunctionPerformance(
    'system',
    'check_availability',
    duration,
    0, // apiTime - no completado
    0, // dbTime - no completado
    1, // calls
    1  // errors
);
```

## Optimizaciones Implementadas

### 1. Consulta Batch de Apartamentos
- **Problema**: N+1 queries a PostgreSQL
- **Soluci√≥n**: Map lookup con getApartmentDetails(roomIds[])
- **Mejora**: O(N) ‚Üí O(1) per lookup

### 2. Formato de Fechas Optimizado
- **Entrada**: YYYY-MM-DD
- **Salida**: DD/MM/YYYY para legibilidad humana
- **Procesamiento**: Split + reordenamiento simple

### 3. Caching de Cliente
- **Patr√≥n**: Singleton por instancia de funci√≥n
- **Beneficio**: Reutilizaci√≥n de conexiones HTTP

## Consideraciones de Seguridad

### 1. Validaci√≥n de Entrada
- Sanitizaci√≥n de fechas con formato ISO
- L√≠mites num√©ricos en n√∫mero de adultos
- Validaci√≥n de zona horaria

### 2. Manejo de Tokens
- Tokens en variables de entorno
- Headers seguros para autenticaci√≥n
- Fallback graceful si faltan credenciales

## Dependencias Cr√≠ticas

### 1. Servicios Externos
- **Beds24 API**: /inventory/rooms/offers endpoint
- **PostgreSQL**: Tabla de apartamentos para enriquecimiento

### 2. M√≥dulos Internos
- `beds24-client.ts`: Cliente API principal
- `apartment-data.service.ts`: Servicio de datos locales
- `logging/integrations.ts`: Sistema de m√©tricas
- `retry-utils.ts`: Manejo de reintentos

## Casos de Uso Principales

### 1. Consulta Est√°ndar
- Fechas futuras v√°lidas
- 1-6 adultos
- Horario operacional (antes 7PM)

### 2. Casos L√≠mite
- Consulta para "hoy" despu√©s de 7PM
- Fechas pasadas (error de usuario)
- Grupos grandes (>50 personas)
- Sin disponibilidad para fechas solicitadas

### 3. Escenarios de Error
- API Beds24 no disponible
- Base de datos PostgreSQL no disponible
- Token de autenticaci√≥n inv√°lido
- Timeout de red

## M√©tricas de Performance Esperadas

### 1. Tiempos Objetivo
- **Total**: < 3000ms
- **API Beds24**: < 2000ms
- **PostgreSQL**: < 500ms
- **Procesamiento**: < 500ms

### 2. Disponibilidad
- **SLA**: 99.5% uptime
- **Reintentos**: M√°ximo 3 por llamada
- **Timeout**: 15 segundos por intento

## Schema de OpenAI (schema.json)

### Configuraci√≥n de Function Calling

El schema define la interfaz entre OpenAI y la funci√≥n `check_availability`, garantizando validaciones autom√°ticas y documentaci√≥n clara para el modelo.

#### Estructura del Schema

```json
{
  "name": "check_availability",
  "description": "Consulta disponibilidad y tarifas completas...",
  "strict": true,
  "parameters": {
    "type": "object",
    "properties": { ... },
    "required": [...],
    "additionalProperties": false
  }
}
```

#### An√°lisis Detallado de Par√°metros

##### 1. startDate (Fecha de Entrada)
```json
{
  "type": "string",
  "description": "Fecha de entrada (check-in) en formato YYYY-MM-DD...",
  "pattern": "^\\d{4}-\\d{2}-\\d{2}$"
}
```
- **Validaci√≥n**: Regex estricto para formato ISO 8601
- **Prop√≥sito**: Evitar errores de formato antes de llegar a la funci√≥n
- **Nota**: La validaci√≥n de fechas pasadas se hace en la funci√≥n, no en el schema

##### 2. endDate (Fecha de Salida) 
```json
{
  "type": "string",
  "description": "Fecha de salida (check-out) en formato YYYY-MM-DD...",
  "pattern": "^\\d{4}-\\d{2}-\\d{2}$"
}
```
- **Constraint L√≥gico**: Debe ser posterior a startDate (validado en funci√≥n)
- **Formato**: Mismo patr√≥n regex que startDate para consistencia

##### 3. numAdults (N√∫mero de Adultos)
```json
{
  "type": "integer",
  "description": "N√∫mero total de hu√©spedes adultos...",
  "minimum": 1,
  "maximum": 50
}
```
- **Rango v√°lido**: 1-50 adultos
- **Regla de negocio**: Ni√±os >5 a√±os cuentan como adultos
- **Validaci√≥n autom√°tica**: OpenAI rechaza valores fuera del rango

#### Configuraciones Importantes

##### 1. Strict Mode
```json
"strict": true
```
- **Beneficio**: Validaci√≥n estricta de tipos y formatos
- **Comportamiento**: OpenAI rechaza llamadas que no cumplan exactamente el schema
- **Seguridad**: Previene inyecci√≥n de par√°metros no esperados

##### 2. Required Fields
```json
"required": ["startDate", "endDate", "numAdults"]
```
- **Todos obligatorios**: La funci√≥n no puede ejecutarse sin estos 3 par√°metros
- **UX**: Fuerza al modelo a solicitar informaci√≥n faltante al usuario

##### 3. Additional Properties
```json
"additionalProperties": false
```
- **Restricci√≥n**: No permite par√°metros extra no definidos en el schema
- **Seguridad**: Previene pasar datos inesperados a la funci√≥n

#### Descripci√≥n para el Modelo

La descripci√≥n del schema act√∫a como documentaci√≥n interna para OpenAI:

```
"Consulta disponibilidad y tarifas completas (incluye precios por noche, extras, totales). 
Usar SIEMPRE que tengas fechas espec√≠ficas y n√∫mero de personas confirmados por el cliente."
```

**Elementos clave:**
- **"SIEMPRE que tengas fechas espec√≠ficas"**: Previene llamadas prematuras
- **"confirmados por el cliente"**: Asegura que los datos sean v√°lidos
- **"tarifas completas"**: Comunica qu√© tipo de informaci√≥n se obtendr√°

#### Flujo de Validaci√≥n Completo

```
Usuario ‚Üí OpenAI ‚Üí Schema Validation ‚Üí Function Execution ‚Üí Response
          ‚Üì
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ Schema.json     ‚îÇ
    ‚îÇ - Tipos         ‚îÇ
    ‚îÇ - Formatos      ‚îÇ
    ‚îÇ - Rangos        ‚îÇ
    ‚îÇ - Required      ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚Üì (Si pasa)
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ check-availability.ts ‚îÇ
    ‚îÇ - Fechas pasadas‚îÇ
    ‚îÇ - Horario 7PM   ‚îÇ
    ‚îÇ - L√≥gica negocio‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### Casos de Uso del Schema

##### 1. Prevenci√≥n de Errores Comunes
- **Formato incorrecto**: "2024/12/25" ‚Üí Rechazado por pattern
- **Tipo incorrecto**: "cinco adultos" ‚Üí Rechazado por type: integer
- **Fuera de rango**: 100 adultos ‚Üí Rechazado por maximum: 50

##### 2. Optimizaci√≥n de Performance
- **Pre-validaci√≥n**: Errores detectados antes de ejecutar funci√≥n
- **Menor latencia**: No hay llamadas API innecesarias
- **Menos logging**: Reduce ruido en logs de errores

##### 3. Mejora de UX
- **Mensajes claros**: OpenAI puede explicar qu√© par√°metro falta
- **Gu√≠a al usuario**: Descripciones ayudan al modelo a solicitar info correcta
- **Consistencia**: Formato uniforme de fechas y n√∫meros

#### Mantenimiento del Schema

##### Sincronizaci√≥n con Funci√≥n
- **Rangos num√©ricos**: maximum: 50 debe coincidir con validaci√≥n en funci√≥n
- **Patrones**: Regex debe ser compatible con parsing en TypeScript
- **Descripciones**: Mantener actualizadas con cambios de l√≥gica de negocio

##### Versionado
- **Cambios breaking**: Modificar pattern o required fields requiere testing
- **Cambios seguros**: Actualizar description o agregar validaciones opcionales
- **Rollback**: Schema debe ser compatible con versiones anteriores de la funci√≥n

---

*Documentaci√≥n generada para la versi√≥n actual del sistema check-availability*
*√öltima actualizaci√≥n: An√°lisis completo incluyendo schema.json de OpenAI Function Calling*